{% extends "scoreai/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="fw-semibold mb-0">月次PL</h4>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if available_years %}
        <form method="get" id="year-range-form" class="d-flex gap-2 align-items-center">
          <input type="hidden" name="years" value="{{ request.GET.years|default:3 }}">
          <select name="start_year" id="start-year-select" class="form-select form-select-sm" style="width: 150px;" onchange="updateYearRange()">
            <option value="">開始年度</option>
            {% for year in available_years %}
            <option value="{{ year }}" {% if start_year == year %}selected{% endif %}>{{ year }}年</option>
            {% endfor %}
          </select>
          <span class="text-muted">～</span>
          <select name="end_year" id="end-year-select" class="form-select form-select-sm" style="width: 150px;" onchange="updateYearRange()">
            <option value="">終了年度</option>
            {% for year in available_years %}
            <option value="{{ year }}" {% if end_year == year %}selected{% endif %}>{{ year }}年</option>
            {% endfor %}
          </select>
        </form>
        {% endif %}
        <div class="d-flex gap-2 flex-wrap">
          <a href="{% url 'fiscal_summary_month_list' %}?years=3" class="btn {% if request.GET.years == '3' or not request.GET.years %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">月次PL一覧（3期比較）</a>
          <a href="{% url 'latest_monthly_pl' %}" class="btn btn-outline-primary btn-sm">単年度月次PL</a>
          <a href="{% url 'budget_vs_actual_monthly' %}" class="btn btn-outline-primary btn-sm">予算vs実績推移表</a>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">{% if request.GET.years == '1' %}月次PL一覧（直近年度）{% else %}月次PL一覧（3期比較）{% endif %}</h5>
      </div>
      <div class="card-body">
        {% if monthly_summaries_with_summary.monthly_data %}
        {% for summary in monthly_summaries_with_summary.monthly_data %}
        <div class="table-responsive">
          <h5 class="mb-3 fw-semibold">{{ summary.year }}年度</h5>
          <table class="table table-hover" id="fiscal-summary-table-{{ forloop.counter }}">
            <thead class="table-light">
              <tr>
                <th></th>
                {% for amount in summary.data %}
                <th class="text-center">
                  {% if amount.display_month %}
                    {{ amount.display_month }}月
                  {% else %}
                    {% with month_index=forloop.counter0 %}
                      {% with month_label=months_label|get_list_item:month_index %}
                        {% if month_label %}{{ month_label }}月{% else %}{{ amount.period }}月{% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% endif %}
                  {% if amount.is_budget %}
                  <i class="ti ti-alert-circle text-warning ms-1" title="予算データ" style="font-size: 0.9em;"></i>
                  {% endif %}
                </th>
                {% endfor %}
                <th>Total</th>
              </tr>
            </thead>
            <tbody class="table-group-divider">
              <tr>
                <td style="writing-mode: vertical-rl; text-orientation: center;">売上高</td>
                {% for amount in summary.data %}
                <td class="text-end equal-width">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.sales|floatformat:0|intcomma }}{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_sales|floatformat:0|intcomma }}</td>
              </tr>
              <tr>
                <td rowspan="2" style="writing-mode: vertical-rl; text-orientation: center;">粗利益</td>
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.gross_profit|floatformat:0|intcomma }}{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_gross_profit|floatformat:0|intcomma }}</td>
              </tr>
              <tr class="bg-light">
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.gross_profit_rate|floatformat:1 }}%{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_gross_profit_rate|floatformat:1 }}%</td>
              </tr>
              <tr>
                <td rowspan="2" style="writing-mode: vertical-rl; text-orientation: center;">営業利益</td>
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.operating_profit|floatformat:0|intcomma }}{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_operating_profit|floatformat:0|intcomma }}</td>
              </tr>
              <tr class="bg-light">
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.operating_profit_rate|floatformat:1 }}%{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_operating_profit_rate|floatformat:1 }}%</td>
              </tr>
              <tr>
                <td rowspan="2" style="writing-mode: vertical-rl; text-orientation: center;">経常利益</td>
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.ordinary_profit|floatformat:0|intcomma }}{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_ordinary_profit|floatformat:0|intcomma }}</td>
              </tr>
              <tr class="bg-light">
                {% for amount in summary.data %}
                <td class="text-end">{% if amount.id|stringformat:"s"|slice:":5" == "temp_" %}-{% else %}{{ amount.ordinary_profit_rate|floatformat:1 }}%{% endif %}</td>
                {% endfor %}
                <td class="text-end">{{ summary.total_ordinary_profit_rate|floatformat:1 }}%</td>
              </tr>
            </tbody>
            <tfoot class="table-group-divider">
              <tr>
                <td>操作</td>
                {% for record in summary.data %}
                <td class="text-end"><a href="{% url 'fiscal_summary_month_update' record.id %}"><i class="fa-solid fa-pen-to-square"></i></a></td>
                {% endfor %}
              </tr>
            </tfoot>
          </table>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-warning" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>選択された年度のデータが見つかりませんでした。
        </div>
        {% endif %}
      </div>
      <div class="card-footer text-end">
        <a href="{% url 'fiscal_summary_month_create' %}" class="btn btn-primary">月次データ新規登録</a>
        <a href="{% url 'import_fiscal_summary_month' %}" class="btn btn-secondary">一括CSVインポート</a>
      </div>
    </div>
  </div>
</div>

<style>
.equal-width {
    width: 100px; /* Set your desired width */
}
</style>

{% if chart_data_json %}
<div class="row mt-4">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0">月次推移PLチャート（複数年度比較）</h5>
      </div>
      <div class="card-body">
        <canvas id="combinedChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chartData = {{ chart_data_json|safe }};
    
    if (!chartData || !chartData.years || chartData.years.length === 0) return;
    
    // 色の配列を定義
    const colors = [
      { border: 'rgba(75, 192, 192, 1)', background: 'rgba(75, 192, 192, 0.3)' },
      { border: 'rgba(255, 99, 132, 1)', background: 'rgba(255, 99, 132, 0.3)' },
      { border: 'rgba(54, 162, 235, 1)', background: 'rgba(54, 162, 235, 0.3)' },
      { border: 'rgba(255, 206, 86, 1)', background: 'rgba(255, 206, 86, 0.3)' },
      { border: 'rgba(153, 102, 255, 1)', background: 'rgba(153, 102, 255, 0.3)' },
    ];
    
    const ctx = document.getElementById('combinedChart');
    if (!ctx) return;
    
    // データセットを準備
    const datasets = [];
    
    // 売上高を棒グラフで追加（各年度）
    chartData.years.forEach((year, index) => {
      datasets.push({
        label: `${year}年 売上高`,
        data: chartData.sales[year.toString()],
        type: 'bar',
        backgroundColor: colors[index % colors.length].background,
        borderColor: colors[index % colors.length].border,
        borderWidth: 1,
        yAxisID: 'y',
      });
    });
    
    // 営業利益を折れ線グラフで追加（各年度）
    chartData.years.forEach((year, index) => {
      datasets.push({
        label: `${year}年 営業利益`,
        data: chartData.operating_profit[year.toString()],
        type: 'line',
        borderColor: colors[index % colors.length].border,
        backgroundColor: 'transparent',
        borderWidth: 2,
        tension: 0,
        fill: false,
        yAxisID: 'y1',
      });
    });
    
    // データ範囲を計算してゼロの位置を揃える
    const allSalesData = [];
    const allOperatingProfitData = [];
    chartData.years.forEach(year => {
      allSalesData.push(...chartData.sales[year.toString()].filter(v => v !== null && v !== undefined));
      allOperatingProfitData.push(...chartData.operating_profit[year.toString()].filter(v => v !== null && v !== undefined));
    });
    
    const salesMin = Math.min(...allSalesData);
    const salesMax = Math.max(...allSalesData);
    const profitMin = Math.min(...allOperatingProfitData);
    const profitMax = Math.max(...allOperatingProfitData);
    
    // ゼロを含むように範囲を拡張
    const salesMinWithZero = Math.min(salesMin, 0);
    const salesMaxWithZero = Math.max(salesMax, 0);
    const profitMinWithZero = Math.min(profitMin, 0);
    const profitMaxWithZero = Math.max(profitMax, 0);
    
    // ゼロからの距離を計算
    const salesRangeAboveZero = salesMaxWithZero - 0;
    const salesRangeBelowZero = 0 - salesMinWithZero;
    const profitRangeAboveZero = profitMaxWithZero - 0;
    const profitRangeBelowZero = 0 - profitMinWithZero;
    
    // ゼロの位置を揃えるために、より大きい範囲に合わせる
    const maxRangeAboveZero = Math.max(salesRangeAboveZero, profitRangeAboveZero);
    const maxRangeBelowZero = Math.max(salesRangeBelowZero, profitRangeBelowZero);
    
    // 余白を追加（10%）
    const paddingAbove = maxRangeAboveZero * 0.1;
    const paddingBelow = maxRangeBelowZero * 0.1;
    
    // 両方の軸で同じゼロ位置になるように範囲を設定
    const salesMinValue = -(maxRangeBelowZero + paddingBelow);
    const salesMaxValue = maxRangeAboveZero + paddingAbove;
    const profitMinValue = -(maxRangeBelowZero + paddingBelow);
    const profitMaxValue = maxRangeAboveZero + paddingAbove;
    
    new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.dataset.label || '';
                const value = context.parsed.y;
                if (label.includes('売上高')) {
                  return label + ': ' + value.toLocaleString() + '千円';
                } else if (label.includes('営業利益')) {
                  return label + ': ' + value.toLocaleString() + '千円';
                }
                return label + ': ' + value;
              }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            beginAtZero: false,
            min: salesMinValue,
            max: salesMaxValue,
            title: {
              display: true,
              text: '売上高（千円）'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + '千円';
              }
            }
          },
          y1: {
            type: 'linear',
            position: 'right',
            beginAtZero: false,
            min: profitMinValue,
            max: profitMaxValue,
            title: {
              display: true,
              text: '営業利益（千円）'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + '千円';
              }
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        }
      }
    });
  });
  
  function updateYearRange() {
    const startYear = parseInt(document.getElementById('start-year-select').value);
    const endYear = parseInt(document.getElementById('end-year-select').value);
    
    // 範囲の検証（最大5年間）
    if (Math.abs(endYear - startYear) > 4) {
      alert('選択できる範囲は最大5年間です。');
      // 範囲を5年に制限
      if (startYear > endYear) {
        document.getElementById('start-year-select').value = endYear;
        document.getElementById('end-year-select').value = startYear;
      } else if (endYear - startYear > 4) {
        document.getElementById('end-year-select').value = startYear + 4;
      } else {
        document.getElementById('start-year-select').value = endYear - 4;
      }
      return;
    }
    
    // フォームを送信
    const form = document.getElementById('year-range-form');
    if (form) {
      form.submit();
    }
  }
</script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cells = document.querySelectorAll('#fiscal-summary-table td');
    cells.forEach(cell => {
      if (cell.textContent.trim() === '0' || cell.textContent.trim() === '0.0%') {
        cell.textContent = '';  // ゼロの場合は何も表示しない
      }
    });
  });
</script>
{% endblock %}
