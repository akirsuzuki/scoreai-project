{% extends "scoreai/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'scoreai/js/chart_colors.js' %}"></script>

<!-- reCAPTCHA v3 -->
{% if RECAPTCHA_SITE_KEY %}
<script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_SITE_KEY }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            grecaptcha.ready(function() {
                grecaptcha.execute('{{ RECAPTCHA_SITE_KEY }}', {action: 'submit'}).then(function(token) {
                    // トークンをhiddenフィールドに設定
                    const tokenField = document.getElementById('id_g_recaptcha_response');
                    if (tokenField) {
                        tokenField.value = token;
                    } else {
                        // フィールドが存在しない場合は作成
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'g-recaptcha-response';
                        hiddenInput.id = 'id_g_recaptcha_response';
                        hiddenInput.value = token;
                        form.appendChild(hiddenInput);
                    }
                    // フォームを送信
                    form.submit();
                });
            });
        });
    }
});
</script>
{% endif %}

{% endblock %}

{% block content %}

<div class="row">
    <div class="col-lg-12 d-flex align-items-stretch">
        <div class="card w-100">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ title }}</h5>
                </div>
                <div class="card-body">
                    {{ form|crispy }}
                </div>
                <div class="card-footer text-end">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" onclick="history.back()" class="btn btn-outline-secondary">キャンセル</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}