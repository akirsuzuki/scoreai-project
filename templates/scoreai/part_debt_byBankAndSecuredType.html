<div class="card d-flex flex-column h-100">
  <div class="card-header">
    <h5 class="card-title fw-semibold"> 金融機関別保証別残高 </h5>
  </div>
  <div class="card-body py-3">
    <div class="d-flex justify-content-center pencil-chart-wrapper-min">
      <canvas id="chart_byBankAndSecuredType" class="w-100"></canvas>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const canvas = document.getElementById('chart_byBankAndSecuredType');
    const ctx = canvas.getContext('2d');

    const labels = [
      {% for debt in debt_list_byBankAndSecuredType %}
        '{{ debt.financial_institution }} - {{ debt.secured_type }}'{% if not forloop.last %}, {% endif %}
      {% endfor %}
    ];

    // 項目数に応じてキャンバスの高さを設定（1項目あたり50px、最小200px）
    const minHeight = 200;
    const itemHeight = 50;
    const chartHeight = Math.max(minHeight, labels.length * itemHeight);
    canvas.height = chartHeight;

    const data = {
      labels: labels,
      datasets: [{
        data: [
          {% for debt in debt_list_byBankAndSecuredType %}
            {{ debt.balances_monthly.0 }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        ],
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(54, 162, 235)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)',
          'rgb(201, 203, 207)'
        ],
        hoverOffset: 8
      }]
    };

    const config = {
      type: 'bar',
      data: data,
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: {
            top: 20,
            bottom: 20,
            left: 10,
            right: 10
          }
        },
        scales: {
          x: {
            ticks: {
              callback: function(value) {
                return (value / 1000000).toFixed(1) + '百万円';
              },
              padding: 10
            }
          },
          y: {
            ticks: {
              autoSkip: false,
              font: {
                size: 12
              },
              padding: 15
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '残高: ' + (context.parsed.x / 1000000).toFixed(2) + '百万円';
              }
            }
          },
        },
      },
    };

    new Chart(ctx, config);
  });
</script>