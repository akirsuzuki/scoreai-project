{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="fw-semibold mb-0">{{ title }}</h4>
      <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2">
          <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
            {% for y in available_years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}年</option>
            {% endfor %}
          </select>
        </form>
        <a href="{% url 'fiscal_summary_month_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="ti ti-arrow-left me-1"></i>戻る
        </a>
      </div>
    </div>
  </div>
</div>

{% if monthly_comparison %}
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">月次予算vs実績推移表（{{ year }}年）</h5>
      </div>
      <div class="card-body">
        {% if monthly_comparison %}
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th class="text-center">月度</th>
                <th class="text-end">予算</th>
                <th class="text-end">実績</th>
                <th class="text-end">差（金額）</th>
                <th class="text-end">達成率</th>
                <th class="text-end">予算</th>
                <th class="text-end">実績</th>
                <th class="text-end">差（金額）</th>
                <th class="text-end">達成率</th>
              </tr>
              <tr>
                <th class="text-center" colspan="5">売上高</th>
                <th class="text-center" colspan="4">営業利益</th>
              </tr>
            </thead>
            <tbody>
              {% for month in monthly_comparison %}
              <tr>
                <td class="text-center fw-semibold">{{ month.display_month }}月</td>
                <!-- 売上高 -->
                <td class="text-end">{{ month.budget_sales|floatformat:0|intcomma }}</td>
                <td class="text-end">
                  {% if month.has_actual and month.actual_sales is not None %}
                    {{ month.actual_sales|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if month.has_actual and month.sales_diff is not None %}{% if month.sales_diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if month.has_actual and month.sales_diff is not None %}
                    {{ month.sales_diff|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if month.has_actual and month.sales_achievement_rate is not None %}{% if month.sales_achievement_rate >= 100 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if month.has_actual and month.sales_achievement_rate is not None %}
                    {{ month.sales_achievement_rate|floatformat:1 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
                <!-- 営業利益 -->
                <td class="text-end">{{ month.budget_operating_profit|floatformat:0|intcomma }}</td>
                <td class="text-end">
                  {% if month.has_actual and month.actual_operating_profit is not None %}
                    {{ month.actual_operating_profit|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if month.has_actual and month.operating_profit_diff is not None %}{% if month.operating_profit_diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if month.has_actual and month.operating_profit_diff is not None %}
                    {{ month.operating_profit_diff|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if month.has_actual and month.operating_profit_achievement_rate is not None %}{% if month.operating_profit_achievement_rate >= 100 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if month.has_actual and month.operating_profit_achievement_rate is not None %}
                    {{ month.operating_profit_achievement_rate|floatformat:1 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              <!-- 合計行 -->
              <tr class="table-info fw-semibold">
                <td class="text-center">合計</td>
                <td class="text-end">{{ total_budget_sales|floatformat:0|intcomma }}</td>
                <td class="text-end">
                  {% if total_actual_sales > 0 %}
                    {{ total_actual_sales|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if total_actual_sales > 0 %}{% if total_actual_sales >= total_budget_sales %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if total_actual_sales > 0 %}
                    {{ total_actual_sales|subtract:total_budget_sales|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if total_actual_sales > 0 %}{% if total_actual_sales >= total_budget_sales %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if total_actual_sales > 0 and total_budget_sales > 0 %}
                    {{ total_actual_sales|divide:total_budget_sales|multiply:100|floatformat:1 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end">{{ total_budget_operating_profit|floatformat:0|intcomma }}</td>
                <td class="text-end">
                  {% if total_actual_operating_profit != 0 %}
                    {{ total_actual_operating_profit|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if total_actual_operating_profit != 0 %}{% if total_actual_operating_profit >= total_budget_operating_profit %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if total_actual_operating_profit != 0 %}
                    {{ total_actual_operating_profit|subtract:total_budget_operating_profit|floatformat:0|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if total_actual_operating_profit != 0 %}{% if total_actual_operating_profit >= total_budget_operating_profit %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if total_actual_operating_profit != 0 and total_budget_operating_profit != 0 %}
                    {{ total_actual_operating_profit|divide:total_budget_operating_profit|multiply:100|floatformat:1 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          月次データが見つかりません。先に月次予算と月次実績データを登録してください。
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- グラフ -->
{% if monthly_comparison %}
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">売上高推移グラフ</h5>
      </div>
      <div class="card-body">
        <canvas id="salesChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">営業利益推移グラフ</h5>
      </div>
      <div class="card-body">
        <canvas id="operatingProfitChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
// グラフデータを取得
const chartData = {{ chart_data_json|safe }};

// 売上高グラフ
const salesCtx = document.getElementById('salesChart').getContext('2d');
new Chart(salesCtx, {
  type: 'line',
  data: {
    labels: chartData.labels,
    datasets: [
      {
        label: '予算',
        data: chartData.budget_sales,
        borderColor: 'rgb(93, 135, 255)',
        backgroundColor: 'rgba(93, 135, 255, 0.1)',
        tension: 0.4,
        fill: true,
      },
      {
        label: '実績',
        data: chartData.actual_sales,
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.4,
        fill: true,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '千円';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        ticks: {
          callback: function(value) {
            return value.toLocaleString() + '千円';
          }
        }
      }
    }
  }
});

// 営業利益グラフ
const operatingProfitCtx = document.getElementById('operatingProfitChart').getContext('2d');
new Chart(operatingProfitCtx, {
  type: 'line',
  data: {
    labels: chartData.labels,
    datasets: [
      {
        label: '予算',
        data: chartData.budget_operating_profit,
        borderColor: 'rgb(93, 135, 255)',
        backgroundColor: 'rgba(93, 135, 255, 0.1)',
        tension: 0.4,
        fill: true,
      },
      {
        label: '実績',
        data: chartData.actual_operating_profit,
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.4,
        fill: true,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '千円';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        ticks: {
          callback: function(value) {
            return value.toLocaleString() + '千円';
          }
        }
      }
    }
  }
});
</script>
{% endif %}

{% else %}
<div class="row">
  <div class="col-lg-12">
    <div class="alert alert-warning">
      <i class="ti ti-alert-triangle me-2"></i>{{ year }}年の月次データが見つかりません。先に月次予算と月次実績データを登録してください。
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

