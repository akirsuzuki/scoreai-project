{% load humanize %}
{% load custom_filters %}

<!-- 現在アクティブな借入 -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-semibold mb-0">現在アクティブな借入</h5>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleSubtotals" checked>
          <label class="form-check-label" for="toggleSubtotals">
            <small>小計表示</small>
          </label>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="active_debt_list" class="table table-striped table-hover table-bordered w-100">
            <thead class="table-light">
              <tr>
                <th>金融機関</th>
                <th>区分</th>
                <th>ステータス</th>
                <th class="text-end">元本(千円)</th>
                <th>保証</th>
                <th class="text-end">利息</th>
                <th>実行日</th>
                <th>返済開始日</th>
                <th class="text-end">月返済額</th>
                <th class="text-end">残高シェア</th>
                <th class="text-end">残り月数</th>
                <th class="text-end">支払回数</th>
                <th class="text-end">今月末残高</th>
                <th class="text-end">今月概算利息</th>
                <th class="text-end">決算時残高</th>
                <th>代表者保証</th>
                <th>担保</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list %}
              <tr data-href="{% url 'debt_detail' debt.id %}" style="cursor: pointer;">
                <td>{{ debt.financial_institution.short_name }}</td>
                <td>
                  {% if debt.debt_type == 'corporate_bond' %}
                    <span class="badge bg-warning text-dark">社債</span>
                  {% elif debt.debt_type == 'promissory_note' %}
                    <span class="badge bg-success">手形貸付</span>
                  {% else %}
                    <span class="badge bg-primary">証書貸付</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.start_date <= today %}
                    <span class="badge bg-success">返済中</span>
                  {% else %}
                    <span class="badge bg-danger">返済前</span>
                  {% endif %}
                </td>
                <td class="text-end">{{ debt.principal|to_thousands|intcomma}}</td>
                <td>{{ debt.secured_type }}</td>
                <td class="text-end">{{ debt.interest_rate|truncate2 }}%</td>
                <td>{{ debt.issue_date|date:"y年n月" }}</td>
                <td>{{ debt.start_date|date:"y年n月" }}</td>
                <td class="text-end">{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td class="text-end">{{ debt.balances_monthly.0|percentage:debt_list_totals.total_balances_monthly.0 }}</td>
                <td class="text-end">{{ debt.remaining_months }}</td>
                <td class="text-end">{{ debt.payment_terms }}</td>
                <td class="text-end">{{ debt.balances_monthly.0|to_thousands|intcomma }}</td>
                <td class="text-end">{{ debt.interest_amount_monthly.0|to_thousands|intcomma }}</td>
                <td class="text-end">{{ debt.balance_fy1|to_thousands|intcomma }}</td>
                <td>
                  {% if debt.is_securedby_management %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-light text-muted">なし</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.is_collateraled %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-light text-muted">なし</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="table-light">
              <tr>
                <th colspan="3" class="text-end">合計：</th>
                <th class="text-end"></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th class="text-end"></th>
                <th class="text-end"></th>
                <th></th>
                <th></th>
                <th class="text-end"></th>
                <th class="text-end"></th>
                <th class="text-end"></th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <a href="{% url 'debt_create' %}" class="btn btn-primary">新規借入登録</a>
      </div>
    </div>
  </div>
</div>

<!-- 返済中残高12ヶ月推移グラフ -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title fw-semibold mb-0">返済中残高12ヶ月推移</h5>
      </div>
      <div class="card-body">
        <canvas id="chart_debtAll"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = new DataTable('#active_debt_list', {
      responsive: false,
      scrollX: true,
      autoWidth: false,
      pageLength: 25,
      pagingType: 'full_numbers',
      order: [[0, 'asc']], // 金融機関でソート
      language: {
        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
      },
      drawCallback: function (settings) {
        // サブトータル表示が有効な場合のみ処理
        if (!$('#toggleSubtotals').is(':checked')) {
          $('.subtotal-row').remove();
          return;
        }
        
        // 既存のサブトータル行を削除
        $('.subtotal-row').remove();
        
        // 全体の残高合計を取得（残高シェア計算用）
        let api = this.api();
        let totalBalance = 0;
        api.rows({ page: 'all' }).every(function () {
          if (!$(this.node()).hasClass('subtotal-row')) {
            let data = this.data();
            totalBalance += parseFloat(String(data[12] || '0').replace(/[,]/g, '')) || 0;
          }
          return true;
        });
        
        // 金融機関ごとのサブトータルを計算して表示
        let rows = api.rows({ page: 'current' }).nodes();
        let lastBank = null;
        let groupData = [];
        let groupStartIndex = 0;
        let rowIndex = 0;
        
        api.rows({ page: 'current' }).every(function (rowIdx) {
          let data = this.data();
          let bank = data[0]; // 金融機関名
          
          // サブトータル行はスキップ
          if ($(this.node()).hasClass('subtotal-row')) {
            return true;
          }
          
          if (lastBank !== null && bank !== lastBank) {
            // 前のグループのサブトータルを追加
            addSubtotalRow(api, rows, groupStartIndex, rowIndex - 1, lastBank, groupData, totalBalance);
            groupData = [];
            groupStartIndex = rowIndex;
          }
          
          // データをグループに追加
          groupData.push({
            principal: parseFloat(String(data[3] || '0').replace(/[,]/g, '')) || 0,
            monthlyRepayment: parseFloat(String(data[8] || '0').replace(/[,]/g, '')) || 0,
            balance: parseFloat(String(data[12] || '0').replace(/[,]/g, '')) || 0,
            interest: parseFloat(String(data[13] || '0').replace(/[,]/g, '')) || 0,
            balanceFy1: parseFloat(String(data[14] || '0').replace(/[,]/g, '')) || 0
          });
          
          lastBank = bank;
          rowIndex++;
          return true;
        });
        
        // 最後のグループのサブトータルを追加
        if (lastBank !== null && groupData.length > 0) {
          addSubtotalRow(api, rows, groupStartIndex, rowIndex - 1, lastBank, groupData, totalBalance);
        }
      },
      footerCallback: function (row, data, start, end, display) {
        let api = this.api();
        let intVal = function (i) {
          return typeof i === 'string'
            ? i.replace(/[\$,]/g, '') * 1
            : typeof i === 'number'
              ? i
              : 0;
        };
        
        // 元本の合計
        let principalTotal = api
          .column(3)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 月返済額の合計
        let monthlyRepaymentTotal = api
          .column(8)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 今月末残高の合計
        let balanceTotal = api
          .column(12)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 決算時残高の合計
        let balanceFy1Total = api
          .column(14)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // フッターに表示
        $(api.column(3).footer()).html(principalTotal.toLocaleString('ja-JP'));
        $(api.column(8).footer()).html(monthlyRepaymentTotal.toLocaleString('ja-JP'));
        $(api.column(12).footer()).html(balanceTotal.toLocaleString('ja-JP'));
        $(api.column(14).footer()).html(balanceFy1Total.toLocaleString('ja-JP'));
      }
    });
    
    // サブトータル行を追加する関数
    function addSubtotalRow(api, rows, startIdx, endIdx, bankName, groupData, totalBalance) {
      // サブトータルを計算
      let subtotal = {
        principal: groupData.reduce((sum, d) => sum + d.principal, 0),
        monthlyRepayment: groupData.reduce((sum, d) => sum + d.monthlyRepayment, 0),
        balance: groupData.reduce((sum, d) => sum + d.balance, 0),
        interest: groupData.reduce((sum, d) => sum + d.interest, 0),
        balanceFy1: groupData.reduce((sum, d) => sum + d.balanceFy1, 0)
      };
      
      // 残高シェアを計算（パーセンテージ）
      let balanceShare = totalBalance > 0 ? (subtotal.balance / totalBalance * 100) : 0;
      
      // サブトータル行を作成（クリック不可）
      let subtotalRow = $('<tr class="subtotal-row">')
        .append($('<td colspan="3" class="text-end">').html('<strong>' + bankName + ' 小計</strong>'))
        .append($('<td class="text-end">').html(subtotal.principal.toLocaleString('ja-JP')))
        .append($('<td colspan="4">'))
        .append($('<td class="text-end">').html(subtotal.monthlyRepayment.toLocaleString('ja-JP')))
        .append($('<td class="text-end">').html(balanceShare.toFixed(2) + '%'))
        .append($('<td colspan="2">'))
        .append($('<td class="text-end">').html(subtotal.balance.toLocaleString('ja-JP')))
        .append($('<td class="text-end">').html(subtotal.interest.toLocaleString('ja-JP')))
        .append($('<td class="text-end">').html(subtotal.balanceFy1.toLocaleString('ja-JP')))
        .append($('<td colspan="2">'));
      
      // グループの最後の行の後に挿入
      if (endIdx >= 0 && endIdx < rows.length) {
        $(rows[endIdx]).after(subtotalRow);
      } else if (rows.length > 0) {
        // 最後の行の後に追加
        $(rows[rows.length - 1]).after(subtotalRow);
      }
    }

    // 行クリックで詳細ページに遷移（サブトータル行は除外）
    table.on('draw', function () {
      const rows = document.querySelectorAll('#active_debt_list tbody tr:not(.subtotal-row)');
      rows.forEach(row => {
        // 既存のイベントリスナーを削除してから追加
        $(row).off('click').on('click', function () {
          const href = this.getAttribute('data-href');
          if (href) {
            window.location.href = href;
          }
        });
      });
    });
    
    // サブトータル表示/非表示のトグル
    $('#toggleSubtotals').on('change', function() {
      table.draw(false);
    });
  });
</script>
