{% extends "scoreai/base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
.summary-card {
    border-left: 4px solid #667eea;
}

.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 30px;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <h4 class="fw-semibold mb-0">{{ title }}</h4>
            <div>
                <a href="{% url 'izakaya_plan_update' pk=plan.id %}" class="btn btn-outline-primary">
                    <i class="ti ti-edit me-1"></i>編集
                </a>
                <a href="{% url 'izakaya_plan_delete' pk=plan.id %}" class="btn btn-outline-danger">
                    <i class="ti ti-trash me-1"></i>削除
                </a>
                <a href="{% url 'izakaya_plan_list' %}" class="btn btn-outline-secondary">
                    <i class="ti ti-list me-1"></i>計画一覧
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 結果サマリー -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">初期投資回収期間</h6>
                <h3 class="mb-0">
                    {% if plan.payback_period_years == 999 %}
                    <span class="text-danger">回収不可能</span>
                    {% else %}
                    {{ plan.payback_period_years }}年{{ plan.payback_period_months }}ヶ月
                    {% endif %}
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">月間売上</h6>
                <h3 class="mb-0">{{ plan.monthly_revenue|intcomma }}円</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">売上原価</h6>
                <h3 class="mb-0">{{ plan.monthly_cost_of_goods_sold|default:0|intcomma }}円</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">粗利益</h6>
                <h3 class="mb-0 {% if plan.monthly_gross_profit < 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ plan.monthly_gross_profit|default:0|intcomma }}円
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">月間経費</h6>
                <h3 class="mb-0">{{ plan.monthly_cost|intcomma }}円</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">月間利益</h6>
                <h3 class="mb-0 {% if plan.monthly_profit < 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ plan.monthly_profit|intcomma }}円
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- 原価率・利益率 -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">原価率</h6>
                <h3 class="mb-0">{{ cost_rate|floatformat:1 }}%</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card summary-card">
            <div class="card-body">
                <h6 class="text-muted mb-2">利益率</h6>
                <h3 class="mb-0 {% if profit_rate < 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ profit_rate|floatformat:1 }}%
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- グラフ表示 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">月次収支予測（12ヶ月分）</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">累積利益グラフ</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 計算根拠 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">計算根拠</h5>
            </div>
            <div class="card-body">
                <!-- 売上計算 -->
                <h6 class="fw-semibold mb-3">売上計算</h6>
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">昼の売上</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong>計算式:</strong><br>
                                    客単価 × 客数 × 営業日数 × 月毎指数
                                </p>
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td>客単価:</td>
                                        <td class="text-end">{{ lunch_revenue_calculation.price_per_customer|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>客数（1日あたり）:</td>
                                        <td class="text-end">{{ lunch_revenue_calculation.customer_count }}人</td>
                                    </tr>
                                    <tr>
                                        <td>営業曜日数:</td>
                                        <td class="text-end">{{ lunch_revenue_calculation.operating_days_count }}日</td>
                                    </tr>
                                    <tr>
                                        <td>月間営業日数:</td>
                                        <td class="text-end">{{ lunch_revenue_calculation.monthly_operating_days|floatformat:1 }}日</td>
                                    </tr>
                                    <tr>
                                        <td>月毎指数（平均）:</td>
                                        <td class="text-end">{{ lunch_revenue_calculation.avg_coefficient|floatformat:2 }}</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td><strong>昼の月間売上:</strong></td>
                                        <td class="text-end"><strong>{{ lunch_revenue_calculation.calculated_revenue|intcomma }}円</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">夜の売上</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong>計算式:</strong><br>
                                    客単価 × 客数 × 営業日数 × 月毎指数
                                </p>
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td>客単価:</td>
                                        <td class="text-end">{{ dinner_revenue_calculation.price_per_customer|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>客数（1日あたり）:</td>
                                        <td class="text-end">{{ dinner_revenue_calculation.customer_count }}人</td>
                                    </tr>
                                    <tr>
                                        <td>営業曜日数:</td>
                                        <td class="text-end">
                                            {% if dinner_revenue_calculation.is_24hours %}
                                            全曜日（24時間営業）
                                            {% else %}
                                            {{ dinner_revenue_calculation.operating_days_count }}日
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>月間営業日数:</td>
                                        <td class="text-end">{{ dinner_revenue_calculation.monthly_operating_days|floatformat:1 }}日</td>
                                    </tr>
                                    <tr>
                                        <td>月毎指数（平均）:</td>
                                        <td class="text-end">{{ dinner_revenue_calculation.avg_coefficient|floatformat:2 }}</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>夜の月間売上:</strong></td>
                                        <td class="text-end"><strong>{{ dinner_revenue_calculation.calculated_revenue|intcomma }}円</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 原価計算 -->
                <h6 class="fw-semibold mb-3">原価計算</h6>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">売上原価</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td>昼の売上:</td>
                                        <td class="text-end">{{ cost_of_goods_sold_calculation.lunch_revenue|intcomma }}円</td>
                                        <td>×</td>
                                        <td>原価率 {{ cost_of_goods_sold_calculation.lunch_cost_rate|floatformat:2 }}%</td>
                                        <td>=</td>
                                        <td class="text-end">{{ cost_of_goods_sold_calculation.lunch_cost|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>夜の売上:</td>
                                        <td class="text-end">{{ cost_of_goods_sold_calculation.dinner_revenue|intcomma }}円</td>
                                        <td>×</td>
                                        <td>原価率 {{ cost_of_goods_sold_calculation.dinner_cost_rate|floatformat:2 }}%</td>
                                        <td>=</td>
                                        <td class="text-end">{{ cost_of_goods_sold_calculation.dinner_cost|intcomma }}円</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td colspan="4"><strong>合計売上原価:</strong></td>
                                        <td class="text-end"><strong>{{ cost_of_goods_sold_calculation.total_cost|intcomma }}円</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 経費計算 -->
                <h6 class="fw-semibold mb-3">経費計算</h6>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">月間経費内訳</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td>家賃:</td>
                                        <td class="text-end">{{ cost_calculation.rent|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>人件費（社員）:</td>
                                        <td class="text-end">
                                            {{ cost_calculation.staff_count }}人 × {{ cost_calculation.staff_salary|intcomma }}円 = {{ cost_calculation.staff_cost|intcomma }}円
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>人件費（アルバイト）:</td>
                                        <td class="text-end">
                                            {{ cost_calculation.part_time_hours }}時間 × {{ cost_calculation.part_time_wage|intcomma }}円 = {{ cost_calculation.part_time_cost|intcomma }}円
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>人件費合計:</td>
                                        <td class="text-end">{{ cost_calculation.total_labor_cost|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>光熱費:</td>
                                        <td class="text-end">{{ cost_calculation.utilities|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>消耗品費:</td>
                                        <td class="text-end">{{ cost_calculation.supplies|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>広告宣伝費:</td>
                                        <td class="text-end">{{ cost_calculation.advertising|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>手数料:</td>
                                        <td class="text-end">{{ cost_calculation.fees|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>その他販管費:</td>
                                        <td class="text-end">{{ cost_calculation.other_expenses|intcomma }}円</td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>月間経費合計:</strong></td>
                                        <td class="text-end"><strong>{{ cost_calculation.total_cost|intcomma }}円</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 利益計算 -->
                <h6 class="fw-semibold mb-3">利益計算</h6>
                <div class="row">
                    <div class="col-12">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">月間利益の計算</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td>月間売上:</td>
                                        <td class="text-end">{{ plan.monthly_revenue|intcomma }}円</td>
                                    </tr>
                                    <tr>
                                        <td>売上原価:</td>
                                        <td class="text-end">- {{ plan.monthly_cost_of_goods_sold|default:0|intcomma }}円</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>粗利益:</strong></td>
                                        <td class="text-end"><strong>{{ plan.monthly_gross_profit|default:0|intcomma }}円</strong></td>
                                    </tr>
                                    <tr>
                                        <td>月間経費:</td>
                                        <td class="text-end">- {{ plan.monthly_cost|intcomma }}円</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>月間利益:</strong></td>
                                        <td class="text-end"><strong>{{ plan.monthly_profit|intcomma }}円</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 基本情報 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">基本情報</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>店のコンセプト:</strong><br>
                        {{ plan.store_concept|default:"未設定" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>席数:</strong><br>
                        {{ plan.number_of_seats }}席
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>ターゲット顧客:</strong><br>
                        {{ plan.target_customer|default:"未設定" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- エクスポートボタン -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">書類生成・ダウンロード</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">銀行提出用の書類を生成・ダウンロードできます。</p>
                <div class="btn-group" role="group">
                    <a href="{% url 'izakaya_plan_export' plan_id=plan.id format_type='pdf' %}" class="btn btn-primary">
                        <i class="ti ti-file-pdf me-1"></i>PDFダウンロード
                    </a>
                    <a href="{% url 'izakaya_plan_export' plan_id=plan.id format_type='excel' %}" class="btn btn-success">
                        <i class="ti ti-file-excel me-1"></i>Excelダウンロード
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 月次収支予測グラフ
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyData = {
    labels: Array.from({length: 12}, (_, i) => `${i + 1}月`),
    datasets: [
        {
            label: '売上',
            data: {{ monthly_revenue_data|safe }},
            backgroundColor: 'rgba(102, 126, 234, 0.5)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 1,
            type: 'bar'
        },
        {
            label: '経費',
            data: {{ monthly_cost_data|safe }},
            backgroundColor: 'rgba(239, 68, 68, 0.5)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1,
            type: 'bar'
        },
        {
            label: '利益',
            data: {{ monthly_profit_data|safe }},
            backgroundColor: 'rgba(16, 185, 129, 0.5)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 2,
            type: 'line',
            tension: 0.1
        }
    ]
};

new Chart(monthlyCtx, {
    type: 'bar',
    data: monthlyData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + '円';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '円';
                    }
                }
            }
        }
    }
});

// 累積利益グラフ
const cumulativeCtx = document.getElementById('cumulativeChart').getContext('2d');
const cumulativeData = {
    labels: Array.from({length: 12}, (_, i) => `${i + 1}月`),
    datasets: [{
        label: '累積利益',
        data: {{ cumulative_profit_data|safe }},
        backgroundColor: 'rgba(16, 185, 129, 0.2)',
        borderColor: 'rgba(16, 185, 129, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.1
    }]
};

new Chart(cumulativeCtx, {
    type: 'line',
    data: cumulativeData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString() + '円';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '累積利益: ' + context.parsed.y.toLocaleString() + '円';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

