{% extends "scoreai/base.html" %}
{% load humanize %}
{% load custom_filters %}
{% load static %}

{% block title %}
{{ title }}
{% endblock %}


{% block head %}
 <!-- DataTables CSS -->
 <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
 <!-- jQuery -->
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <!-- DataTables JS -->
 <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a class="text-muted text-decoration-none" href="#detail">会社情報詳細</a>
    </li>
    <li class="breadcrumb-item">
      <a class="text-muted text-decoration-none" href="#users">User一覧</a>
    </li>
  </ol>
</nav>    

{% endblock %}


{% block content %}
<div class="row">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0">会社情報</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <!-- 最初のテーブル -->
            <table class="table table-bordered">
              <tr>
                <td class="table-light">会社名</td>
                <td>{{ company.name }}</td>
              </tr>
              <tr>
                <td class="table-light">決算月</td>
                <td>{{ company.fiscal_month }}月</td>
              </tr>
              <tr>
                <td class="table-light">所属User数</td>
                <td>{{ user_count }}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <!-- 二つ目のテーブル -->
            <table class="table table-bordered">
              <tr>
                <td class="table-light">業種分類</td>
                <td>{{ company.industry_classification.name }}</td>
              </tr>
              <tr>
                <td class="table-light">業種小分類</td>
                <td>{{ company.industry_subclassification.name }}</td>
              </tr>
              <tr>
                <td class="table-light">企業規模</td>
                <td>{{ company.company_size }}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <div class="card-footer text-end">
        <a href="{% url 'company_update' company.id %}" class="btn btn-primary">編集</a>
        {% if is_company_owner %}
          <a href="{% url 'company_member_list' company_id=company.id %}" class="btn btn-outline-primary ms-2">
            <i class="ti ti-users me-1"></i>メンバー管理
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0">利用システム</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <table class="table table-bordered">
              <tr>
                <td class="table-light">会計システム</td>
                <td>
                  {% if company.accounting_system %}
                    {% if company.accounting_system == 'other' %}
                      {{ company.accounting_system_other|default:"その他" }}
                    {% else %}
                      {{ company.get_accounting_system_display }}
                    {% endif %}
                  {% else %}
                    <span class="text-muted">未設定</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">販売管理</td>
                <td>
                  {% if company.sales_management_system %}
                    {{ company.sales_management_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">購買管理</td>
                <td>
                  {% if company.purchase_management_system %}
                    {{ company.purchase_management_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">生産管理</td>
                <td>
                  {% if company.production_management_system %}
                    {{ company.production_management_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">在庫管理</td>
                <td>
                  {% if company.inventory_management_system %}
                    {{ company.inventory_management_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-bordered">
              <tr>
                <td class="table-light">給与計算</td>
                <td>
                  {% if company.payroll_system %}
                    {{ company.payroll_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">人事管理</td>
                <td>
                  {% if company.hr_management_system %}
                    {{ company.hr_management_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">基幹システム</td>
                <td>
                  {% if company.core_system %}
                    {{ company.core_system }}
                  {% else %}
                    <span class="text-muted">未使用</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td class="table-light">その他</td>
                <td>
                  {% if company.other_systems %}
                    {{ company.other_systems|linebreaks }}
                  {% else %}
                    <span class="text-muted">なし</span>
                  {% endif %}
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if is_company_manager and usage_info %}
<div class="row" id="usage-info">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0">利用枠・利用状況</h5>
      </div>
      <div class="card-body">
        {% for info in usage_info %}
        <div class="mb-4 {% if not forloop.last %}border-bottom pb-4{% endif %}">
          <h6 class="fw-semibold mb-3">{{ info.firm.name }}</h6>
          <div class="row">
            <div class="col-md-6">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th colspan="2" class="text-center">API利用枠</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="table-light w-50">割り当て</td>
                    <td>
                      {% if info.api_limit > 0 %}
                        {{ info.api_limit }}
                      {% else %}
                        <span class="text-muted">未設定</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="table-light">利用数</td>
                    <td>{{ info.api_used }}</td>
                  </tr>
                  <tr>
                    <td class="table-light">残り</td>
                    <td>
                      {% if info.api_remaining is not None %}
                        {{ info.api_remaining }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="table-light">コンサルタント利用可否</td>
                    <td>
                      {% if info.allow_firm_api_usage %}
                        <span class="badge bg-success">許可</span>
                      {% else %}
                        <span class="badge bg-secondary">不可</span>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th colspan="2" class="text-center">OCR利用枠</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="table-light w-50">割り当て</td>
                    <td>
                      {% if info.ocr_limit > 0 %}
                        {{ info.ocr_limit }}
                      {% else %}
                        <span class="text-muted">未設定</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="table-light">利用数</td>
                    <td>{{ info.ocr_used }}</td>
                  </tr>
                  <tr>
                    <td class="table-light">残り</td>
                    <td>
                      {% if info.ocr_remaining is not None %}
                        {{ info.ocr_remaining }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="table-light">コンサルタント利用可否</td>
                    <td>
                      {% if info.allow_firm_ocr_usage %}
                        <span class="badge bg-success">許可</span>
                      {% else %}
                        <span class="badge bg-secondary">不可</span>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row" id="users">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
        <h5 class="card-title mb-0">所属User一覧</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="userTable" class="table">
            <thead>
              <tr>
                <th>ユーザー名</th>
                <th>メールアドレス</th>
                <th>アクティブ</th>
                <th>オーナー</th>
              </tr>
            </thead>
            <tbody>
              {% for user_company in users %}
                <tr>
                  <td>{{ user_company.user.username }}</td>
                  <td>{{ user_company.user.email }}</td>
                  <td>{% if user_company.active %}はい{% else %}いいえ{% endif %}</td>
                  <td>{% if user_company.is_owner %}はい{% else %}いいえ{% endif %}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4">所属ユーザーがいません。</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

