{% extends "scoreai/base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">クライアント管理</h4>
    <p class="text-muted mb-0">クライアント（Company）の管理とアサインを行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      {% get_user_firm_owner user as user_firm_owner %}
      {% if user_firm_owner %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_settings' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-settings me-1"></i>Firm設定
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_member_list' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-users me-1"></i>スタッフ管理
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{% url 'firm_clientslist' %}" role="tab">
          <i class="ti ti-building me-1"></i>クライアント一覧
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_todo_list' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-checkbox me-1"></i>To Do一覧
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'subscription_manage' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-credit-card me-1"></i>サブスクリプション管理
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'usage_report' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-chart-line me-1"></i>利用状況レポート
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'billing_history' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-file-invoice me-1"></i>請求管理
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'notification_list' firm_id=user_firm_owner.firm.id %}" role="tab">
          <i class="ti ti-bell me-1"></i>通知
        </a>
      </li>
      {% endif %}
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="clientManagementTabsContent">
  <!-- クライアント一覧 -->
  <div class="tab-pane fade show active" id="client-list" role="tabpanel">
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-light border">
          <i class="ti ti-info-circle me-2 text-primary"></i>
          <strong>クライアント一覧</strong>では、Firmに登録されているクライアントを管理できます。
        </div>
      </div>
    </div>
<!-- プラン制限情報の表示 -->
{% if max_companies is not None %}
<div class="row mb-4">
  <div class="col-12">
    <div class="alert {% if can_add_company %}alert-info{% else %}alert-warning{% endif %} d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <strong>プラン制限:</strong>
        現在: <strong>{{ current_company_count }}</strong>社 / 上限: 
        {% if is_unlimited %}
          <strong>無制限</strong>
        {% else %}
          <strong>{{ max_companies }}</strong>社
        {% endif %}
        
        {% if not can_add_company %}
          <span class="badge bg-warning ms-2">制限に達しています</span>
        {% elif max_companies > 0 and current_company_count >= max_companies|add:"-1" %}
          <span class="badge bg-info ms-2">あと1社追加可能</span>
        {% endif %}
      </div>
      {% if not can_add_company and user_firm %}
      <div>
        <a href="{% url 'plan_list' firm_id=user_firm.firm.id %}" class="btn btn-sm btn-primary">
          プランをアップグレード
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<!-- 未割り当て利用枠の警告表示 -->
{% if is_firm_manager and user_firm %}
  {% if unassigned_api_limit and unassigned_api_limit > 0 or unassigned_ocr_limit and unassigned_ocr_limit > 0 %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-warning d-flex align-items-center justify-content-between flex-wrap gap-2" role="alert">
        <div>
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>未割り当ての利用枠があります:</strong>
          {% if unassigned_api_limit and unassigned_api_limit > 0 %}
            <span class="badge bg-warning text-dark ms-2">API: {{ unassigned_api_limit }}回未割り当て</span>
          {% endif %}
          {% if unassigned_ocr_limit and unassigned_ocr_limit > 0 %}
            <span class="badge bg-warning text-dark ms-2">OCR: {{ unassigned_ocr_limit }}回未割り当て</span>
          {% endif %}
          <span class="ms-2">（プラン上限: API {{ plan_api_limit|default:"無制限" }}回 / OCR {{ plan_ocr_limit|default:"無制限" }}回）</span>
        </div>
        <div class="d-flex gap-2">
          {% if unassigned_api_limit and unassigned_api_limit > 0 %}
          <button type="button" 
                  class="btn btn-sm btn-primary" 
                  id="distributeApiLimitsBtn"
                  onclick="distributeLimitsEvenly('api')">
            <i class="ti ti-equal me-1"></i>API利用枠を均等に割り当て
          </button>
          {% endif %}
          {% if unassigned_ocr_limit and unassigned_ocr_limit > 0 %}
          <button type="button" 
                  class="btn btn-sm btn-success" 
                  id="distributeOcrLimitsBtn"
                  onclick="distributeLimitsEvenly('ocr')">
            <i class="ti ti-equal me-1"></i>OCR利用枠を均等に割り当て
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endif %}

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-semibold mb-0">契約中クライアント</h5>
        {% if is_firm_manager and user_firm and active_company_count > 0 %}
        <div class="d-flex gap-2">
          {% if plan_api_limit %}
          <button type="button" 
                  class="btn btn-sm btn-outline-primary" 
                  onclick="distributeLimitsEvenly('api')"
                  title="プランのAPI利用枠を各クライアントに均等に割り当てます">
            <i class="ti ti-equal me-1"></i>API利用枠を均等に割り当て
          </button>
          {% endif %}
          {% if plan_ocr_limit %}
          <button type="button" 
                  class="btn btn-sm btn-outline-success" 
                  onclick="distributeLimitsEvenly('ocr')"
                  title="プランのOCR利用枠を各クライアントに均等に割り当てます">
            <i class="ti ti-equal me-1"></i>OCR利用枠を均等に割り当て
          </button>
          {% endif %}
        </div>
        {% endif %}
      </div>
      <div class="card-body p-4">
        <div class="table table-hover">
          <table class="table text-nowrap mb-0 align-middle">
            <thead class="text-dark fs-4">
              <tr>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">会社名</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">会計年度</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">開始日付</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">有効User数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">API利用枠</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">OCR利用枠</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">代理利用許可</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">操作</h6>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for client in clients %}
              <tr>
                <td class="border-bottom-0">
                    <h6 class="fw-semibold mb-1">
                      <a href="{% url 'company_detail' id=client.company.id %}" class="text-decoration-none">
                        {{ client.company.name }}
                      </a>
                    </h6>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ client.company.fiscal_month}}月</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ client.start_date }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ client.company.user_count }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if client.api_limit > 0 %}
                      {{ client.api_limit }}
                    {% else %}
                      <span class="text-muted">未設定</span>
                    {% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if client.ocr_limit > 0 %}
                      {{ client.ocr_limit }}
                    {% else %}
                      <span class="text-muted">未設定</span>
                    {% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <div class="d-flex align-items-center gap-2">
                    {% if client.allow_firm_api_usage or client.allow_firm_ocr_usage %}
                      {% if client.allow_firm_api_usage %}
                        <span class="badge bg-info">API</span>
                      {% endif %}
                      {% if client.allow_firm_ocr_usage %}
                        <span class="badge bg-success">OCR</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td class="border-bottom-0">
                  <div class="d-flex align-items-center gap-2">
                    {% get_user_firm_owner user as user_firm_owner %}
                    {% if user_firm_owner %}
                    <a href="{% url 'firm_company_limit_update' firm_id=user_firm_owner.firm.id company_id=client.company.id %}" 
                       class="btn btn-sm btn-primary" 
                       title="利用枠設定">
                      <i class="ti ti-settings me-1"></i>設定
                    </a>
                    {% endif %}
                    {% if is_firm_owner %}
                      {% if client.company.id not in assigned_company_ids %}
                      <form method="post" action="{% url 'add_client' client_id=client.company.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-success">
                          <i class="ti ti-user-plus me-1"></i>自分にアサイン
                        </button>
                      </form>
                      {% else %}
                      <span class="badge bg-success">
                        <i class="ti ti-check me-1"></i>アサイン済み
                      </span>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
              </tr> 
              {% endfor %}       
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <button type="button" onclick="history.back()" class="btn btn-outline-secondary">戻る</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title fw-semibold mb-0">アサインされているクライアント</h5>
      </div>
      <div class="card-body p-4">
        <div class="table table-hover">
          <table class="table text-nowrap mb-0 align-middle">
            <thead class="text-dark fs-4">
              <tr>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">会社名</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">会計年度</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">開始日付</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">有効User数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">API利用枠</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">OCR利用枠</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">代理利用許可</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">操作</h6>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for client in clients_assigned %}
              {% with firm_company=firm_companies_dict|get_item:client.company.id %}
              <tr>
                <td class="border-bottom-0">
                    <h6 class="fw-semibold mb-1">
                      <a href="{% url 'company_detail' id=client.company.id %}" class="text-decoration-none">
                        {{ client.company.name }}
                      </a>
                    </h6>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ client.company.fiscal_month}}月</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if firm_company %}{{ firm_company.start_date|date:"Y年m月d日" }}{% else %}-{% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ client.company.user_count }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if firm_company and firm_company.api_limit > 0 %}
                      {{ firm_company.api_limit }}
                    {% else %}
                      <span class="text-muted">未設定</span>
                    {% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if firm_company and firm_company.ocr_limit > 0 %}
                      {{ firm_company.ocr_limit }}
                    {% else %}
                      <span class="text-muted">未設定</span>
                    {% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <div class="d-flex align-items-center gap-2">
                    {% if firm_company %}
                      {% if firm_company.allow_firm_api_usage or firm_company.allow_firm_ocr_usage %}
                        {% if firm_company.allow_firm_api_usage %}
                          <span class="badge bg-info">API</span>
                        {% endif %}
                        {% if firm_company.allow_firm_ocr_usage %}
                          <span class="badge bg-success">OCR</span>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </div>
                </td>
                <td class="border-bottom-0">
                  <div class="d-flex align-items-center gap-2">
                    {% if not client.is_selected %}
                    <a href="{% url 'select_company' client.company.id %}" 
                       class="text-primary text-decoration-none d-flex align-items-center gap-1" 
                       title="選択"
                       class="pencil-transition">
                      <i class="ti ti-check pencil-icon-md"></i>
                      <span class="small fw-semibold">選択</span>
                    </a>
                    {% else %}
                    <span class="badge bg-primary">選択中</span>
                    {% endif %}
                    {% if client.is_owner %}
                    <span class="badge bg-warning text-dark">
                      <i class="ti ti-crown me-1"></i>Owner
                    </span>
                    {% endif %}
                    {# FirmのOwnerは自分自身のアサイン解除はできない（強制的に全Companyにアサインされている） #}
                    {# ただし、他のFirmユーザーのアサイン解除は可能（現時点ではclients_assignedは自分がアサインされているクライアントのみ） #}
                    {% if is_firm_owner and not client.is_owner %}
                    <form method="post" action="{% url 'remove_client' client_id=client.company.id %}" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('アサインを解除しますか？');">
                        <i class="ti ti-user-minus me-1"></i>アサイン解除
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endwith %}
              {% endfor %}       
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer">
        <button type="button" onclick="history.back()" class="btn btn-outline-secondary">戻る</button>
      </div>
    </div>
  </div>
</div>

{% if is_firm_manager and user_firm %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function distributeLimitsEvenly(limitType) {
  const limitName = limitType === 'api' ? 'API利用枠' : 'OCR利用枠';
  if (!confirm(`プランの${limitName}を各クライアントに均等に割り当てますか？\n既存の割り当ては上書きされます。`)) {
    return;
  }
  
  const btn = event.target.closest('button') || 
              document.getElementById('distributeApiLimitsBtn') || 
              document.getElementById('distributeOcrLimitsBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>処理中...';
  
  const csrftoken = getCookie('csrftoken');
  
  // URLを構築（firm_idとlimit_typeを動的に設定）
  const firmId = '{{ user_firm.firm.id }}';
  const url = `/firm/${firmId}/distribute-limits-evenly/${limitType}/`;
  
  fetch(url, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert('エラー: ' + (data.error || '不明なエラーが発生しました'));
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('エラーが発生しました: ' + error.message);
    btn.disabled = false;
    btn.innerHTML = originalText;
  });
}
</script>
{% endif %}
  </div>
  <!-- End of tab-pane -->
</div>
<!-- End of tab-content -->
{% endblock %}

