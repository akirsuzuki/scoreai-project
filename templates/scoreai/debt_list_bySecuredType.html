{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}

{% block breadcrumb %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">借入管理</h4>
    <p class="text-muted mb-0">借入情報の管理と分析を行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'debts_overview' %}" role="tab">
          <i class="ti ti-chart-pie me-1"></i>概要
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'debts_all' %}" role="tab">
          <i class="ti ti-list me-1"></i>借入一覧
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'debts_byBank' %}" role="tab">
          <i class="ti ti-building-bank me-1"></i>金融機関別
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{% url 'debts_bySecuredType' %}" role="tab">
          <i class="ti ti-shield me-1"></i>保証別
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'debts_archived' %}" role="tab">
          <i class="ti ti-archive me-1"></i>アーカイブ済み
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'debt_create' %}" role="tab">
          <i class="ti ti-plus me-1"></i>新規登録
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="debtTabsContent">
  <!-- 保証別 -->
  <div class="tab-pane fade show active" id="debt-by-secured-type" role="tabpanel">
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-light border">
          <i class="ti ti-info-circle me-2 text-primary"></i>
          <strong>保証別</strong>では、保証協会ごとに借入情報を集計して表示できます。
        </div>
      </div>
    </div>

<!-- 円グラフセクション -->
<div class="row mb-4">
  <div class="col-12 col-md-4 mb-4 mb-md-0">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title fw-semibold mb-0">保証協会別残高シェア</h5>
      </div>
      <div class="card-body">
        <div class="pencil-chart-wrapper">
          <canvas id="bySecuredTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4 mb-4 mb-md-0">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title fw-semibold mb-0">金融機関別・保証別残高シェア</h5>
      </div>
      <div class="card-body">
        <div class="pencil-chart-wrapper">
          <canvas id="byBankAndSecuredTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title fw-semibold mb-0">直近で実行された借入</h5>
      </div>
      <div class="card-body">
        {% if most_recent_debt %}
        <div class="d-flex flex-column gap-3">
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">金融機関</span>
            <span class="fw-semibold">{{ most_recent_debt.financial_institution.short_name|default:most_recent_debt.financial_institution.name }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">実行日</span>
            <span class="fw-semibold">{{ most_recent_debt.issue_date|date:"Y年n月j日" }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">元本金額</span>
            <span class="fw-semibold">{{ most_recent_debt.principal|to_thousands|intcomma }} 千円</span>
          </div>
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">金利</span>
            <span class="fw-semibold">{{ most_recent_debt.interest_rate }}%</span>
          </div>
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">月返済額</span>
            <span class="fw-semibold">{{ most_recent_debt.monthly_repayment|to_thousands|intcomma }} 千円</span>
          </div>
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2">
            <span class="text-muted">保証区分</span>
            <span class="fw-semibold">{{ most_recent_debt.secured_type|default:"なし" }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">代表者保証</span>
            <span>
              {% if most_recent_debt.is_securedby_management %}
                <span class="badge bg-info">あり</span>
              {% else %}
                <span class="badge bg-secondary">なし</span>
              {% endif %}
            </span>
          </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="ti ti-database-off fs-1 mb-2 d-block"></i>
          借入データがありません
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- テーブルセクション -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a class="text-muted text-decoration-none" href="#bySecuredType">保証協会別</a>
            </li>
            <li class="breadcrumb-item">
              <a class="text-muted text-decoration-none" href="#byBankAndSecured">金融機関・保証別</a>
            </li>
          </ol>
        </nav>
      </div>
      <div class="card-body">
        <p id="bySecuredType"></p>
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="debt_list_bySecuredType_table">
            <thead>
              <tr>
                <th>保証タイプ</th>
                <th>合計元本(千円)</th>
                <th>合計月返済額</th>
                <th>合計現在残高<br>シェア</th>
                <th>合計今期末残高<br>シェア</th>
                <th>加重平均金利</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list_bySecuredType %}
              <tr>
                <td>{{ debt.secured_type }}</td>
                <td>{{ debt.principal|to_thousands|intcomma }}</td>
                <td>{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td>{{ debt.balances_monthly.0|to_thousands|intcomma }}<br>{{debt.balances_monthly.0|percentage:debt_list_totals.total_balances_monthly.0 }}</td>
                <td>{{ debt.balance_fy1|to_thousands|intcomma }}<br>{{debt.balance_fy1|percentage:debt_list_totals.total_balance_fy1 }}</td>
                <td>{{ debt.weighted_average_interest|floatformat:2 }}%</td>
                <td>
                  <a href="{% url 'debts_bySecuredType_detail' debt.secured_type.id %}" class="btn btn-sm btn-primary" aria-label="詳細を見る">
                    <i class="ti ti-arrow-right"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="1" class="text-end">合計：</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title fw-semibold">金融機関別・保証別</h5>
      </div>
      <div class="card-body">
        <p id="byBankAndSecured"></p>
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="debt_list_byBankAndSecuredType_table">
            <thead>
              <tr>
                <th>銀行名</th>
                <th>保証タイプ</th>
                <th>合計元本(千円)</th>
                <th>合計月返済額</th>
                <th>合計現在残高<br>シェア</th>
                <th>合計今期末残高<br>シェア</th>
                <th>加重平均金利</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list_byBankAndSecuredType %}
              <tr>
                <td>{{ debt.financial_institution }}</td>
                <td>{{ debt.secured_type }}</td>
                <td>{{ debt.principal|to_thousands|intcomma }}</td>
                <td>{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td>{{ debt.balances_monthly.0|to_thousands|intcomma}}<br>{{debt.balances_monthly.0|percentage:debt_list_totals.total_balances_monthly.0 }}</td>
                <td>{{ debt.balance_fy1|to_thousands|intcomma }}<br>{{debt.balance_fy1|percentage:debt_list_totals.total_balance_fy1 }}</td>
                <td>{{ debt.weighted_average_interest|floatformat:2 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="2" class="text-end">合計：</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

  </div>  <!-- Close .tab-pane -->
</div>  <!-- Close .tab-content -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 保証協会別円グラフ
    const bySecuredTypeCtx = document.getElementById('bySecuredTypeChart');
    if (bySecuredTypeCtx) {
      const bySecuredTypeLabels = [
        {% for debt in debt_list_bySecuredType %}
        '{{ debt.secured_type.name|escapejs }}',
        {% endfor %}
      ];
      const bySecuredTypeValues = [
        {% for debt in debt_list_bySecuredType %}
        {{ debt.balances_monthly.0|default:0 }},
        {% endfor %}
      ];
      
      const bySecuredTypeData = {
        labels: bySecuredTypeLabels,
        datasets: [{
          data: bySecuredTypeValues,
          backgroundColor: function() {
            const colors = [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)',
              'rgba(199, 199, 199, 0.8)',
              'rgba(83, 102, 255, 0.8)',
              'rgba(255, 99, 255, 0.8)',
              'rgba(99, 255, 132, 0.8)',
            ];
            return bySecuredTypeValues.map((_, i) => colors[i % colors.length]);
          }(),
          borderColor: function() {
            const colors = [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)',
              'rgba(199, 199, 199, 1)',
              'rgba(83, 102, 255, 1)',
              'rgba(255, 99, 255, 1)',
              'rgba(99, 255, 132, 1)',
            ];
            return bySecuredTypeValues.map((_, i) => colors[i % colors.length]);
          }(),
          borderWidth: 2
        }]
      };

      new Chart(bySecuredTypeCtx, {
        type: 'pie',
        data: bySecuredTypeData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 12
                },
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    const dataset = data.datasets[0];
                    const total = dataset.data.reduce((a, b) => a + b, 0);
                    return data.labels.map((label, i) => {
                      const value = dataset.data[i];
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return {
                        text: label + ' (' + percentage + '%)',
                        fillStyle: dataset.backgroundColor[i],
                        strokeStyle: dataset.borderColor[i],
                        lineWidth: dataset.borderWidth,
                        hidden: false,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return label + ': ' + (value / 1000000).toFixed(1) + '百万円 (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }

    // 金融機関別・保証別円グラフ
    const byBankAndSecuredTypeCtx = document.getElementById('byBankAndSecuredTypeChart');
    if (byBankAndSecuredTypeCtx) {
      const byBankAndSecuredTypeLabels = [
        {% for debt in debt_list_byBankAndSecuredType %}
        '{{ debt.financial_institution.short_name|escapejs }} - {{ debt.secured_type.name|escapejs }}',
        {% endfor %}
      ];
      const byBankAndSecuredTypeValues = [
        {% for debt in debt_list_byBankAndSecuredType %}
        {{ debt.balances_monthly.0|default:0 }},
        {% endfor %}
      ];
      
      const byBankAndSecuredTypeData = {
        labels: byBankAndSecuredTypeLabels,
        datasets: [{
          data: byBankAndSecuredTypeValues,
          backgroundColor: function() {
            const colors = [
              'rgba(54, 162, 235, 0.8)',
              'rgba(255, 99, 132, 0.8)',
              'rgba(255, 206, 86, 0.8)',
              'rgba(75, 192, 192, 0.8)',
              'rgba(153, 102, 255, 0.8)',
              'rgba(255, 159, 64, 0.8)',
              'rgba(199, 199, 199, 0.8)',
              'rgba(83, 102, 255, 0.8)',
              'rgba(255, 99, 255, 0.8)',
              'rgba(99, 255, 132, 0.8)',
            ];
            return byBankAndSecuredTypeValues.map((_, i) => colors[i % colors.length]);
          }(),
          borderColor: function() {
            const colors = [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)',
              'rgba(199, 199, 199, 1)',
              'rgba(83, 102, 255, 1)',
              'rgba(255, 99, 255, 1)',
              'rgba(99, 255, 132, 1)',
            ];
            return byBankAndSecuredTypeValues.map((_, i) => colors[i % colors.length]);
          }(),
          borderWidth: 2
        }]
      };

      new Chart(byBankAndSecuredTypeCtx, {
        type: 'pie',
        data: byBankAndSecuredTypeData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 11
                },
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    const dataset = data.datasets[0];
                    const total = dataset.data.reduce((a, b) => a + b, 0);
                    return data.labels.map((label, i) => {
                      const value = dataset.data[i];
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return {
                        text: label + ' (' + percentage + '%)',
                        fillStyle: dataset.backgroundColor[i],
                        strokeStyle: dataset.borderColor[i],
                        lineWidth: dataset.borderWidth,
                        hidden: false,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return label + ': ' + (value / 1000000).toFixed(1) + '百万円 (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }

    // DataTable初期化 - 保証協会別テーブル（レスポンシブ対応）
    const table1 = new DataTable('#debt_list_bySecuredType_table', {
      responsive: false,
      scrollX: true,
      scrollCollapse: true,
      autoWidth: false,
      pageLength: 25,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
      },
      order: [[0, 'asc']], // 保証タイプで昇順ソート
      dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "すべて"]],
      pagingType: 'full_numbers',
      footerCallback: function (row, data, start, end, display) {
        let api = this.api();
        let intVal = function (i) {
          return typeof i === 'string'
            ? i.replace(/[\$,]/g, '') * 1
            : typeof i === 'number'
              ? i
              : 0;
        };
        
        // 元本の合計
        let principalTotal = api
          .column(1)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 月返済額の合計
        let monthlyRepaymentTotal = api
          .column(2)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 現在残高の合計
        let balanceTotal = api
          .column(3)
          .data()
          .reduce((a, b) => {
            // セル内の改行で分割された最初の値（残高）を取得
            const value = typeof b === 'string' ? b.split('<br>')[0] : b;
            return intVal(a) + intVal(value);
          }, 0);
        
        // 今期末残高の合計
        let balanceFy1Total = api
          .column(4)
          .data()
          .reduce((a, b) => {
            // セル内の改行で分割された最初の値（残高）を取得
            const value = typeof b === 'string' ? b.split('<br>')[0] : b;
            return intVal(a) + intVal(value);
          }, 0);
        
        // フッターに表示
        $(api.column(1).footer()).html(principalTotal.toLocaleString('ja-JP'));
        $(api.column(2).footer()).html(monthlyRepaymentTotal.toLocaleString('ja-JP'));
        $(api.column(3).footer()).html(balanceTotal.toLocaleString('ja-JP'));
        $(api.column(4).footer()).html(balanceFy1Total.toLocaleString('ja-JP'));
      }
    });

    // DataTable初期化 - 金融機関別・保証別テーブル（レスポンシブ対応）
    const table2 = new DataTable('#debt_list_byBankAndSecuredType_table', {
      responsive: false,
      scrollX: true,
      scrollCollapse: true,
      autoWidth: false,
      pageLength: 25,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
      },
      order: [[0, 'asc']], // 銀行名で昇順ソート
      dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
      lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "すべて"]],
      pagingType: 'full_numbers',
      footerCallback: function (row, data, start, end, display) {
        let api = this.api();
        let intVal = function (i) {
          return typeof i === 'string'
            ? i.replace(/[\$,]/g, '') * 1
            : typeof i === 'number'
              ? i
              : 0;
        };
        
        // 元本の合計
        let principalTotal = api
          .column(2)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 月返済額の合計
        let monthlyRepaymentTotal = api
          .column(3)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 現在残高の合計
        let balanceTotal = api
          .column(4)
          .data()
          .reduce((a, b) => {
            // セル内の改行で分割された最初の値（残高）を取得
            const value = typeof b === 'string' ? b.split('<br>')[0] : b;
            return intVal(a) + intVal(value);
          }, 0);
        
        // 今期末残高の合計
        let balanceFy1Total = api
          .column(5)
          .data()
          .reduce((a, b) => {
            // セル内の改行で分割された最初の値（残高）を取得
            const value = typeof b === 'string' ? b.split('<br>')[0] : b;
            return intVal(a) + intVal(value);
          }, 0);
        
        // フッターに表示
        $(api.column(2).footer()).html(principalTotal.toLocaleString('ja-JP'));
        $(api.column(3).footer()).html(monthlyRepaymentTotal.toLocaleString('ja-JP'));
        $(api.column(4).footer()).html(balanceTotal.toLocaleString('ja-JP'));
        $(api.column(5).footer()).html(balanceFy1Total.toLocaleString('ja-JP'));
      }
    });
  });
</script>
{% endblock %}