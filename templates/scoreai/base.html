{% load static %}

<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    {% block title %}
    {% endblock %}
  </title>
  {% block head %}
  {% endblock %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="shortcut icon" type="image/png" href="{% static 'scoreai/img/FaviconSCore_Ai.png' %}" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- Pencil Design System (Bootstrap上書き用) -->
  <link rel="stylesheet" href="{% static 'scoreai/css/pencil-design-system.css' %}" />
  
  <!-- Bootstrap JS (CDNから読み込み、スタイルはPencil Design Systemで上書き) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simplebar@6.2.5/dist/simplebar.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@6.2.5/dist/simplebar.min.css">
  
  <!-- Tabler Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
  
  <!-- その他のスクリプト -->
  <script src="https://kit.fontawesome.com/c0e97851db.js" crossorigin="anonymous"></script>
</head>

<body>
  <!--  Body Wrapper (Pencil Design System) -->
  <div class="page-wrapper" id="main-wrapper">
    <!-- Sidebar -->
    {% include 'scoreai/base-sidebar.html' %}
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Body Header -->
      {% include 'scoreai/base-header.html' %}

      <div class="main-content-wrapper">
        {% if show_title_card|default_if_none:False %}
        <div class="card pencil-page-title">
          <div class="card-body">
            {% if title_category %}
            <div class="pencil-page-title-category">{{ title_category }}</div>
            {% endif %}
            <h4 class="pencil-page-title-text">{% if title and title|length > 0 %}{{ title }}{% else %}ページタイトル{% endif %}</h4>
            {% if subtitle %}
            <div class="pencil-page-title-subtitle">{{ subtitle }}</div>
            {% endif %}
            {% block breadcrumb %}
            {% endblock %}
          </div>
        </div>
        {% endif %}



        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div 
                class="alert alert-dismissible fade show
                       {% if message.tags == 'error' %}alert-danger
                       {% elif message.tags == 'success' %}alert-success
                       {% else %}alert-warning
                       {% endif %}" 
                role="alert">
                {% if 'safe' in message.tags %}
                    {{ message|safe }}
                {% else %}
                    {{ message }}
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

      {% block content %}

      {% endblock %}
      
      <!-- ページ下部の区切り -->
      <div class="page-footer-divider">
        <hr>
      </div>
      </div>

    </div>
  </div>

  <!-- Pencil Design System -->
  <script>
    // サイドバーのトグル機能
    document.addEventListener('DOMContentLoaded', function() {
      const pageWrapper = document.getElementById('main-wrapper');
      const sidebar = document.querySelector('.left-sidebar');
      
      // サイドバーを開くトグルボタン（ヘッダーのハンバーガーメニュー）
      document.querySelectorAll('.sidebartoggler').forEach(function(toggler) {
        toggler.addEventListener('click', function(e) {
          e.preventDefault();
          if (pageWrapper) {
            pageWrapper.classList.toggle('show-sidebar');
          }
        });
      });
      
      // サイドバー外クリックで閉じる（モバイル時）
      document.addEventListener('click', function(e) {
        if (window.innerWidth < 1200) {
          const isClickInsideSidebar = sidebar && sidebar.contains(e.target);
          const isClickOnToggler = e.target.closest('.sidebartoggler');
          
          if (!isClickInsideSidebar && !isClickOnToggler && pageWrapper && pageWrapper.classList.contains('show-sidebar')) {
            pageWrapper.classList.remove('show-sidebar');
          }
        }
      });
      
      // ウィンドウリサイズ時にサイドバー状態をリセット
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1200 && pageWrapper) {
          pageWrapper.classList.remove('show-sidebar');
        }
      });
    });
    
    // ページ読み込み後にアクティブなメニュー項目までスクロール
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        // アクティブなメニュー項目を検索
        const activeMenuItem = document.querySelector('#sidebarnav .sidebar-link.active, #sidebarnav .sidebar-item.selected .sidebar-link');
        
        if (activeMenuItem) {
          // 親のcollapseメニューを展開
          const collapseMenu = activeMenuItem.closest('.collapse');
          if (collapseMenu && !collapseMenu.classList.contains('show') && !collapseMenu.classList.contains('in')) {
            const collapseTrigger = document.querySelector(`[data-bs-target="#${collapseMenu.id}"], [href="#${collapseMenu.id}"]`);
            if (collapseTrigger) {
              // Bootstrap 5のcollapseを展開
              const bsCollapse = new bootstrap.Collapse(collapseMenu, {
                toggle: false
              });
              bsCollapse.show();
            }
          }
          
          // collapseのアニメーションを待ってからスクロール
          setTimeout(function() {
            // SimpleBarのスクロールコンテナを取得
            const sidebarNav = document.querySelector('.sidebar-nav[data-simplebar]');
            if (sidebarNav) {
              // SimpleBarのインスタンスを取得
              const simpleBarInstance = SimpleBar.instances.get(sidebarNav);
              if (simpleBarInstance) {
                // アクティブな項目の位置を取得
                const activeItemRect = activeMenuItem.getBoundingClientRect();
                const sidebarRect = sidebarNav.getBoundingClientRect();
                
                // スクロール位置を計算（アクティブ項目が中央付近に来るように）
                const scrollContainer = simpleBarInstance.getScrollElement();
                const itemOffsetTop = activeMenuItem.offsetTop;
                const sidebarHeight = sidebarNav.clientHeight;
                const targetScrollTop = itemOffsetTop - (sidebarHeight / 2) + (activeItemRect.height / 2);
                
                // スムーズにスクロール
                scrollContainer.scrollTo({
                  top: Math.max(0, targetScrollTop),
                  behavior: 'smooth'
                });
              } else {
                // SimpleBarインスタンスが取得できない場合、直接スクロール
                const scrollContainer = sidebarNav.querySelector('.simplebar-content-wrapper');
                if (scrollContainer) {
                  const itemOffsetTop = activeMenuItem.offsetTop;
                  const sidebarHeight = sidebarNav.clientHeight;
                  const targetScrollTop = itemOffsetTop - (sidebarHeight / 2);
                  
                  scrollContainer.scrollTo({
                    top: Math.max(0, targetScrollTop),
                    behavior: 'smooth'
                  });
                }
              }
            } else {
              // SimpleBarが使われていない場合、通常のスクロール
              activeMenuItem.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'nearest'
              });
            }
          }, 350); // collapseのアニメーション時間を考慮
        }
      }, 100);
    });
  </script>

</body>
{% block foot %}
{% endblock %}
</html>