{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a class="text-muted text-decoration-none" href="{% url 'debts_byBank' %}">金融機関別一覧</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ financial_institution.short_name|default:"金融機関" }} - 借入一覧
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          {{ financial_institution.short_name|default:"金融機関" }} - 借入一覧
        </h5>
        
        <div class="table-responsive">
          <table id="debt_list_byBank_detail_table" class="table table-striped table-bordered w-100">
            <thead>
              <tr>
                <th>ステータス</th>
                <th>区分</th>
                <th>元本(千円)</th>
                <th>保証</th>
                <th>利息</th>
                <th>実行日</th>
                <th>返済開始日</th>
                <th>月返済額</th>
                <th>残高シェア</th>
                <th>残り月数</th>
                <th>支払回数</th>
                <th>今月末残高</th>
                <th>今月概算利息</th>
                <th>決算時残高</th>
                <th>代表者保証</th>
                <th>担保</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list %}
              <tr data-href="{% url 'debt_detail' debt.id %}">
                <td>
                  {% if debt.start_date <= today %}
                    <span class="badge bg-success">返済中</span>
                  {% else %}
                    <span class="badge bg-danger">返済前</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.debt_type == 'corporate_bond' %}
                    <span class="badge bg-warning text-dark">社債</span>
                  {% elif debt.debt_type == 'promissory_note' %}
                    <span class="badge bg-success">手形貸付</span>
                  {% else %}
                    <span class="badge bg-primary">証書貸付</span>
                  {% endif %}
                </td>
                <td>{{ debt.principal|to_thousands|intcomma }}</td>
                <td>{{ debt.secured_type }}</td>
                <td>{{ debt.interest_rate }}%</td>
                <td>{{ debt.issue_date|date:"y年n月" }}</td>
                <td>{{ debt.start_date|date:"y年n月" }}</td>
                <td>{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td>{{ debt.balances_monthly.0|percentage:debt_list_totals.total_balances_monthly.0 }}</td>
                <td>{{ debt.remaining_months }}</td>
                <td>{{ debt.payment_terms }}</td>
                <td>{{ debt.balances_monthly.0|to_thousands|intcomma }}</td>
                <td>{{ debt.interest_amount_monthly.0|to_thousands|intcomma }}</td>
                <td>{{ debt.balance_fy1|to_thousands|intcomma }}</td>
                <td>
                  {% if debt.is_securedby_management %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-secondary">なし</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.is_collateraled %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-secondary">なし</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="2" style="text-align:right">合計：</th>
                <th>{{ bank_totals.principal|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>{{ bank_totals.monthly_repayment|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th>{{ bank_totals.balances_monthly.0|to_thousands|intcomma }}</th>
                <th></th>
                <th>{{ bank_totals.balance_fy1|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = new DataTable('#debt_list_byBank_detail_table', {
      responsive: true,
      scrollX: true,
      pageLength: 25,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
      },
      order: [[4, 'desc']], // 実行日で降順ソート
      pagingType: 'full_numbers',
      footerCallback: function (row, data, start, end, display) {
        let api = this.api();
        let intVal = function (i) {
          return typeof i === 'string'
            ? i.replace(/[\$,]/g, '') * 1
            : typeof i === 'number'
              ? i
              : 0;
        };
        
        // 元本の合計（列インデックスが1から2に変更）
        let principalTotal = api
          .column(2)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 月返済額の合計（列インデックスが6から7に変更）
        let monthlyRepaymentTotal = api
          .column(7)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 今月末残高の合計（列インデックスが10から11に変更）
        let balanceTotal = api
          .column(11)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 決算時残高の合計（列インデックスが12から13に変更）
        let balanceFy1Total = api
          .column(13)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // フッターに表示
        $(api.column(2).footer()).html(principalTotal.toLocaleString());
        $(api.column(7).footer()).html(monthlyRepaymentTotal.toLocaleString());
        $(api.column(11).footer()).html(balanceTotal.toLocaleString());
        $(api.column(13).footer()).html(balanceFy1Total.toLocaleString());
      }
    });

    // 行クリックで詳細ページに遷移
    table.on('draw', function () {
      const rows = document.querySelectorAll('#debt_list_byBank_detail_table tbody tr');
      rows.forEach(row => {
        row.addEventListener('click', function (e) {
          // リンクやボタンがクリックされた場合は無視
          if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
            return;
          }
          const href = this.getAttribute('data-href');
          if (href) {
            window.location.href = href;
          }
        });
        // ホバー時にカーソルをポインターに変更
        row.style.cursor = 'pointer';
      });
    });
  });
</script>
{% endblock %}

