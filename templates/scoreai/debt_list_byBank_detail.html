{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a class="text-muted text-decoration-none" href="{% url 'debts_byBank' %}">金融機関別一覧</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ financial_institution.short_name|default:"金融機関" }} - 借入一覧
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title fw-semibold mb-4">
          {{ financial_institution.short_name|default:"金融機関" }} - 借入一覧
        </h5>
        
        <div class="table-responsive">
          <table id="debt_list_byBank_detail_table" class="table table-striped table-bordered w-100">
            <thead>
              <tr>
                <th>ステータス</th>
                <th>元本(千円)</th>
                <th>保証</th>
                <th>利息</th>
                <th>実行日</th>
                <th>返済開始日</th>
                <th>月返済額</th>
                <th>残高シェア</th>
                <th>残り回数</th>
                <th>支払回数</th>
                <th>今月末残高</th>
                <th>今月概算利息</th>
                <th>決算時残高</th>
                <th>代表者保証</th>
                <th>担保</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list %}
              <tr>
                <td>
                  {% if debt.start_date <= today %}
                    <span class="badge bg-success">返済中</span>
                  {% else %}
                    <span class="badge bg-danger">返済前</span>
                  {% endif %}
                </td>
                <td>{{ debt.principal|to_thousands|intcomma }}</td>
                <td>{{ debt.secured_type }}</td>
                <td>{{ debt.interest_rate }}%</td>
                <td>{{ debt.issue_date|date:"y年n月" }}</td>
                <td>{{ debt.start_date|date:"y年n月" }}</td>
                <td>{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td>{{ debt.balances_monthly.0|percentage:debt_list_totals.total_balances_monthly.0 }}</td>
                <td>{{ debt.remaining_months }}</td>
                <td>{{ debt.payment_terms }}</td>
                <td>{{ debt.balances_monthly.0|to_thousands|intcomma }}</td>
                <td>{{ debt.interest_amount_monthly.0|to_thousands|intcomma }}</td>
                <td>{{ debt.balance_fy1|to_thousands|intcomma }}</td>
                <td>
                  {% if debt.is_securedby_management %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-secondary">なし</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.is_collateraled %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-secondary">なし</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'debt_detail' debt.id %}" class="btn btn-sm btn-primary">
                    <i class="ti ti-eye me-1"></i>詳細
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="1" style="text-align:right">合計：</th>
                <th>{{ bank_totals.principal|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>{{ bank_totals.monthly_repayment|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th>{{ bank_totals.balances_monthly.0|to_thousands|intcomma }}</th>
                <th></th>
                <th>{{ bank_totals.balance_fy1|to_thousands|intcomma }}</th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const table = new DataTable('#debt_list_byBank_detail_table', {
      scrollX: true,
      pageLength: 25,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
      },
      order: [[4, 'desc']], // 実行日で降順ソート
      pagingType: 'full_numbers',
      footerCallback: function (row, data, start, end, display) {
        let api = this.api();
        let intVal = function (i) {
          return typeof i === 'string'
            ? i.replace(/[\$,]/g, '') * 1
            : typeof i === 'number'
              ? i
              : 0;
        };
        
        // 元本の合計
        let principalTotal = api
          .column(1)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 月返済額の合計
        let monthlyRepaymentTotal = api
          .column(6)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 今月末残高の合計
        let balanceTotal = api
          .column(10)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // 決算時残高の合計
        let balanceFy1Total = api
          .column(12)
          .data()
          .reduce((a, b) => intVal(a) + intVal(b), 0);
        
        // フッターに表示
        $(api.column(1).footer()).html(principalTotal.toLocaleString());
        $(api.column(6).footer()).html(monthlyRepaymentTotal.toLocaleString());
        $(api.column(10).footer()).html(balanceTotal.toLocaleString());
        $(api.column(12).footer()).html(balanceFy1Total.toLocaleString());
      }
    });
  });
</script>
{% endblock %}

