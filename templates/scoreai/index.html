{% extends "scoreai/base.html" %}
{% load static %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'scoreai/js/chart_colors.js' %}"></script>
<!-- ApexCharts (CDNから読み込み) -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
<!-- ダッシュボードスタイル（Pencil Design System） -->
<link rel="stylesheet" href="{% static 'scoreai/css/dashboard-pencil.css' %}">
<!-- Chart.js Pencil Design System -->
<link rel="stylesheet" href="{% static 'scoreai/css/chart-pencil.css' %}">
<!-- ApexCharts Pencil Design System -->
<link rel="stylesheet" href="{% static 'scoreai/css/apexcharts-pencil.css' %}">
<script src="{% static 'scoreai/js/dashboard.js' %}"></script>

{% endblock %}

{% block content %}
  <!-- Page Header（Pencil Design System W7t1x準拠） -->
  <div class="dashboard-page-header mb-4">
    <div class="dashboard-title-area">
      <h1 class="dashboard-title">{{ title }}</h1>
      <p class="dashboard-subtitle">財務状況の概要を確認できます</p>
    </div>
  </div>

  <!-- KPIカードセクション（最上部） -->
  {% include 'scoreai/index-row_kpi_cards.html' %}

  <!-- 月次売上推移とサイドバー -->
  {% include 'scoreai/index-row_salesoverview.html' %}

  <!-- 予算実績比較 -->
  {% include 'scoreai/budget_vs_actual_dashboard.html' %}

  <!-- 借入分析 -->
  {% include 'scoreai/index-row_debts.html' %}

  <!-- To Doセクション -->
  {% include 'scoreai/index-row_todos.html' %}

  <!-- 最近のノート・お知らせ・通知セクション（Pencil Design System準拠） -->
  <!-- 1Row目：最近のノート -->
  <div class="row g-4 dashboard-section mt-4">
    <div class="col-12">
      <div class="card pencil-news-card">
        <div class="card-header">
          <h5 class="card-title">最近のノート</h5>
          <p class="card-subtitle">議事録・メモ</p>
        </div>
        <div class="card-body">
          {% if recent_notes %}
          {% for note in recent_notes %}
          <div class="pencil-article-item">
            <div class="pencil-article-image feature"></div>
            <div class="pencil-article-content">
              <a href="{% url 'meeting_minutes_detail' this_company.id note.pk %}" class="text-decoration-none">
                <p class="pencil-article-title">{{ note.meeting_date|date:"Y年m月d日" }} - {{ note.notes|truncatewords:8 }}</p>
              </a>
              <div class="pencil-article-meta">
                <span class="pencil-article-tag feature">{{ note.get_category_display }}</span>
                <span class="pencil-article-date">{{ note.created_by.username }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
          <div class="mt-3 text-center">
            <a href="{% url 'meeting_minutes_list' %}" class="btn btn-sm btn-outline-secondary">
              <i class="ti ti-arrow-right me-1"></i>すべてのノートを見る
            </a>
          </div>
          {% else %}
          <p class="text-muted mb-0 text-center py-3">ノートがありません。</p>
          <div class="text-center mt-3">
            <a href="{% url 'meeting_minutes_create' %}" class="btn btn-sm btn-primary">
              <i class="ti ti-plus me-1"></i>ノートを作成
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 2Row目：お知らせと通知（2列）- Pencil Design System準拠 -->
  <div class="row g-4 dashboard-section mt-4 pencil-news-row">
    <!-- お知らせ (articlesCard from pencil) -->
    <div class="col-12 col-md-6">
      <div class="card h-100 pencil-news-card">
        <div class="card-header">
          <h5 class="card-title">最近のお知らせ</h5>
          <p class="card-subtitle">重要なお知らせ</p>
        </div>
        <div class="card-body">
          {% if recent_announcements %}
          {% for announcement in recent_announcements %}
          <div class="pencil-article-item">
            <div class="pencil-article-image {% if announcement.categories.first.name == '税務' %}tax{% elif announcement.categories.first.name == 'お知らせ' %}notice{% else %}feature{% endif %}"></div>
            <div class="pencil-article-content">
              <a href="{% url 'announcement_detail' announcement.pk %}" class="text-decoration-none">
                <p class="pencil-article-title">{{ announcement.title|truncatewords:10 }}</p>
              </a>
              <div class="pencil-article-meta">
                {% if announcement.categories.first %}
                <span class="pencil-article-tag {% if announcement.categories.first.name == '税務' %}tax{% elif announcement.categories.first.name == 'お知らせ' %}notice{% else %}feature{% endif %}">{{ announcement.categories.first.name }}</span>
                {% endif %}
                <span class="pencil-article-date">{{ announcement.post_date|date:"Y/m/d" }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
          <div class="mt-3 text-center">
            <a href="{% url 'announcement_list' %}" class="btn btn-sm btn-outline-secondary">
              <i class="ti ti-arrow-right me-1"></i>すべてのお知らせを見る
            </a>
          </div>
          {% else %}
          <p class="text-muted mb-0 text-center py-3">お知らせがありません。</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- 通知 (newsCard from pencil) -->
    <div class="col-12 col-md-6">
      <div class="card h-100 pencil-news-card">
        <div class="card-header">
          <h5 class="card-title">最近の通知</h5>
          <p class="card-subtitle">システム通知</p>
        </div>
        <div class="card-body">
          {% if recent_notifications %}
          {% for notification in recent_notifications %}
          <div class="pencil-notification-item">
            <div class="pencil-notification-icon {% if notification.notification_type == 'plan_limit_warning' or notification.notification_type == 'grace_period_ending' %}warning{% elif notification.notification_type == 'payment_failed' %}error{% elif notification.notification_type == 'subscription_updated' %}info{% else %}success{% endif %}">
              <i class="ti {% if notification.notification_type == 'plan_limit_warning' or notification.notification_type == 'grace_period_ending' %}ti-alert-triangle{% elif notification.notification_type == 'payment_failed' %}ti-alert-circle{% elif notification.notification_type == 'subscription_updated' %}ti-info-circle{% else %}ti-check{% endif %}"></i>
            </div>
            <div class="pencil-notification-content">
              <a href="{% url 'notification_detail' firm_id=notification.firm.id notification_id=notification.id %}" class="text-decoration-none">
                <p class="pencil-notification-title">{% if not notification.is_read %}<span class="badge bg-danger me-1" style="font-size: 9px;">未読</span>{% endif %}{{ notification.title }}</p>
              </a>
              <span class="pencil-notification-date">{{ notification.created_at|date:"Y年m月d日" }}</span>
            </div>
          </div>
          {% endfor %}
          {% load custom_tags %}
          {% get_user_firm_owner user as user_firm_owner %}
          {% if user_firm_owner %}
          <div class="mt-3 text-center">
            <a href="{% url 'notification_list' firm_id=user_firm_owner.firm.id %}" class="btn btn-sm btn-outline-secondary">
              <i class="ti ti-arrow-right me-1"></i>すべての通知を見る
            </a>
          </div>
          {% endif %}
          {% else %}
          <p class="text-muted mb-0 text-center py-3">通知がありません。</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

{% endblock %}

