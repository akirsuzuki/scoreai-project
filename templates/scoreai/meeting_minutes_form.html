{% extends "scoreai/base.html" %}
{% load crispy_forms_tags %}
{% load custom_filters %}
{% load custom_tags %}
{% load plan_features_tags %}

{% block title %}
{% if form.instance.pk %}ミーティングノート編集{% else %}新規ミーティングノート作成{% endif %}
{% endblock %}

{% block head %}
<style>
.markdown-preview {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  padding: 1rem;
  min-height: 200px;
  background-color: #f8f9fa;
  margin-top: 1rem;
}
.markdown-preview h1,
.markdown-preview h2,
.markdown-preview h3,
.markdown-preview h4,
.markdown-preview h5,
.markdown-preview h6 {
  margin-top: 1.5rem;
  margin-bottom: 1rem;
  font-weight: 600;
}
.markdown-preview p {
  margin-bottom: 1rem;
}
.markdown-preview ul,
.markdown-preview ol {
  margin-bottom: 1rem;
  padding-left: 2rem;
}
.markdown-preview blockquote {
  border-left: 4px solid #5D87FF;
  padding-left: 1rem;
  margin-left: 0;
  color: #6c757d;
  font-style: italic;
}
.markdown-preview code {
  background-color: #ffffff;
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
  font-size: 0.9em;
}
.markdown-preview pre {
  background-color: #ffffff;
  padding: 1rem;
  border-radius: 5px;
  overflow-x: auto;
}
.markdown-preview pre code {
  background-color: transparent;
  padding: 0;
}
.markdown-preview table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1rem;
}
.markdown-preview table th,
.markdown-preview table td {
  border: 1px solid #dee2e6;
  padding: 0.75rem;
  text-align: left;
}
.markdown-preview table th {
  background-color: #ffffff;
  font-weight: 600;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const notesField = document.querySelector('#id_notes');
  const previewArea = document.getElementById('markdown-preview');
  const categoryField = document.querySelector('#id_category');
  const aiSuggestionMessage = document.getElementById('ai-suggestion-message');
  
  // AI議事録生成を勧めるカテゴリ
  const aiRecommendedCategories = ['shareholders', 'board', 'management'];
  
  // カテゴリ選択時の処理
  if (categoryField && aiSuggestionMessage) {
    function checkCategory() {
      const selectedCategory = categoryField.value;
      if (aiRecommendedCategories.includes(selectedCategory)) {
        aiSuggestionMessage.style.display = 'block';
      } else {
        aiSuggestionMessage.style.display = 'none';
      }
    }
    
    // カテゴリ変更時にチェック
    categoryField.addEventListener('change', checkCategory);
    
    // 初期状態をチェック（編集時など）
    checkCategory();
  }
  
  if (notesField && previewArea) {
    // プレビューを更新する関数
    function updatePreview() {
      const text = notesField.value;
      if (text.trim()) {
        // 簡単なMarkdownプレビュー（実際のレンダリングはサーバー側で行う）
        // ここでは基本的な変換のみ
        let html = text
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`(.*?)`/g, '<code>$1</code>');
        previewArea.innerHTML = html;
        previewArea.style.display = 'block';
      } else {
        previewArea.style.display = 'none';
      }
    }
    
    // 入力時にプレビューを更新
    notesField.addEventListener('input', updatePreview);
    
    // 初期プレビュー
    updatePreview();
  }
});
</script>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">ノート（議事録）</h4>
    <p class="text-muted mb-0">議事録の作成、管理、AI生成を行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'meeting_minutes_list' %}" role="tab">
          <i class="ti ti-notes me-1"></i>ノート一覧
        </a>
      </li>
      {% get_user_selected_company user as selected_company %}
      {% if selected_company %}
        {% get_company_firm_for_plan_check selected_company as company_firm %}
        {% if company_firm %}
          {% check_plan_feature_access_tag company_firm 'starter' as plan_check %}
          {% if plan_check.0 %}
          <li class="nav-item" role="presentation">
            <a class="nav-link" href="{% url 'meeting_minutes_ai_generate' %}" role="tab">
              <i class="ti ti-sparkles me-1"></i>AI議事録生成
            </a>
          </li>
          {% endif %}
        {% endif %}
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{% url 'meeting_minutes_create' %}" role="tab">
          <i class="ti ti-plus me-1"></i>新規登録
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'meeting_minutes_import' %}" role="tab">
          <i class="ti ti-upload me-1"></i>インポート
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="meetingMinutesTabsContent">
  <!-- 新規登録 -->
  <div class="tab-pane fade show active" id="meeting-minutes-create" role="tabpanel">
    <div class="row mb-3">
      <div class="col-12">
        <div class="alert alert-light border">
          <i class="ti ti-info-circle me-2 text-primary"></i>
          <strong>新規登録</strong>では、新しい議事録を登録できます。
        </div>
      </div>
    </div>
<div class="row">
    <div class="col-lg-12">
        <form method="post" novalidate>
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        {% if form.instance.pk %}
                        ミーティングノート編集
                        {% else %}
                        新規ミーティングノート作成
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="card-body">
                        {% csrf_token %}
                        {# Form-level errors #}
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {# Hidden fields for company and created_by #}
                        {{ form.company }}
                        {{ form.created_by }}
                        {% if form.company.errors %}
                            <div class="text-danger">{{ form.company.errors }}</div>
                        {% endif %}
                        {% if form.created_by.errors %}
                            <div class="text-danger">{{ form.created_by.errors }}</div>
                        {% endif %}
                        <div class="mb-3">
                            <label for="{{ form.meeting_date.id_for_label }}" class="form-label">{{ form.meeting_date.label }}</label>
                            {{ form.meeting_date }}
                            {% if form.meeting_date.errors %}
                                <div class="text-danger">{{ form.meeting_date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="text-danger">{{ form.category.errors }}</div>
                            {% endif %}
                            <div id="ai-suggestion-message" class="alert alert-info mt-2" class="d-none">
                                <i class="ti ti-sparkles me-2"></i>
                                <strong>AI議事録生成をご利用ください</strong><br>
                                このカテゴリの議事録は、AIによる自動生成が可能です。
                                <a href="{% url 'meeting_minutes_ai_generate' %}" class="alert-link ms-2">
                                    <i class="ti ti-arrow-right me-1"></i>AI議事録生成を開始
                                </a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                {{ form.notes.label }}
                                <small class="text-muted">（Markdown形式が使用できます）</small>
                            </label>
                            {{ form.notes }}
                            {% if form.notes.help_text %}
                                <small class="form-text text-muted">{{ form.notes.help_text }}</small>
                            {% endif %}
                            {% if form.notes.errors %}
                                <div class="text-danger">{{ form.notes.errors }}</div>
                            {% endif %}
                            <div class="markdown-preview" id="markdown-preview" class="d-none"></div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        {% if form.instance.pk %}
                        更新
                        {% else %}
                        作成
                        {% endif %}
                    </button>
                    {% if form.instance.pk %}
                    <a href="{% url 'meeting_minutes_delete' this_company form.instance.pk %}" class="btn btn-danger" onclick="return confirm('本当に削除しますか？');">削除</a>
                    {% endif %}
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">キャンセル</button>
                </div>
            </div>
        </form>
    </div>
</div>
  </div>
</div>
{% endblock %}