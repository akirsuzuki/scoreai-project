{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
 <!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'scoreai/js/chart_colors.js' %}"></script>

{% endblock %}

{% block breadcrumb %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="fw-semibold mb-0">決算年次推移</h4>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'fiscal_summary_year_list' %}?is_draft=false" class="btn {% if request.GET.is_draft != 'true' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">決算年次推移</a>
        <a href="{% url 'latest_fiscal_summary_year_detail' %}" class="btn btn-outline-primary btn-sm">直近決算詳細</a>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">

{% include 'scoreai/fiscal_summary_year_list_table.html' %}

{% include 'scoreai/fiscal_summary_year_list_chart.html' %}

{% include 'scoreai/budget_vs_actual_dashboard.html' %}


<!-- カード本体の終了タグの直前に JavaScript を追加 -->
<script>
  function toggleDrafts(checkbox) {
      const url = new URL(window.location.href);
      if (checkbox.checked) {
          url.searchParams.set('is_draft', 'true');
      } else {
          url.searchParams.set('is_draft', 'false');
      }
      window.location.href = url.toString();
  }
  
  // ページ読み込み時に下書きデータの表示状態を設定
  document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const isDraft = urlParams.get('is_draft');
      document.getElementById('showDrafts').checked = isDraft === 'true';
  });

  // ページパラメータを更新する関数（年次決算推移で利用）
  function updatePageParam(page) {
    const url = new URL(window.location.href);
    url.searchParams.set('page_param', page);
    window.location.href = url.toString();
  }

  function updateYearsInPage(years) {
    const url = new URL(window.location.href);
    if (years === 'all') {
      url.searchParams.set('show_all', 'true');
      url.searchParams.delete('years_in_page');
      url.searchParams.delete('page_param');
    } else {
      url.searchParams.set('years_in_page', years);
      url.searchParams.set('show_all', 'false');
      url.searchParams.set('page_param', 1); // Reset to first page
    }
    window.location.href = url.toString();
  }

  function applyYearRange() {
    const url = new URL(window.location.href);
    const startYear = document.getElementById('startYear').value;
    const endYear = document.getElementById('endYear').value;
    
    if (startYear) {
      url.searchParams.set('start_year', startYear);
    } else {
      url.searchParams.delete('start_year');
    }
    
    if (endYear) {
      url.searchParams.set('end_year', endYear);
    } else {
      url.searchParams.delete('end_year');
    }
    
    url.searchParams.set('page_param', 1); // Reset to first page
    window.location.href = url.toString();
  }
</script>
{% endblock %}