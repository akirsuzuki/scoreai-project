{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">Firm管理</h4>
    <p class="text-muted mb-0">Firmの設定とメンバー管理を行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_settings' firm_id=firm.id %}" role="tab">
          <i class="ti ti-settings me-1"></i>Firm設定
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_member_list' firm_id=firm.id %}" role="tab">
          <i class="ti ti-users me-1"></i>スタッフ管理
        </a>
      </li>
      {% load custom_tags %}
      {% get_user_firm_owner user as user_firm_owner %}
      {% if user_firm_owner %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_clientslist' %}" role="tab">
          <i class="ti ti-building me-1"></i>クライアント一覧
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'subscription_manage' firm_id=firm.id %}" role="tab">
          <i class="ti ti-credit-card me-1"></i>サブスクリプション管理
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{% url 'usage_report' firm_id=firm.id %}" role="tab">
          <i class="ti ti-chart-line me-1"></i>利用状況レポート
        </a>
      </li>
      {% if user_firm_owner %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'billing_history' firm_id=firm.id %}" role="tab">
          <i class="ti ti-file-invoice me-1"></i>請求管理
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'notification_list' firm_id=firm.id %}" role="tab">
          <i class="ti ti-bell me-1"></i>通知
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="firmManagementTabsContent">
  <!-- 利用状況レポート -->
  <div class="tab-pane fade show active" id="usage-report" role="tabpanel">
    <div class="row">
      <div class="col-12 mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div></div>
          <div class="d-flex gap-2">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="ti ti-download me-1"></i>エクスポート
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{% url 'usage_report_export' firm_id=firm.id %}?format=csv&months={{ months }}">
              <i class="ti ti-file-text me-2"></i>CSV形式
            </a></li>
            <li><a class="dropdown-item" href="{% url 'usage_report_export' firm_id=firm.id %}?format=excel&months={{ months }}">
              <i class="ti ti-file-spreadsheet me-2"></i>Excel形式
            </a></li>
            <li><a class="dropdown-item" href="{% url 'usage_report_export' firm_id=firm.id %}?format=pdf&months={{ months }}">
              <i class="ti ti-file-type-pdf me-2"></i>PDF形式
            </a></li>
          </ul>
        </div>
        <a href="{% url 'subscription_manage' firm_id=firm.id %}" class="btn btn-secondary">
          <i class="ti ti-arrow-left me-1"></i>戻る
        </a>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0 fw-semibold">利用状況グラフ</h5>
          <div class="d-flex align-items-center gap-2">
            <label for="months" class="form-label mb-0">表示期間:</label>
            <select id="months" class="form-select form-select-sm" style="width: 100px;" onchange="updateMonths(this.value)">
              <option value="3" {% if months == 3 %}selected{% endif %}>3ヶ月</option>
              <option value="6" {% if months == 6 %}selected{% endif %}>6ヶ月</option>
              <option value="12" {% if months == 12 %}selected{% endif %}>12ヶ月</option>
              <option value="24" {% if months == 24 %}selected{% endif %}>24ヶ月</option>
            </select>
          </div>
        </div>
      </div>
      <div class="card-body">
        <canvas id="usageChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">利用状況一覧</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table text-nowrap mb-0 align-middle">
            <thead class="text-dark fs-4">
              <tr>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">年月</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">AI相談回数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">OCR読み込み回数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">AI相談トークン数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">操作</h6>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for row in usage_data.table_data %}
              <tr>
                <td class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">{{ row.label }}</h6>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ row.ai_consultation|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ row.ocr|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ row.tokens|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  {% if row.ai_consultation > 0 %}
                  <button type="button" 
                          class="btn btn-sm btn-outline-primary company-usage-btn" 
                          data-bs-toggle="modal" 
                          data-bs-target="#companyUsageModal"
                          data-year="{{ row.year }}"
                          data-month="{{ row.month }}"
                          data-label="{{ row.label }}">
                    クライアント別
                  </button>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% if company_usage %}
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">Company別利用状況（過去{{ months }}ヶ月）</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table text-nowrap mb-0 align-middle">
            <thead class="text-dark fs-4">
              <tr>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">Company名</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">AI相談回数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">OCR読み込み回数</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">合計</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">操作</h6>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for company in company_usage %}
              <tr>
                <td class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">{{ company.company_name }}</h6>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ company.ai_consultation|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ company.ocr|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ company.total|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  <a href="{% url 'company_usage_report' firm_id=firm.id company_id=company.company_id %}" class="btn btn-sm btn-outline-primary">
                    詳細
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- クライアント別利用状況モーダル -->
<div class="modal fade" id="companyUsageModal" tabindex="-1" aria-labelledby="companyUsageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="companyUsageModalLabel">クライアント別AI相談回数</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="companyUsageLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">読み込み中...</span>
          </div>
        </div>
        <div id="companyUsageContent" style="display: none;">
          <h6 class="mb-3" id="companyUsageMonthLabel"></h6>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Company名</th>
                  <th class="text-end">AI相談回数</th>
                </tr>
              </thead>
              <tbody id="companyUsageTableBody">
              </tbody>
            </table>
          </div>
          <div id="companyUsageEmpty" class="alert alert-info" style="display: none;">
            <i class="ti ti-info-circle me-2"></i>この月のクライアント別データはありません。
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<script>
const chartData = {{ chart_data|safe }};

const ctx = document.getElementById('usageChart').getContext('2d');
const usageChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: chartData.labels,
    datasets: [
      {
        label: 'AI相談回数',
        data: chartData.ai_consultation,
        borderColor: 'rgb(93, 135, 255)',
        backgroundColor: 'rgba(93, 135, 255, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y',
      },
      {
        label: 'OCR読み込み回数',
        data: chartData.ocr,
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y',
      },
      {
        label: 'AI相談トークン数',
        data: chartData.tokens,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        tension: 0.4,
        fill: true,
        yAxisID: 'y1',
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      title: {
        display: false,
      }
    },
    scales: {
      y: {
        type: 'linear',
        display: true,
        position: 'left',
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        title: {
          display: true,
          text: '回数'
        }
      },
      y1: {
        type: 'linear',
        display: true,
        position: 'right',
        beginAtZero: true,
        grid: {
          drawOnChartArea: false,
        },
        title: {
          display: true,
          text: 'トークン数'
        }
      }
    }
  }
});

function updateMonths(months) {
  const url = new URL(window.location.href);
  url.searchParams.set('months', months);
  window.location.href = url.toString();
}

// クライアント別利用状況を読み込む
function loadCompanyUsage(year, month, label) {
  const loading = document.getElementById('companyUsageLoading');
  const content = document.getElementById('companyUsageContent');
  const empty = document.getElementById('companyUsageEmpty');
  const tableBody = document.getElementById('companyUsageTableBody');
  const monthLabel = document.getElementById('companyUsageMonthLabel');
  
  // 表示をリセット
  loading.style.display = 'block';
  content.style.display = 'none';
  empty.style.display = 'none';
  monthLabel.textContent = label;
  tableBody.innerHTML = '';
  
  // AJAXでデータを取得
  fetch(`{% url 'monthly_company_usage_api' firm.id %}?year=${year}&month=${month}`)
    .then(response => response.json())
    .then(data => {
      loading.style.display = 'none';
      
      if (data.company_usage && data.company_usage.length > 0) {
        content.style.display = 'block';
        
        data.company_usage.forEach(function(company) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${company.company_name}</td>
            <td class="text-end">${parseInt(company.ai_consultation).toLocaleString()}</td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        empty.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      loading.style.display = 'none';
      empty.style.display = 'block';
      empty.innerHTML = '<i class="ti ti-alert-circle me-2"></i>データの取得に失敗しました。';
    });
}

// クライアント別ボタンがクリックされたときにデータを読み込む
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('companyUsageModal');
  const companyUsageButtons = document.querySelectorAll('.company-usage-btn');
  
  companyUsageButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      const year = parseInt(this.getAttribute('data-year'));
      const month = parseInt(this.getAttribute('data-month'));
      const label = this.getAttribute('data-label');
      
      // モーダルが開かれたときにデータを読み込む
      modal.addEventListener('shown.bs.modal', function onModalShown() {
        loadCompanyUsage(year, month, label);
        modal.removeEventListener('shown.bs.modal', onModalShown);
      }, { once: true });
    });
  });
  
  // モーダルが閉じられたときにテーブルをクリア
  modal.addEventListener('hidden.bs.modal', function() {
    document.getElementById('companyUsageTableBody').innerHTML = '';
    document.getElementById('companyUsageContent').style.display = 'none';
    document.getElementById('companyUsageLoading').style.display = 'block';
    document.getElementById('companyUsageEmpty').style.display = 'none';
  });
});
</script>
  </div>
  <!-- End of tab-pane -->
</div>
<!-- End of tab-content -->
{% endblock %}

