{% load humanize %}
{% load custom_filters %}
<!-- Styles moved to pencil-design-system.css -->

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">年次推移表</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="d-flex justify-content-end align-items-center flex-wrap gap-3 mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="showDrafts" onchange="toggleDrafts(this)" {% if is_draft %}checked{% endif %}>
              <label class="form-check-label" for="showDrafts">
                下書きデータも表示
              </label>
              <p class="small mb-0">下のチャートも同時に反映します。</p>
            </div>
          </div>
        </div>
        <div class="fiscal-summary-table-container">
          <table class="table table-bordered" id="fiscal_summary_table">
            <thead class="table-light">
              <tr>
                <th>項目</th>
                {% for summary in fiscal_summary_years reversed %}
                <th class="text-center">{{ summary.year }}年度
                {% if summary.is_draft %}<i class="fas fa-pencil-alt text-danger" title="下書き"></i>{% endif %}
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody class="table-group-divider">
              <tr>
                <td>現預金</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.cash_and_deposits|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>固定資産合計</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.total_fixed_assets|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>長期借入金</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.long_term_loans_payable|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>純資産合計</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.total_net_assets|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>総資産</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.total_assets|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td colspan="{{ fiscal_summary_years|length|add:1 }}" class="pencil-table-divider"></td>
              </tr>              
              <tr>
                <td>売上高合計</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.sales|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>売上総利益</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.gross_profit|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>営業利益</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.operating_profit|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>経常利益</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.ordinary_profit|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>EBITDA</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.EBITDA|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td>繰越欠損金</td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-end">{{ summary.tax_loss_carryforward|intcomma }}</td>
                {% endfor %}
              </tr>
              <tr>
                <td></td>
                {% for summary in fiscal_summary_years reversed %}
                <td class="text-center">
                  <a href="{% url 'fiscal_summary_year_detail' summary.id %}" class="btn btn-sm btn-info"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                </td>
                {% endfor %}
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="{{ fiscal_summary_years|length|add:1 }}">
                  <p class="text-muted small mb-0">単位は千円です。</p>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        {% if not show_all %}
        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% if page_param > 1 %}
            <li class="page-item">
              <a class="page-link" href="javascript:void(0);" onclick="updatePageParam({{ page_param|add:'-1' }})" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% endif %}
            {% for num in 1|to:total_pages %}
            <li class="page-item {% if page_param == num %}active{% endif %}">
              <a class="page-link" href="javascript:void(0);" onclick="updatePageParam({{ num }})">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_param < total_pages %}
            <li class="page-item">
              <a class="page-link" href="javascript:void(0);" onclick="updatePageParam({{ page_param|add:'1' }})" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
      <div class="card-footer">
        <div class="btn-group" role="group">
          <a href="{% url 'fiscal_summary_year_create' %}" class="btn btn-primary">新規決算データ作成</a>
          <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" id="newDataDropdown">
            <span class="visually-hidden">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="newDataDropdown">
            <li><a class="dropdown-item" href="{% url 'fiscal_summary_year_budget_create' %}">
              <i class="ti ti-calendar-dollar me-2"></i>予算データ作成
            </a></li>
            <li><a class="dropdown-item" href="{% url 'budget_suggest' %}">
              <i class="ti ti-sparkles me-2"></i>AI予算サジェスト
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'budget_vs_actual_comparison' %}">
              <i class="ti ti-chart-line me-2"></i>予算実績比較
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

