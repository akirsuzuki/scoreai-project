{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}
{% load custom_tags %}
<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">Firm管理</h4>
    <p class="text-muted mb-0">Firmの設定とメンバー管理を行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_settings' firm_id=firm.id %}" role="tab">
          <i class="ti ti-settings me-1"></i>Firm設定
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_member_list' firm_id=firm.id %}" role="tab">
          <i class="ti ti-users me-1"></i>スタッフ管理
        </a>
      </li>
      {% load custom_tags %}
      {% get_user_firm_owner user as user_firm_owner %}
      {% if user_firm_owner %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_clientslist' %}" role="tab">
          <i class="ti ti-building me-1"></i>クライアント一覧
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'firm_todo_list' firm_id=firm.id %}" role="tab">
          <i class="ti ti-checkbox me-1"></i>To Do一覧
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'subscription_manage' firm_id=firm.id %}" role="tab">
          <i class="ti ti-credit-card me-1"></i>サブスクリプション管理
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'usage_report' firm_id=firm.id %}" role="tab">
          <i class="ti ti-chart-line me-1"></i>利用状況レポート
        </a>
      </li>
      {% if user_firm_owner %}
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{% url 'billing_history' firm_id=firm.id %}" role="tab">
          <i class="ti ti-file-invoice me-1"></i>請求管理
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'notification_list' firm_id=firm.id %}" role="tab">
          <i class="ti ti-bell me-1"></i>通知
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="clientManagementTabsContent">
  <!-- 請求管理 -->
  <div class="tab-pane fade show active" id="billing-history" role="tabpanel">

<!-- 支払い方法 -->
{% if payment_method %}
<div class="row mb-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">支払い方法</h5>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            {% if payment_method.type == 'card' and payment_method.card %}
            <p class="mb-1">
              <i class="ti ti-credit-card me-2"></i>
              <strong>カード</strong>
            </p>
            <p class="text-muted mb-0">
              **** **** **** {{ payment_method.card.last4 }}
              ({{ payment_method.card.brand|upper }})
            </p>
            {% if payment_method.card.exp_month and payment_method.card.exp_year %}
            <p class="text-muted small mb-0">
              有効期限: {{ payment_method.card.exp_month }}/{{ payment_method.card.exp_year }}
            </p>
            {% endif %}
            {% else %}
            <p class="mb-0 text-muted">支払い方法が設定されていません</p>
            {% endif %}
          </div>
          <div>
            <a href="{% url 'payment_method_update' firm_id=firm.id %}" class="btn btn-outline-primary">
              <i class="ti ti-edit me-1"></i>支払い方法を変更
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- 請求書一覧 -->
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">請求書一覧</h5>
      </div>
      <div class="card-body">
        {% if invoices %}
        <div class="table-responsive">
          <table class="table text-nowrap mb-0 align-middle">
            <thead class="text-dark fs-4">
              <tr>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">請求書番号</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">請求期間</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">金額</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">ステータス</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">発行日</h6>
                </th>
                <th class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">操作</h6>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
              <tr>
                <td class="border-bottom-0">
                  <h6 class="fw-semibold mb-0">{{ invoice.number|default:invoice.id }}</h6>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">
                    {% if invoice.period_start and invoice.period_end %}
                    {{ invoice.period_start|date:"Y/m/d" }} 〜 {{ invoice.period_end|date:"Y/m/d" }}
                    {% else %}
                    -
                    {% endif %}
                  </p>
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">¥{{ invoice.total|floatformat:0|intcomma }}</p>
                </td>
                <td class="border-bottom-0">
                  {% if invoice.status == 'paid' %}
                  <span class="badge bg-success">支払済み</span>
                  {% elif invoice.status == 'open' %}
                  <span class="badge bg-warning">未払い</span>
                  {% elif invoice.status == 'void' %}
                  <span class="badge bg-secondary">無効</span>
                  {% else %}
                  <span class="badge bg-danger">{{ invoice.status }}</span>
                  {% endif %}
                </td>
                <td class="border-bottom-0">
                  <p class="mb-0 fw-normal">{{ invoice.created|date:"Y年m月d日" }}</p>
                </td>
                <td class="border-bottom-0">
                  <div class="d-flex gap-2">
                    {% if invoice.invoice_pdf %}
                    <a href="{% url 'billing_invoice_detail' firm_id=firm.id invoice_id=invoice.id %}" 
                       class="btn btn-sm btn-outline-primary"
                       title="PDFダウンロード">
                      <i class="ti ti-download"></i>
                      <span>PDF</span>
                    </a>
                    {% endif %}
                    {% if invoice.hosted_invoice_url %}
                    <a href="{{ invoice.hosted_invoice_url }}" 
                       target="_blank"
                       class="btn btn-sm btn-outline-info"
                       title="Stripeで表示">
                      <i class="ti ti-external-link"></i>
                      <span>表示</span>
                    </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="ti ti-file-off pencil-empty-icon"></i>
          <p class="text-muted mt-3 mb-0">請求書がありません</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

