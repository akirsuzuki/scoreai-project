{% extends "scoreai/base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load custom_tags %}
{% load plan_features_tags %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<style>
/* ローディングオーバーレイ */
.ai-loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  flex-direction: column;
}

.ai-loading-overlay.show {
  display: flex;
}

.ai-loading-content {
  text-align: center;
  max-width: 400px;
  padding: 40px;
}

/* AIアイコンのアニメーション */
.ai-thinking-icon {
  width: 120px;
  height: 120px;
  margin: 0 auto 24px;
  position: relative;
}

.ai-brain {
  font-size: 64px;
  color: var(--primary);
  animation: pulse 1.5s ease-in-out infinite;
}

.ai-sparkles {
  position: absolute;
  font-size: 24px;
  color: #fbbf24;
  animation: sparkle 1s ease-in-out infinite;
}

.ai-sparkles:nth-child(2) {
  top: 10px;
  right: 15px;
  animation-delay: 0.2s;
}

.ai-sparkles:nth-child(3) {
  top: 30px;
  left: 10px;
  animation-delay: 0.4s;
}

.ai-sparkles:nth-child(4) {
  bottom: 20px;
  right: 20px;
  animation-delay: 0.6s;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.8;
  }
}

@keyframes sparkle {
  0%, 100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
  50% {
    transform: scale(1.3) rotate(180deg);
    opacity: 0.5;
  }
}

/* ドットアニメーション */
.loading-dots {
  display: inline-flex;
  gap: 8px;
  margin-top: 16px;
}

.loading-dots span {
  width: 12px;
  height: 12px;
  background: var(--primary);
  border-radius: 50%;
  animation: bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) {
  animation-delay: -0.32s;
}

.loading-dots span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes bounce {
  0%, 80%, 100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}

.ai-loading-text {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 8px;
}

.ai-loading-subtext {
  font-size: 0.9rem;
  color: #64748b;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const meetingTypeSelect = document.getElementById('id_meeting_type');
    const agendaSelect = document.getElementById('id_agenda');
    
    const agendaChoices = {
        'shareholders_meeting': [
            ['financial_approval', '決算承認: 計算書類および事業報告の承認'],
            ['officer_election', '役員選任: 取締役・監査役の選任（任期満了や増員）'],
            ['surplus_disposition', '剰余金処分: 配当の決定'],
            ['articles_amendment', '定款変更: 商号変更や事業目的の追加'],
        ],
        'board_of_directors': [
            ['representative_director', '代表取締役の選定: 役職の決定'],
            ['asset_disposition', '重要な財産の処分: 資産の売却や多額の借入'],
            ['meeting_convening', '招集決定: 株主総会の開催日時・場所の決定'],
            ['new_shares', '新株発行: 資金調達（増資）に関する決定'],
        ],
        'management_committee': [
            ['business_strategy', '事業戦略の検討'],
            ['budget_approval', '予算の承認'],
            ['organization_change', '組織変更の決定'],
            ['other', 'その他'],
        ],
    };
    
    function updateAgendaChoices() {
        const selectedType = meetingTypeSelect.value;
        const choices = agendaChoices[selectedType] || [];
        
        // 現在選択されている値を保存
        const currentValue = agendaSelect.value;
        
        // 既存の選択肢をクリア
        agendaSelect.innerHTML = '';
        
        // 新しい選択肢を追加
        choices.forEach(function(choice) {
            const option = document.createElement('option');
            option.value = choice[0];
            option.textContent = choice[1];
            // 以前の選択値と一致する場合は選択状態にする
            if (currentValue === choice[0]) {
                option.selected = true;
            }
            agendaSelect.appendChild(option);
        });
        
        // 選択値が新しい選択肢にない場合は、最初の選択肢を選択
        if (currentValue && !choices.find(c => c[0] === currentValue)) {
            if (choices.length > 0) {
                agendaSelect.value = choices[0][0];
            }
        }
    }
    
    meetingTypeSelect.addEventListener('change', updateAgendaChoices);
    
    // 初期化
    updateAgendaChoices();
    
    // フォーム送信時にローディング表示
    const form = document.querySelector('form');
    const loadingOverlay = document.getElementById('aiLoadingOverlay');
    
    form.addEventListener('submit', function(e) {
        // ローディングオーバーレイを表示
        loadingOverlay.classList.add('show');
        
        // ボタンを無効化
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ti ti-loader me-1"></i>生成中...';
    });
});
</script>
{% endblock %}

{% block content %}
<!-- AIローディングオーバーレイ -->
<div class="ai-loading-overlay" id="aiLoadingOverlay">
  <div class="ai-loading-content">
    <div class="ai-thinking-icon">
      <i class="ti ti-brain ai-brain"></i>
      <i class="ti ti-sparkles ai-sparkles"></i>
      <i class="ti ti-sparkles ai-sparkles"></i>
      <i class="ti ti-sparkles ai-sparkles"></i>
    </div>
    <p class="ai-loading-text">AIが議事録を生成しています</p>
    <p class="ai-loading-subtext">しばらくお待ちください...</p>
    <div class="loading-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12 mb-4">
    <h4 class="fw-semibold mb-0">ノート（議事録）</h4>
    <p class="text-muted mb-0">議事録の作成、管理、AI生成を行います。</p>
  </div>
</div>

<!-- タブナビゲーション -->
<div class="row mb-4">
  <div class="col-12">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'meeting_minutes_list' %}" role="tab">
          <i class="ti ti-notes me-1"></i>ノート一覧
        </a>
      </li>
      {% get_user_selected_company user as selected_company %}
      {% if selected_company %}
        {% get_company_firm_for_plan_check selected_company as company_firm %}
        {% if company_firm %}
          {% check_plan_feature_access_tag company_firm 'starter' as plan_check %}
          {% if plan_check.0 %}
          <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{% url 'meeting_minutes_ai_generate' %}" role="tab">
              <i class="ti ti-sparkles me-1"></i>AI議事録生成
            </a>
          </li>
          {% endif %}
        {% endif %}
      {% endif %}
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'meeting_minutes_create' %}" role="tab">
          <i class="ti ti-plus me-1"></i>新規登録
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="{% url 'meeting_minutes_import' %}" role="tab">
          <i class="ti ti-upload me-1"></i>インポート
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- タブコンテンツ -->
<div class="tab-content" id="meetingMinutesTabsContent">
  <!-- AI議事録生成 -->
  <div class="tab-pane fade show active" id="ai-generate" role="tabpanel">

<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">議事録生成条件</h5>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-4">
            <label for="{{ form.meeting_type.id_for_label }}" class="form-label fw-semibold">
              {{ form.meeting_type.label }}
            </label>
            {{ form.meeting_type|add_class:"form-select" }}
            {% if form.meeting_type.help_text %}
            <small class="form-text text-muted">{{ form.meeting_type.help_text }}</small>
            {% endif %}
            {% if form.meeting_type.errors %}
            <div class="text-danger">{{ form.meeting_type.errors }}</div>
            {% endif %}
          </div>
          
          <div class="mb-4">
            <label for="{{ form.meeting_category.id_for_label }}" class="form-label fw-semibold">
              {{ form.meeting_category.label }}
            </label>
            {{ form.meeting_category|add_class:"form-select" }}
            {% if form.meeting_category.help_text %}
            <small class="form-text text-muted">{{ form.meeting_category.help_text }}</small>
            {% endif %}
            {% if form.meeting_category.errors %}
            <div class="text-danger">{{ form.meeting_category.errors }}</div>
            {% endif %}
          </div>
          
          <div class="mb-4">
            <label for="{{ form.agenda.id_for_label }}" class="form-label fw-semibold">
              {{ form.agenda.label }}
            </label>
            {{ form.agenda|add_class:"form-select" }}
            {% if form.agenda.help_text %}
            <small class="form-text text-muted">{{ form.agenda.help_text }}</small>
            {% endif %}
            {% if form.agenda.errors %}
            <div class="text-danger">{{ form.agenda.errors }}</div>
            {% endif %}
          </div>
          
          <div class="mb-4">
            <label for="{{ form.additional_info.id_for_label }}" class="form-label fw-semibold">
              {{ form.additional_info.label }}
            </label>
            {{ form.additional_info|add_class:"form-control" }}
            {% if form.additional_info.help_text %}
            <small class="form-text text-muted">{{ form.additional_info.help_text }}</small>
            {% endif %}
            {% if form.additional_info.errors %}
            <div class="text-danger">{{ form.additional_info.errors }}</div>
            {% endif %}
          </div>
          
          <div class="alert alert-info">
            <i class="ti ti-info-circle me-2"></i>
            <strong>注意:</strong> 生成された議事録はテンプレートです。実際の会議内容に合わせて編集してください。
          </div>
          
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="ti ti-sparkles me-1"></i>議事録を生成
            </button>
            <a href="{% url 'meeting_minutes_list' %}" class="btn btn-outline-secondary">キャンセル</a>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">使い方</h5>
      </div>
      <div class="card-body">
        <ol class="mb-0">
          <li class="mb-2">会議体を選択してください</li>
          <li class="mb-2">開催種別（定時/臨時）を選択してください</li>
          <li class="mb-2">主な議題を選択してください</li>
          <li class="mb-2">必要に応じて追加情報を入力してください</li>
          <li>「議事録を生成」ボタンをクリックしてください</li>
        </ol>
        <hr class="my-3">
        <p class="text-muted small mb-0">
          <strong>対象プラン:</strong> Starterプラン以上
        </p>
      </div>
    </div>
  </div>
</div>
  </div>
</div>
{% endblock %}

