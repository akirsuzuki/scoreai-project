{% extends "scoreai/base.html" %}
{% load static %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<style>
.progress-section {
    border-left: 4px solid #667eea;
    padding-left: 15px;
    margin-bottom: 30px;
    cursor: pointer;
}

.progress-section.active {
    border-left-color: #667eea;
}

.progress-section.completed {
    border-left-color: #10b981;
}

.section-content {
    display: none;
}

.section-content.active {
    display: block;
}

.monthly-coefficient-input {
    width: 80px;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <h4 class="fw-semibold mb-0">{{ title }}</h4>
            <a href="{% url 'izakaya_plan_list' %}" class="btn btn-outline-secondary">
                <i class="ti ti-list me-1"></i>計画一覧
            </a>
        </div>
    </div>
</div>

<form method="post" id="izakayaPlanForm">
    {% csrf_token %}
    {{ form.is_draft }}
    {{ form.lunch_monthly_coefficients }}
    {{ form.dinner_monthly_coefficients }}
    
    <!-- プログレスバー -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-2 text-center">
                    <div class="progress-section active" data-section="1" onclick="showSection(1)">
                        <h6 class="mb-0">基本情報</h6>
                        <small class="text-muted">店の概要</small>
                    </div>
                </div>
                <div class="col-2 text-center">
                    <div class="progress-section" data-section="2" onclick="showSection(2)">
                        <h6 class="mb-0">昼の営業</h6>
                        <small class="text-muted">時間帯・曜日</small>
                    </div>
                </div>
                <div class="col-2 text-center">
                    <div class="progress-section" data-section="3" onclick="showSection(3)">
                        <h6 class="mb-0">夜の営業</h6>
                        <small class="text-muted">時間帯・曜日</small>
                    </div>
                </div>
                <div class="col-2 text-center">
                    <div class="progress-section" data-section="4" onclick="showSection(4)">
                        <h6 class="mb-0">投資情報</h6>
                        <small class="text-muted">初期投資・家賃</small>
                    </div>
                </div>
                <div class="col-2 text-center">
                    <div class="progress-section" data-section="5" onclick="showSection(5)">
                        <h6 class="mb-0">人件費</h6>
                        <small class="text-muted">社員・アルバイト</small>
                    </div>
                </div>
                <div class="col-2 text-center">
                    <div class="progress-section" data-section="6" onclick="showSection(6)">
                        <h6 class="mb-0">追加経費</h6>
                        <small class="text-muted">光熱費など</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- セクション1: 基本情報 -->
    <div class="card mb-4 section-content active" id="section1">
        <div class="card-header">
            <h5 class="card-title mb-0">基本情報</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12 mb-3">
                    <label for="{{ form.store_concept.id_for_label }}" class="form-label">{{ form.store_concept.label }}</label>
                    {{ form.store_concept }}
                    {% if form.store_concept.errors %}
                    <div class="text-danger small">{{ form.store_concept.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.number_of_seats.id_for_label }}" class="form-label">{{ form.number_of_seats.label }}</label>
                    {{ form.number_of_seats }}
                    {% if form.number_of_seats.errors %}
                    <div class="text-danger small">{{ form.number_of_seats.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.target_customer.id_for_label }}" class="form-label">{{ form.target_customer.label }}</label>
                    {{ form.target_customer }}
                    {% if form.target_customer.errors %}
                    <div class="text-danger small">{{ form.target_customer.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-primary" onclick="showSection(2)">次へ</button>
            </div>
        </div>
    </div>

    <!-- セクション2: 昼の営業時間帯 -->
    <div class="card mb-4 section-content" id="section2">
        <div class="card-header">
            <h5 class="card-title mb-0">昼の営業時間帯</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.lunch_start_time.id_for_label }}" class="form-label">{{ form.lunch_start_time.label }}</label>
                    {{ form.lunch_start_time }}
                    <small class="form-text text-muted">参考情報（売上計算には使用しません）</small>
                    {% if form.lunch_start_time.errors %}
                    <div class="text-danger small">{{ form.lunch_start_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.lunch_end_time.id_for_label }}" class="form-label">{{ form.lunch_end_time.label }}</label>
                    {{ form.lunch_end_time }}
                    <small class="form-text text-muted">参考情報（売上計算には使用しません）</small>
                    {% if form.lunch_end_time.errors %}
                    <div class="text-danger small">{{ form.lunch_end_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">{{ form.lunch_operating_days_widget.label }}</label>
                    <div class="row">
                        {% for choice in form.lunch_operating_days_widget %}
                        <div class="col-md-3 col-6 mb-2">
                            <div class="form-check">
                                {{ choice.tag }}
                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                    {{ choice.choice_label }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.lunch_operating_days_widget.errors %}
                    <div class="text-danger small">{{ form.lunch_operating_days_widget.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.lunch_price_per_customer.id_for_label }}" class="form-label">{{ form.lunch_price_per_customer.label }}</label>
                    <div class="input-group">
                        {{ form.lunch_price_per_customer }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.lunch_price_per_customer.errors %}
                    <div class="text-danger small">{{ form.lunch_price_per_customer.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.lunch_customer_count.id_for_label }}" class="form-label">{{ form.lunch_customer_count.label }}</label>
                    <div class="input-group">
                        {{ form.lunch_customer_count }}
                        <span class="input-group-text">人/日</span>
                    </div>
                    {% if form.lunch_customer_count.errors %}
                    <div class="text-danger small">{{ form.lunch_customer_count.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.lunch_cost_rate.id_for_label }}" class="form-label">{{ form.lunch_cost_rate.label }}</label>
                    <div class="input-group">
                        {{ form.lunch_cost_rate }}
                        <span class="input-group-text">%</span>
                    </div>
                    {% if form.lunch_cost_rate.errors %}
                    <div class="text-danger small">{{ form.lunch_cost_rate.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">昼の月毎指数（1-12月）</label>
                    <div class="row" id="lunchMonthlyCoefficientsContainer">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection(1)">戻る</button>
                <button type="button" class="btn btn-primary" onclick="showSection(3)">次へ</button>
            </div>
        </div>
    </div>

    <!-- セクション3: 夜の営業時間帯 -->
    <div class="card mb-4 section-content" id="section3">
        <div class="card-header">
            <h5 class="card-title mb-0">夜の営業時間帯</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.dinner_start_time.id_for_label }}" class="form-label">{{ form.dinner_start_time.label }}</label>
                    {{ form.dinner_start_time }}
                    <small class="form-text text-muted">参考情報（売上計算には使用しません）</small>
                    {% if form.dinner_start_time.errors %}
                    <div class="text-danger small">{{ form.dinner_start_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.dinner_end_time.id_for_label }}" class="form-label">{{ form.dinner_end_time.label }}</label>
                    {{ form.dinner_end_time }}
                    <small class="form-text text-muted">参考情報（売上計算には使用しません）。28時（翌日4時）まで入力可能です。例: 28:00</small>
                    {% if form.dinner_end_time.errors %}
                    <div class="text-danger small">{{ form.dinner_end_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">{{ form.dinner_operating_days_widget.label }}</label>
                    <div class="row" id="dinner_operating_days_container">
                        {% for choice in form.dinner_operating_days_widget %}
                        <div class="col-md-3 col-6 mb-2">
                            <div class="form-check">
                                {{ choice.tag }}
                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                    {{ choice.choice_label }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.dinner_operating_days_widget.errors %}
                    <div class="text-danger small">{{ form.dinner_operating_days_widget.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.dinner_price_per_customer.id_for_label }}" class="form-label">{{ form.dinner_price_per_customer.label }}</label>
                    <div class="input-group">
                        {{ form.dinner_price_per_customer }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.dinner_price_per_customer.errors %}
                    <div class="text-danger small">{{ form.dinner_price_per_customer.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.dinner_customer_count.id_for_label }}" class="form-label">{{ form.dinner_customer_count.label }}</label>
                    <div class="input-group">
                        {{ form.dinner_customer_count }}
                        <span class="input-group-text">人/日</span>
                    </div>
                    <small class="form-text text-muted">24時間営業の場合は合計客数を入力してください</small>
                    {% if form.dinner_customer_count.errors %}
                    <div class="text-danger small">{{ form.dinner_customer_count.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.dinner_cost_rate.id_for_label }}" class="form-label">{{ form.dinner_cost_rate.label }}</label>
                    <div class="input-group">
                        {{ form.dinner_cost_rate }}
                        <span class="input-group-text">%</span>
                    </div>
                    {% if form.dinner_cost_rate.errors %}
                    <div class="text-danger small">{{ form.dinner_cost_rate.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">夜の月毎指数（1-12月）</label>
                    <div class="row" id="dinnerMonthlyCoefficientsContainer">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection(2)">戻る</button>
                <button type="button" class="btn btn-primary" onclick="showSection(4)">次へ</button>
            </div>
        </div>
    </div>

    <!-- セクション4: 投資情報 -->
    <div class="card mb-4 section-content" id="section4">
        <div class="card-header">
            <h5 class="card-title mb-0">投資情報</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.initial_investment.id_for_label }}" class="form-label">{{ form.initial_investment.label }}</label>
                    <div class="input-group">
                        {{ form.initial_investment }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.initial_investment.errors %}
                    <div class="text-danger small">{{ form.initial_investment.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_rent.id_for_label }}" class="form-label">{{ form.monthly_rent.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_rent }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_rent.errors %}
                    <div class="text-danger small">{{ form.monthly_rent.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection(3)">戻る</button>
                <button type="button" class="btn btn-primary" onclick="showSection(5)">次へ</button>
            </div>
        </div>
    </div>

    <!-- セクション5: 人件費 -->
    <div class="card mb-4 section-content" id="section5">
        <div class="card-header">
            <h5 class="card-title mb-0">人件費</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.number_of_staff.id_for_label }}" class="form-label">{{ form.number_of_staff.label }}</label>
                    {{ form.number_of_staff }}
                    {% if form.number_of_staff.errors %}
                    <div class="text-danger small">{{ form.number_of_staff.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.staff_monthly_salary.id_for_label }}" class="form-label">{{ form.staff_monthly_salary.label }}</label>
                    <div class="input-group">
                        {{ form.staff_monthly_salary }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.staff_monthly_salary.errors %}
                    <div class="text-danger small">{{ form.staff_monthly_salary.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.part_time_hours_per_month.id_for_label }}" class="form-label">{{ form.part_time_hours_per_month.label }}</label>
                    {{ form.part_time_hours_per_month }}
                    {% if form.part_time_hours_per_month.errors %}
                    <div class="text-danger small">{{ form.part_time_hours_per_month.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.part_time_hourly_wage.id_for_label }}" class="form-label">{{ form.part_time_hourly_wage.label }}</label>
                    <div class="input-group">
                        {{ form.part_time_hourly_wage }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.part_time_hourly_wage.errors %}
                    <div class="text-danger small">{{ form.part_time_hourly_wage.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection(4)">戻る</button>
                <button type="button" class="btn btn-primary" onclick="showSection(6)">次へ</button>
            </div>
        </div>
    </div>

    <!-- セクション6: 追加経費 -->
    <div class="card mb-4 section-content" id="section6">
        <div class="card-header">
            <h5 class="card-title mb-0">追加経費</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_utilities.id_for_label }}" class="form-label">{{ form.monthly_utilities.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_utilities }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_utilities.errors %}
                    <div class="text-danger small">{{ form.monthly_utilities.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_supplies.id_for_label }}" class="form-label">{{ form.monthly_supplies.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_supplies }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_supplies.errors %}
                    <div class="text-danger small">{{ form.monthly_supplies.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_advertising.id_for_label }}" class="form-label">{{ form.monthly_advertising.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_advertising }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_advertising.errors %}
                    <div class="text-danger small">{{ form.monthly_advertising.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_fees.id_for_label }}" class="form-label">{{ form.monthly_fees.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_fees }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_fees.errors %}
                    <div class="text-danger small">{{ form.monthly_fees.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.monthly_other_expenses.id_for_label }}" class="form-label">{{ form.monthly_other_expenses.label }}</label>
                    <div class="input-group">
                        {{ form.monthly_other_expenses }}
                        <span class="input-group-text">円</span>
                    </div>
                    {% if form.monthly_other_expenses.errors %}
                    <div class="text-danger small">{{ form.monthly_other_expenses.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="showSection(5)">戻る</button>
                <div>
                    <button type="submit" name="save_draft" value="1" class="btn btn-outline-primary me-2">
                        <i class="ti ti-device-floppy me-1"></i>保存して下書き
                    </button>
                    <button type="submit" name="calculate" value="1" class="btn btn-primary">
                        <i class="ti ti-calculator me-1"></i>計算してプレビュー
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
let currentSection = 1;

function showSection(sectionNum) {
    // 現在のセクションを非表示
    document.querySelectorAll('.section-content').forEach(section => {
        section.classList.remove('active');
    });
    document.querySelectorAll('.progress-section').forEach(section => {
        section.classList.remove('active', 'completed');
    });
    
    // 新しいセクションを表示
    document.getElementById(`section${sectionNum}`).classList.add('active');
    document.querySelector(`.progress-section[data-section="${sectionNum}"]`).classList.add('active');
    
    // 以前のセクションを完了としてマーク
    for (let i = 1; i < sectionNum; i++) {
        document.querySelector(`.progress-section[data-section="${i}"]`).classList.add('completed');
    }
    
    currentSection = sectionNum;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// 月毎指数の入力フィールドを生成
function initializeMonthlyCoefficients(containerId, fieldId, defaultValues) {
    const container = document.getElementById(containerId);
    const hiddenField = document.getElementById(fieldId);
    
    let coefficients = {};
    if (hiddenField && hiddenField.value) {
        try {
            coefficients = JSON.parse(hiddenField.value);
        } catch (e) {
            coefficients = defaultValues;
        }
    } else {
        coefficients = defaultValues;
    }
    
    const months = [
        { num: 1, name: '1月' }, { num: 2, name: '2月' }, { num: 3, name: '3月' },
        { num: 4, name: '4月' }, { num: 5, name: '5月' }, { num: 6, name: '6月' },
        { num: 7, name: '7月' }, { num: 8, name: '8月' }, { num: 9, name: '9月' },
        { num: 10, name: '10月' }, { num: 11, name: '11月' }, { num: 12, name: '12月' }
    ];
    
    months.forEach(month => {
        const value = coefficients[String(month.num)] || 1.0;
        const col = document.createElement('div');
        col.className = 'col-md-3 col-6 mb-2';
        col.innerHTML = `
            <label class="form-label small">${month.name}</label>
            <input type="number" 
                   class="form-control monthly-coefficient-input" 
                   data-container="${containerId}"
                   data-month="${month.num}"
                   value="${value}" 
                   step="0.1" 
                   min="0">
        `;
        container.appendChild(col);
    });
}

// フォーム送信時に月毎指数をJSON形式で設定
function updateMonthlyCoefficients() {
    // 昼の月毎指数
    const lunchCoefficients = {};
    document.querySelectorAll('#lunchMonthlyCoefficientsContainer .monthly-coefficient-input').forEach(input => {
        lunchCoefficients[input.dataset.month] = parseFloat(input.value) || 1.0;
    });
    const lunchField = document.getElementById('id_lunch_monthly_coefficients');
    if (lunchField) {
        lunchField.value = JSON.stringify(lunchCoefficients);
    }
    
    // 夜の月毎指数
    const dinnerCoefficients = {};
    document.querySelectorAll('#dinnerMonthlyCoefficientsContainer .monthly-coefficient-input').forEach(input => {
        dinnerCoefficients[input.dataset.month] = parseFloat(input.value) || 1.0;
    });
    const dinnerField = document.getElementById('id_dinner_monthly_coefficients');
    if (dinnerField) {
        dinnerField.value = JSON.stringify(dinnerCoefficients);
    }
}

// 28時表記のバリデーション
function validate28HourTime(input) {
    const value = input.value.trim();
    if (!value) {
        input.setCustomValidity('');
        return true; // 空の場合はOK（24時間営業の場合など）
    }
    
    const pattern = /^([0-1]?[0-9]|2[0-8]):[0-5][0-9]$/;
    if (!pattern.test(value)) {
        input.setCustomValidity('時間の形式が正しくありません。0時から28時（翌日4時）まで、HH:MM形式で入力してください。例: 28:00');
        return false;
    }
    
    input.setCustomValidity('');
    return true;
}

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', function() {
    // 28時表記のバリデーション
    const dinnerEndTime = document.getElementById('id_dinner_end_time');
    if (dinnerEndTime) {
        dinnerEndTime.addEventListener('input', function() {
            validate28HourTime(this);
        });
        dinnerEndTime.addEventListener('blur', function() {
            validate28HourTime(this);
        });
    }
    
    // デフォルトの月毎指数（すべて1.0、文字列キー）
    const defaultMonthlyCoeffs = {};
    for (let i = 1; i <= 12; i++) {
        defaultMonthlyCoeffs[String(i)] = 1.0;
    }
    
    // 昼の月毎指数の初期化
    {% if form.lunch_monthly_coefficients.value %}
    let lunchCoeffs = {};
    try {
        lunchCoeffs = JSON.parse('{{ form.lunch_monthly_coefficients.value|safe }}');
    } catch (e) {
        lunchCoeffs = defaultMonthlyCoeffs;
    }
    {% else %}
    const lunchCoeffs = defaultMonthlyCoeffs;
    {% endif %}
    initializeMonthlyCoefficients('lunchMonthlyCoefficientsContainer', 'id_lunch_monthly_coefficients', lunchCoeffs);
    
    // 夜の月毎指数の初期化
    {% if form.dinner_monthly_coefficients.value %}
    let dinnerCoeffs = {};
    try {
        dinnerCoeffs = JSON.parse('{{ form.dinner_monthly_coefficients.value|safe }}');
    } catch (e) {
        dinnerCoeffs = defaultMonthlyCoeffs;
    }
    {% else %}
    const dinnerCoeffs = defaultMonthlyCoeffs;
    {% endif %}
    initializeMonthlyCoefficients('dinnerMonthlyCoefficientsContainer', 'id_dinner_monthly_coefficients', dinnerCoeffs);
    
    // 編集時は既存のセクションを表示
    {% if plan %}
    // 編集時はすべてのセクションを完了としてマーク
    document.querySelectorAll('.progress-section').forEach(section => {
        section.classList.add('completed');
    });
    // 最後のセクションをアクティブに
    showSection(6);
    {% endif %}
    
    // フォーム送信時に月毎指数を更新
    document.getElementById('izakayaPlanForm').addEventListener('submit', function(e) {
        updateMonthlyCoefficients();
    });
    
    // 月毎指数の入力時にリアルタイムで更新
    document.querySelectorAll('.monthly-coefficient-input').forEach(input => {
        input.addEventListener('change', updateMonthlyCoefficients);
    });
    
    // 下書き保存ボタンの処理
    const saveDraftBtn = document.querySelector('button[name="save_draft"]');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function(e) {
            updateMonthlyCoefficients();
            document.getElementById('id_is_draft').value = 'true';
        });
    }
    
    // 計算ボタンの処理
    const calculateBtn = document.querySelector('button[name="calculate"]');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', function(e) {
            updateMonthlyCoefficients();
            document.getElementById('id_is_draft').value = 'false';
        });
    }
});
</script>
{% endblock %}
