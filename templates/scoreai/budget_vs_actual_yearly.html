{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="fw-semibold mb-0">年次財務諸表</h4>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'fiscal_summary_year_list' %}?is_draft=false" class="btn btn-outline-primary btn-sm">決算年次推移</a>
        <a href="{% url 'latest_fiscal_summary_year_detail' %}" class="btn btn-outline-primary btn-sm">直近決算詳細</a>
        <a href="{% url 'budget_vs_actual_yearly' %}" class="btn btn-primary btn-sm">年次予算vs実績比較</a>
        <form method="get" class="d-flex gap-2">
          <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
            {% for y in available_years %}
              <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}年</option>
            {% endfor %}
          </select>
        </form>
      </div>
    </div>
  </div>
</div>

{% if actual_year %}
<!-- PL比較 -->
<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">損益計算書比較（{{ year }}年）</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>項目</th>
                <th class="text-end">予算</th>
                <th class="text-end">実績</th>
                <th class="text-end">差異（金額）</th>
                <th class="text-end">差異率</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>売上高</strong></td>
                <td class="text-end">{{ financial_indicators.sales.budget|intcomma }}</td>
                <td class="text-end">{{ financial_indicators.sales.actual|intcomma }}</td>
                <td class="text-end {% if financial_indicators.sales.diff is not None %}{% if financial_indicators.sales.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.sales.diff is not None %}
                    {{ financial_indicators.sales.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if financial_indicators.sales.diff_rate is not None %}{% if financial_indicators.sales.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.sales.diff_rate is not None %}
                    {{ financial_indicators.sales.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>粗利益</strong></td>
                <td class="text-end">{{ financial_indicators.gross_profit.budget|intcomma }}</td>
                <td class="text-end">{{ financial_indicators.gross_profit.actual|intcomma }}</td>
                <td class="text-end {% if financial_indicators.gross_profit.diff is not None %}{% if financial_indicators.gross_profit.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.gross_profit.diff is not None %}
                    {{ financial_indicators.gross_profit.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if financial_indicators.gross_profit.diff_rate is not None %}{% if financial_indicators.gross_profit.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.gross_profit.diff_rate is not None %}
                    {{ financial_indicators.gross_profit.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>営業利益</strong></td>
                <td class="text-end">{{ financial_indicators.operating_profit.budget|intcomma }}</td>
                <td class="text-end">{{ financial_indicators.operating_profit.actual|intcomma }}</td>
                <td class="text-end {% if financial_indicators.operating_profit.diff is not None %}{% if financial_indicators.operating_profit.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.operating_profit.diff is not None %}
                    {{ financial_indicators.operating_profit.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if financial_indicators.operating_profit.diff_rate is not None %}{% if financial_indicators.operating_profit.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.operating_profit.diff_rate is not None %}
                    {{ financial_indicators.operating_profit.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>経常利益</strong></td>
                <td class="text-end">{{ financial_indicators.ordinary_profit.budget|intcomma }}</td>
                <td class="text-end">{{ financial_indicators.ordinary_profit.actual|intcomma }}</td>
                <td class="text-end {% if financial_indicators.ordinary_profit.diff is not None %}{% if financial_indicators.ordinary_profit.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.ordinary_profit.diff is not None %}
                    {{ financial_indicators.ordinary_profit.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if financial_indicators.ordinary_profit.diff_rate is not None %}{% if financial_indicators.ordinary_profit.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.ordinary_profit.diff_rate is not None %}
                    {{ financial_indicators.ordinary_profit.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>当期純利益</strong></td>
                <td class="text-end">{{ financial_indicators.net_profit.budget|intcomma }}</td>
                <td class="text-end">{{ financial_indicators.net_profit.actual|intcomma }}</td>
                <td class="text-end {% if financial_indicators.net_profit.diff is not None %}{% if financial_indicators.net_profit.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.net_profit.diff is not None %}
                    {{ financial_indicators.net_profit.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if financial_indicators.net_profit.diff_rate is not None %}{% if financial_indicators.net_profit.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.net_profit.diff_rate is not None %}
                    {{ financial_indicators.net_profit.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 経営指標比較 -->
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">経営指標比較（{{ year }}年）</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>指標</th>
                <th class="text-end">予算</th>
                <th class="text-end">実績</th>
                <th class="text-end">差異</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>売上総利益率（%）</strong></td>
                <td class="text-end">{{ financial_indicators.gross_profit_margin.budget|floatformat:2 }}%</td>
                <td class="text-end">{{ financial_indicators.gross_profit_margin.actual|floatformat:2 }}%</td>
                <td class="text-end {% if financial_indicators.gross_profit_margin.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ financial_indicators.gross_profit_margin.diff|floatformat:2 }}%
                </td>
              </tr>
              <tr>
                <td><strong>営業利益率（%）</strong></td>
                <td class="text-end">{{ financial_indicators.operating_profit_margin.budget|floatformat:2 }}%</td>
                <td class="text-end">{{ financial_indicators.operating_profit_margin.actual|floatformat:2 }}%</td>
                <td class="text-end {% if financial_indicators.operating_profit_margin.diff is not None %}{% if financial_indicators.operating_profit_margin.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.operating_profit_margin.diff is not None %}
                    {{ financial_indicators.operating_profit_margin.diff|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>ROA（総資本経常利益率）（%）</strong></td>
                <td class="text-end">{{ financial_indicators.ROA.budget|floatformat:2 }}%</td>
                <td class="text-end">{{ financial_indicators.ROA.actual|floatformat:2 }}%</td>
                <td class="text-end {% if financial_indicators.ROA.diff is not None %}{% if financial_indicators.ROA.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.ROA.diff is not None %}
                    {{ financial_indicators.ROA.diff|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>自己資本比率（%）</strong></td>
                <td class="text-end">{{ financial_indicators.equity_ratio.budget|floatformat:2 }}%</td>
                <td class="text-end">{{ financial_indicators.equity_ratio.actual|floatformat:2 }}%</td>
                <td class="text-end {% if financial_indicators.equity_ratio.diff is not None %}{% if financial_indicators.equity_ratio.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.equity_ratio.diff is not None %}
                    {{ financial_indicators.equity_ratio.diff|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>流動比率（%）</strong></td>
                <td class="text-end">{{ financial_indicators.current_ratio.budget|floatformat:2 }}%</td>
                <td class="text-end">{{ financial_indicators.current_ratio.actual|floatformat:2 }}%</td>
                <td class="text-end {% if financial_indicators.current_ratio.diff is not None %}{% if financial_indicators.current_ratio.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if financial_indicators.current_ratio.diff is not None %}
                    {{ financial_indicators.current_ratio.diff|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BS比較 -->
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">貸借対照表比較（{{ year }}年）</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>項目</th>
                <th class="text-end">予算</th>
                <th class="text-end">実績</th>
                <th class="text-end">差異（金額）</th>
                <th class="text-end">差異率</th>
              </tr>
            </thead>
            <tbody>
              <tr class="table-secondary">
                <td colspan="5"><strong>【資産の部】</strong></td>
              </tr>
              <tr>
                <td><strong>現金及び預金</strong></td>
                <td class="text-end">{{ bs_indicators.cash_and_deposits.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.cash_and_deposits.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.cash_and_deposits.diff is not None %}{% if bs_indicators.cash_and_deposits.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.cash_and_deposits.diff is not None %}
                    {{ bs_indicators.cash_and_deposits.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.cash_and_deposits.diff_rate is not None %}{% if bs_indicators.cash_and_deposits.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.cash_and_deposits.diff_rate is not None %}
                    {{ bs_indicators.cash_and_deposits.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>売上債権</strong></td>
                <td class="text-end">{{ bs_indicators.accounts_receivable.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.accounts_receivable.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.accounts_receivable.diff is not None %}{% if bs_indicators.accounts_receivable.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.accounts_receivable.diff is not None %}
                    {{ bs_indicators.accounts_receivable.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.accounts_receivable.diff_rate is not None %}{% if bs_indicators.accounts_receivable.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.accounts_receivable.diff_rate is not None %}
                    {{ bs_indicators.accounts_receivable.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>棚卸資産</strong></td>
                <td class="text-end">{{ bs_indicators.inventory.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.inventory.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.inventory.diff is not None %}{% if bs_indicators.inventory.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.inventory.diff is not None %}
                    {{ bs_indicators.inventory.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.inventory.diff_rate is not None %}{% if bs_indicators.inventory.diff_rate >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.inventory.diff_rate is not None %}
                    {{ bs_indicators.inventory.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>流動資産合計</strong></td>
                <td class="text-end">{{ bs_indicators.total_current_assets.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.total_current_assets.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.total_current_assets.diff is not None %}{% if bs_indicators.total_current_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.total_current_assets.diff is not None %}
                    {{ bs_indicators.total_current_assets.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_current_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.total_current_assets.diff_rate is not None %}
                    {{ bs_indicators.total_current_assets.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>固定資産合計</strong></td>
                <td class="text-end">{{ bs_indicators.total_fixed_assets.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.total_fixed_assets.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.total_fixed_assets.diff is not None %}{% if bs_indicators.total_fixed_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.total_fixed_assets.diff is not None %}
                    {{ bs_indicators.total_fixed_assets.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_fixed_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.total_fixed_assets.diff_rate is not None %}
                    {{ bs_indicators.total_fixed_assets.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="table-info">
                <td><strong>資産の部合計</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_assets.budget|intcomma }}</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_assets.actual|intcomma }}</strong></td>
                <td class="text-end {% if bs_indicators.total_assets.diff is not None %}{% if bs_indicators.total_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.total_assets.diff is not None %}
                    <strong>{{ bs_indicators.total_assets.diff|intcomma }}</strong>
                  {% else %}
                    <strong>-</strong>
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.total_assets.diff_rate is not None %}
                    <strong>{{ bs_indicators.total_assets.diff_rate|floatformat:2 }}%</strong>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="table-secondary">
                <td colspan="5"><strong>【負債の部】</strong></td>
              </tr>
              <tr>
                <td><strong>仕入債務</strong></td>
                <td class="text-end">{{ bs_indicators.accounts_payable.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.accounts_payable.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.accounts_payable.diff is not None %}{% if bs_indicators.accounts_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                  {% if bs_indicators.accounts_payable.diff is not None %}
                    {{ bs_indicators.accounts_payable.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.accounts_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}">
                  {% if bs_indicators.accounts_payable.diff_rate is not None %}
                    {{ bs_indicators.accounts_payable.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>短期借入金</strong></td>
                <td class="text-end">{{ bs_indicators.short_term_loans_payable.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.short_term_loans_payable.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.short_term_loans_payable.diff is not None %}{% if bs_indicators.short_term_loans_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                  {% if bs_indicators.short_term_loans_payable.diff is not None %}
                    {{ bs_indicators.short_term_loans_payable.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.short_term_loans_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}">
                  {% if bs_indicators.short_term_loans_payable.diff_rate is not None %}
                    {{ bs_indicators.short_term_loans_payable.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>流動負債合計</strong></td>
                <td class="text-end">{{ bs_indicators.total_current_liabilities.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.total_current_liabilities.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.total_current_liabilities.diff is not None %}{% if bs_indicators.total_current_liabilities.diff >= 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                  {% if bs_indicators.total_current_liabilities.diff is not None %}
                    {{ bs_indicators.total_current_liabilities.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_current_liabilities.diff >= 0 %}text-danger{% else %}text-success{% endif %}">
                  {% if bs_indicators.total_current_liabilities.diff_rate is not None %}
                    {{ bs_indicators.total_current_liabilities.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>長期借入金</strong></td>
                <td class="text-end">{{ bs_indicators.long_term_loans_payable.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.long_term_loans_payable.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.long_term_loans_payable.diff is not None %}{% if bs_indicators.long_term_loans_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                  {% if bs_indicators.long_term_loans_payable.diff is not None %}
                    {{ bs_indicators.long_term_loans_payable.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.long_term_loans_payable.diff >= 0 %}text-danger{% else %}text-success{% endif %}">
                  {% if bs_indicators.long_term_loans_payable.diff_rate is not None %}
                    {{ bs_indicators.long_term_loans_payable.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="table-info">
                <td><strong>負債の部合計</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_liabilities.budget|intcomma }}</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_liabilities.actual|intcomma }}</strong></td>
                <td class="text-end {% if bs_indicators.total_liabilities.diff is not None %}{% if bs_indicators.total_liabilities.diff >= 0 %}text-danger{% else %}text-success{% endif %}{% endif %}">
                  {% if bs_indicators.total_liabilities.diff is not None %}
                    <strong>{{ bs_indicators.total_liabilities.diff|intcomma }}</strong>
                  {% else %}
                    <strong>-</strong>
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_liabilities.diff >= 0 %}text-danger{% else %}text-success{% endif %}">
                  {% if bs_indicators.total_liabilities.diff_rate is not None %}
                    <strong>{{ bs_indicators.total_liabilities.diff_rate|floatformat:2 }}%</strong>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="table-secondary">
                <td colspan="5"><strong>【純資産の部】</strong></td>
              </tr>
              <tr>
                <td><strong>資本金</strong></td>
                <td class="text-end">{{ bs_indicators.capital_stock.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.capital_stock.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.capital_stock.diff is not None %}{% if bs_indicators.capital_stock.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.capital_stock.diff is not None %}
                    {{ bs_indicators.capital_stock.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.capital_stock.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.capital_stock.diff_rate is not None %}
                    {{ bs_indicators.capital_stock.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr>
                <td><strong>利益剰余金</strong></td>
                <td class="text-end">{{ bs_indicators.retained_earnings.budget|intcomma }}</td>
                <td class="text-end">{{ bs_indicators.retained_earnings.actual|intcomma }}</td>
                <td class="text-end {% if bs_indicators.retained_earnings.diff is not None %}{% if bs_indicators.retained_earnings.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.retained_earnings.diff is not None %}
                    {{ bs_indicators.retained_earnings.diff|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.retained_earnings.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.retained_earnings.diff_rate is not None %}
                    {{ bs_indicators.retained_earnings.diff_rate|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              <tr class="table-info">
                <td><strong>純資産の部合計</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_net_assets.budget|intcomma }}</strong></td>
                <td class="text-end"><strong>{{ bs_indicators.total_net_assets.actual|intcomma }}</strong></td>
                <td class="text-end {% if bs_indicators.total_net_assets.diff is not None %}{% if bs_indicators.total_net_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}{% endif %}">
                  {% if bs_indicators.total_net_assets.diff is not None %}
                    <strong>{{ bs_indicators.total_net_assets.diff|intcomma }}</strong>
                  {% else %}
                    <strong>-</strong>
                  {% endif %}
                </td>
                <td class="text-end {% if bs_indicators.total_net_assets.diff >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% if bs_indicators.total_net_assets.diff_rate is not None %}
                    <strong>{{ bs_indicators.total_net_assets.diff_rate|floatformat:2 }}%</strong>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 損益計算書グラフ -->
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">損益計算書比較グラフ</h5>
      </div>
      <div class="card-body">
        <canvas id="plChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- BSグラフ -->
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">貸借対照表比較グラフ</h5>
      </div>
      <div class="card-body">
        <canvas id="bsChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- 経営指標グラフ -->
<div class="row mt-4">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0 fw-semibold">経営指標比較グラフ</h5>
      </div>
      <div class="card-body">
        <canvas id="indicatorsChart" height="80"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
// 損益計算書グラフ
const plChartData = {{ chart_data_json|safe }};
const plCtx = document.getElementById('plChart').getContext('2d');
new Chart(plCtx, {
  type: 'bar',
  data: {
    labels: plChartData.labels,
    datasets: [
      {
        label: '予算',
        data: plChartData.budget,
        backgroundColor: 'rgba(93, 135, 255, 0.6)',
        borderColor: 'rgb(93, 135, 255)',
        borderWidth: 1,
      },
      {
        label: '実績',
        data: plChartData.actual,
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
        borderColor: 'rgb(255, 99, 132)',
        borderWidth: 1,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '千円';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        ticks: {
          callback: function(value) {
            return value.toLocaleString() + '千円';
          }
        }
      }
    }
  }
});

// 経営指標グラフ
const indicatorsChartData = {{ indicators_chart_data_json|safe }};
const indicatorsCtx = document.getElementById('indicatorsChart').getContext('2d');
new Chart(indicatorsCtx, {
  type: 'bar',
  data: {
    labels: indicatorsChartData.labels,
    datasets: [
      {
        label: '予算',
        data: indicatorsChartData.budget,
        backgroundColor: 'rgba(93, 135, 255, 0.6)',
        borderColor: 'rgb(93, 135, 255)',
        borderWidth: 1,
      },
      {
        label: '実績',
        data: indicatorsChartData.actual,
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
        borderColor: 'rgb(255, 99, 132)',
        borderWidth: 1,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: function(value) {
            return value.toFixed(2) + '%';
          }
        }
      }
    }
  }
});

// BSグラフ
const bsChartData = {{ bs_chart_data_json|safe }};
const bsCtx = document.getElementById('bsChart').getContext('2d');
new Chart(bsCtx, {
  type: 'bar',
  data: {
    labels: bsChartData.labels,
    datasets: [
      {
        label: '予算',
        data: bsChartData.budget,
        backgroundColor: 'rgba(93, 135, 255, 0.6)',
        borderColor: 'rgb(93, 135, 255)',
        borderWidth: 1,
      },
      {
        label: '実績',
        data: bsChartData.actual,
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
        borderColor: 'rgb(255, 99, 132)',
        borderWidth: 1,
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        position: 'top',
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '千円';
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        ticks: {
          callback: function(value) {
            return value.toLocaleString() + '千円';
          }
        }
      }
    }
  }
});
</script>

{% else %}
<div class="row">
  <div class="col-lg-12">
    <div class="alert alert-warning">
      {% if not budget_year %}
        <i class="ti ti-alert-triangle me-2"></i>{{ year }}年の予算データが見つかりません。
      {% endif %}
      {% if not actual_year %}
        <i class="ti ti-alert-triangle me-2"></i>{{ year }}年の実績データが見つかりません。
      {% endif %}
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

