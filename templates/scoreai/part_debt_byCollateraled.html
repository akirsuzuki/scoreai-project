<div class="card d-flex flex-column h-100">
  <div class="card-header">
    <h5 class="card-title fw-semibold"> 担保有無別残高 </h5>
  </div>
  <div class="card-body p-4">
    <div class="d-flex justify-content-center pencil-chart-wrapper-small">
      <canvas id="chart_byCollateraled" class="w-100"></canvas>
    </div>
  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('chart_byCollateraled').getContext('2d');
    
    // データを集計: 担保ありと担保なしの合計を計算
    let totalWithCollateral = 0;
    let totalWithoutCollateral = 0;
    
    {% for debt in debt_list_byCollateraled %}
      {% if debt.is_collateraled %}
        totalWithCollateral += {{ debt.balances_monthly.0 }};
      {% else %}
        totalWithoutCollateral += {{ debt.balances_monthly.0 }};
      {% endif %}
    {% endfor %}
    
    const data = {
      labels: ['担保あり', '担保なし'],
      datasets: [{
        data: [totalWithCollateral, totalWithoutCollateral],
        backgroundColor: [
          'rgb(54, 162, 235)',
          'rgb(255, 99, 132)'
        ],
        hoverOffset: 4
      }]
    };
    
    const config = {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + (value / 1000000).toFixed(2) + '百万円 (' + percentage + '%)';
              }
            }
          }
        }
      }
    };
    
    new Chart(ctx, config);
  });
</script>