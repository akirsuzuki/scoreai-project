{% load static %}
{% load humanize %}
{% load custom_filters %}

<!-- KPIã‚«ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="row g-3 mb-4 dashboard-section">
  <!-- å£²ä¸Šé«˜ï¼ˆä»ŠæœŸï¼‰ -->
  <div class="col-lg-3 col-md-6">
    <div class="card kpi-card kpi-sales">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">å£²ä¸Šé«˜ï¼ˆä»ŠæœŸï¼‰</span>
          <div class="kpi-icon">
            <i class="ti ti-trending-up"></i>
          </div>
        </div>
        <h2 class="kpi-value" data-target="{{ monthly_summaries_total.sum_sales|default:0 }}" data-suffix=" åƒå††">
          0 åƒå††
        </h2>
        {% if monthly_summaries.0.actual_months_count %}
        <div class="text-muted small mb-2">{{ monthly_summaries.0.actual_months_count }}ãƒ¶æœˆç´¯è¨ˆ</div>
        {% endif %}
        <div class="kpi-trend">
          {% if monthly_summaries_total_last_year.year and monthly_summaries_total_last_year.sum_sales|default:0 > 0 %}
          {% with current=monthly_summaries_total.sum_sales|default:0 previous=monthly_summaries_total_last_year.sum_sales|default:1 %}
          {% if previous > 0 %}
          {% with change=current|divide:previous|multiply:100|subtract:100 %}
          <div class="d-flex align-items-center">
            <span
              class="me-1 rounded-circle {% if change > 0 %}bg-light-success{% elif change < 0 %}bg-light-danger{% else %}bg-light-warning{% endif %} round-20 d-flex align-items-center justify-content-center">
              {% if change > 0 %}
              <i
                class="ti ti-arrow-up-left {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}"></i>
              {% elif change < 0 %} <i
                class="ti ti-arrow-down-left {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}">
                </i>
                {% else %}
                <i
                  class="ti ti-minus {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}"></i>
                {% endif %}
            </span>
            <p class="text-dark me-1 fs-3 mb-0">{% if change > 0 %}+{% endif %}{{ change|floatformat:1 }}%</p>
            <p class="fs-3 mb-0">å‰å¹´æ¯”</p>
          </div>
          {% endwith %}
          {% else %}
          <span class="text-muted small">å‰å¹´ãƒ‡ãƒ¼ã‚¿ãªã—</span>
          {% endif %}
          {% endwith %}
          {% else %}
          <span class="text-muted small">å‰å¹´ãƒ‡ãƒ¼ã‚¿ãªã—</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- å–¶æ¥­åˆ©ç›Šï¼ˆä»ŠæœŸï¼‰ -->
  <div class="col-lg-3 col-md-6">
    <div class="card kpi-card kpi-profit">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">å–¶æ¥­åˆ©ç›Šï¼ˆä»ŠæœŸï¼‰</span>
          <div class="kpi-icon">
            <i class="ti ti-currency-yen"></i>
          </div>
        </div>
        <h2 class="kpi-value" data-target="{{ monthly_summaries_total.sum_operating_profit|default:0 }}"
          data-suffix=" åƒå††">
          0 åƒå††
        </h2>
        {% if monthly_summaries.0.actual_months_count %}
        <div class="text-muted small mb-2">{{ monthly_summaries.0.actual_months_count }}ãƒ¶æœˆç´¯è¨ˆ</div>
        {% endif %}
        <div class="kpi-trend">
          {% if monthly_summaries_total_last_year.year and monthly_summaries_total_last_year.sum_operating_profit|default:0 > 0 %}
          {% with current=monthly_summaries_total.sum_operating_profit|default:0 previous=monthly_summaries_total_last_year.sum_operating_profit|default:1 %}
          {% if previous > 0 %}
          {% with change=current|divide:previous|multiply:100|subtract:100 %}
          <div class="d-flex align-items-center">
            <span
              class="me-1 rounded-circle {% if change > 0 %}bg-light-success{% elif change < 0 %}bg-light-danger{% else %}bg-light-warning{% endif %} round-20 d-flex align-items-center justify-content-center">
              {% if change > 0 %}
              <i
                class="ti ti-arrow-up-left {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}"></i>
              {% elif change < 0 %} <i
                class="ti ti-arrow-down-left {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}">
                </i>
                {% else %}
                <i
                  class="ti ti-minus {% if change > 0 %}text-success{% elif change < 0 %}text-danger{% else %}text-warning{% endif %}"></i>
                {% endif %}
            </span>
            <p class="text-dark me-1 fs-3 mb-0">{% if change > 0 %}+{% endif %}{{ change|floatformat:1 }}%</p>
            <p class="fs-3 mb-0">å‰å¹´æ¯”</p>
          </div>
          {% endwith %}
          {% else %}
          <span class="text-muted small">å‰å¹´ãƒ‡ãƒ¼ã‚¿ãªã—</span>
          {% endif %}
          {% endwith %}
          {% else %}
          <span class="text-muted small">å‰å¹´ãƒ‡ãƒ¼ã‚¿ãªã—</span>
          {% endif %}
        </div>
        {% if monthly_summaries_total.sum_operating_profit|default:0 > 0 %}
        <div class="kpi-status good mt-2">ğŸ’° é»’å­—</div>
        {% else %}
        <div class="kpi-status danger mt-2">âš ï¸ èµ¤å­—</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- å€Ÿå…¥æ®‹é«˜ -->
  <div class="col-lg-3 col-md-6">
    <div class="card kpi-card kpi-debt">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">å€Ÿå…¥æ®‹é«˜</span>
          <div class="kpi-icon">
            <i class="ti ti-building-bank"></i>
          </div>
        </div>
        <h2 class="kpi-value" data-target="{{ debt_list_totals.total_balances_monthly.0|to_thousands|default:0 }}"
          data-suffix=" åƒå††">
          0 åƒå††
        </h2>
        <div class="text-muted small mb-2">
          {% if debt_list %}
          {{ debt_list|length }}ä»¶
          {% else %}
          0ä»¶
          {% endif %}
        </div>
        <div class="kpi-trend">
          {% if debt_list_totals.total_balances_monthly.0|default:0 > 0 %}
          <span class="text-muted small">é‡‘èæ©Ÿé–¢æ•°: {{ debt_list_byBank|length }}ç¤¾</span>
          {% else %}
          <span class="text-muted small">å€Ÿå…¥ãªã—</span>
          {% endif %}
        </div>
        {% if debt_list_totals.total_balances_monthly.0|default:0 > 0 %}
        <div class="kpi-status warning mt-2">ğŸ¦ ç®¡ç†è¦</div>
        {% else %}
        <div class="kpi-status good mt-2">âœ… å€Ÿå…¥ãªã—</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- åŠ é‡å¹³å‡é‡‘åˆ© -->
  <div class="col-lg-3 col-md-6">
    <div class="card kpi-card kpi-interest">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">åŠ é‡å¹³å‡é‡‘åˆ©</span>
          <div class="kpi-icon">
            <i class="ti ti-percentage"></i>
          </div>
        </div>
        <h2 class="kpi-value" data-target="{{ weighted_average_interest.0|default:0 }}" data-type="percentage"
          data-suffix="%">
          0.00%
        </h2>
        <div class="text-muted small mb-2">å…¨å€Ÿå…¥ã®å¹³å‡</div>
        <div class="kpi-trend">
          {% if weighted_average_interest.0|default:0 > 0 %}
          {% if weighted_average_interest.0|default:0 < 2.0 %} <span class="kpi-status good">ğŸ“‰ ä½é‡‘åˆ©</span>
            {% elif weighted_average_interest.0|default:0 < 4.0 %} <span class="kpi-status warning">ğŸ“Š æ¨™æº–</span>
              {% else %}
              <span class="kpi-status danger">ğŸ“ˆ é«˜é‡‘åˆ©</span>
              {% endif %}
              {% else %}
              <span class="text-muted small">ãƒ‡ãƒ¼ã‚¿ãªã—</span>
              {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- äºˆç®—é”æˆçŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚²ãƒ¼ã‚¸ãƒãƒ£ãƒ¼ãƒˆï¼‰ -->
{% if budget_achievement.elapsed_months > 0 and budget_achievement.sales is not None and budget_achievement.operating_profit is not None %}
<div class="row g-3 mb-4 dashboard-section">
  <!-- å£²ä¸Šé«˜äºˆç®—é”æˆç‡ -->
  <div class="col-lg-6 col-md-6">
    <div class="card kpi-card kpi-sales">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">å£²ä¸Šé«˜äºˆç®—é”æˆçŠ¶æ³</span>
          <i class="ti ti-target kpi-icon"></i>
        </div>
        <div class="gauge-chart-container">
          <div id="salesBudgetGauge" style="min-height: 200px;"></div>
          <div class="gauge-chart-info">
            <div class="gauge-chart-value">
              <span class="gauge-value-main" data-target="{{ budget_achievement.sales|default:0 }}"
                data-type="percentage">0.00</span>
              <span class="gauge-value-unit">%</span>
            </div>
            <div class="gauge-chart-label">äºˆç®—é”æˆç‡ï¼ˆ{{ budget_achievement.elapsed_months }}ãƒ¶æœˆçµŒéï¼‰</div>
            {% if budget_achievement.sales_forecast %}
            <div class="gauge-chart-forecast">
              <div class="forecast-label">ç€åœ°è¦‹è¾¼ã¿</div>
              <div class="forecast-value" data-target="{{ budget_achievement.sales_forecast|default:0 }}">0</div>
              <div class="forecast-unit">åƒå††</div>
              {% if budget_year.sales %}
              {% with forecast_ratio=budget_achievement.sales_forecast|divide:budget_year.sales|multiply:100 %}
              <div
                class="forecast-ratio {% if forecast_ratio >= 100 %}text-success{% elif forecast_ratio >= 90 %}text-warning{% else %}text-danger{% endif %}">
                {% if forecast_ratio >= 100 %}
                +{{ forecast_ratio|subtract:100|floatformat:1 }}%
                {% else %}
                {{ forecast_ratio|subtract:100|floatformat:1 }}%
                {% endif %}
                äºˆç®—æ¯”
              </div>
              {% endwith %}
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å–¶æ¥­åˆ©ç›Šäºˆç®—é”æˆç‡ -->
  <div class="col-lg-6 col-md-6">
    <div class="card kpi-card kpi-profit">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="kpi-label">å–¶æ¥­åˆ©ç›Šäºˆç®—é”æˆçŠ¶æ³</span>
          <i class="ti ti-target kpi-icon"></i>
        </div>
        <div class="gauge-chart-container">
          <div id="profitBudgetGauge" style="min-height: 200px;"></div>
          <div class="gauge-chart-info">
            <div class="gauge-chart-value">
              <span class="gauge-value-main" data-target="{{ budget_achievement.operating_profit|default:0 }}"
                data-type="percentage">0.00</span>
              <span class="gauge-value-unit">%</span>
            </div>
            <div class="gauge-chart-label">äºˆç®—é”æˆç‡ï¼ˆ{{ budget_achievement.elapsed_months }}ãƒ¶æœˆçµŒéï¼‰</div>
            {% if budget_achievement.operating_profit_forecast %}
            <div class="gauge-chart-forecast">
              <div class="forecast-label">ç€åœ°è¦‹è¾¼ã¿</div>
              <div class="forecast-value" data-target="{{ budget_achievement.operating_profit_forecast|default:0 }}">0
              </div>
              <div class="forecast-unit">åƒå††</div>
              {% if budget_year.operating_profit %}
              {% with forecast_ratio=budget_achievement.operating_profit_forecast|divide:budget_year.operating_profit|multiply:100 %}
              <div
                class="forecast-ratio {% if forecast_ratio >= 100 %}text-success{% elif forecast_ratio >= 90 %}text-warning{% else %}text-danger{% endif %}">
                {% if forecast_ratio >= 100 %}
                +{{ forecast_ratio|subtract:100|floatformat:1 }}%
                {% else %}
                {{ forecast_ratio|subtract:100|floatformat:1 }}%
                {% endif %}
                äºˆç®—æ¯”
              </div>
              {% endwith %}
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ™‚ã®é‡è¤‡ä½œæˆã‚’é˜²ãï¼‰
    if (window.budgetGaugeChartsInitialized) {
      return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    }
    window.budgetGaugeChartsInitialized = true;

    function initBudgetGauges() {
      // ApexChartsãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
      if (typeof ApexCharts === 'undefined') {
        console.warn('ApexCharts is not loaded');
        return;
      }

      // å£²ä¸Šé«˜äºˆç®—é”æˆç‡ã‚²ãƒ¼ã‚¸
      const salesElement = document.getElementById('salesBudgetGauge');
      if (salesElement && !salesElement._apexChart) {
        const salesAchievement = {{ budget_achievement.sales|default:0 }};
    const salesColor = salesAchievement >= 100 ? '#13DEB9' : salesAchievement >= 90 ? '#FFAE1F' : '#FA896B';

    const salesOptions = {
      series: [salesAchievement],
      chart: {
        type: 'radialBar',
        height: 200,
        offsetY: 0,
        sparkline: {
          enabled: false
        }
      },
      plotOptions: {
        radialBar: {
          startAngle: -90,
          endAngle: 90,
          hollow: {
            size: '75%',
            background: 'transparent'
          },
          track: {
            show: true,
            background: '#E8E8E8',
            strokeWidth: '97%',
            opacity: 1,
            margin: 5
          },
          dataLabels: {
            show: false
          }
        }
      },
      fill: {
        type: 'solid',
        colors: [salesColor]
      },
      stroke: {
        lineCap: 'round'
      },
      labels: ['é”æˆç‡'],
      colors: [salesColor],
      animations: {
        enabled: false
      }
    };

    const salesChart = new ApexCharts(salesElement, salesOptions);
    salesElement._apexChart = salesChart;
    salesChart.render();
  }

      // å–¶æ¥­åˆ©ç›Šäºˆç®—é”æˆç‡ã‚²ãƒ¼ã‚¸
      const profitElement = document.getElementById('profitBudgetGauge');
  if (profitElement && !profitElement._apexChart) {
    const profitAchievement = {{ budget_achievement.operating_profit|default:0 }};
  const profitColor = profitAchievement >= 100 ? '#13DEB9' : profitAchievement >= 90 ? '#FFAE1F' : '#FA896B';

  const profitOptions = {
    series: [profitAchievement],
    chart: {
      type: 'radialBar',
      height: 200,
      offsetY: 0,
      sparkline: {
        enabled: false
      }
    },
    plotOptions: {
      radialBar: {
        startAngle: -90,
        endAngle: 90,
        hollow: {
          size: '75%',
          background: 'transparent'
        },
        track: {
          show: true,
          background: '#E8E8E8',
          strokeWidth: '97%',
          opacity: 1,
          margin: 5
        },
        dataLabels: {
          show: false
        }
      }
    },
    fill: {
      type: 'solid',
      colors: [profitColor]
    },
    stroke: {
      lineCap: 'round'
    },
    labels: ['é”æˆç‡'],
    colors: [profitColor],
    animations: {
      enabled: false
    }
  };

  const profitChart = new ApexCharts(profitElement, profitOptions);
  profitElement._apexChart = profitChart;
  profitChart.render();
      }
  }

  // ã‚²ãƒ¼ã‚¸å†…ã®æ•°å€¤ã‚’è¨­å®šï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼‰
  function initGaugeAnimations() {
    // ã‚²ãƒ¼ã‚¸å†…ã®æ•°å€¤
    const gaugeValues = document.querySelectorAll('.gauge-value-main[data-target]');
    gaugeValues.forEach((element) => {
      const targetValue = parseFloat(element.getAttribute('data-target')) || 0;
      const isPercentage = element.getAttribute('data-type') === 'percentage';

      // å€¤ã‚’ç›´æ¥è¨­å®š
      if (isPercentage) {
        element.textContent = targetValue.toFixed(2);
      } else {
        element.textContent = targetValue.toLocaleString('ja-JP');
      }
    });

    // ç€åœ°è¦‹è¾¼ã¿ã®æ•°å€¤
    const forecastValues = document.querySelectorAll('.forecast-value[data-target]');
    forecastValues.forEach((element) => {
      const targetValue = parseFloat(element.getAttribute('data-target')) || 0;
      // å€¤ã‚’ç›´æ¥è¨­å®š
      element.textContent = targetValue.toLocaleString('ja-JP');
    });
  }

  // DOMContentLoadedã¨window.loadã®ä¸¡æ–¹ã§åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function () {
        initBudgetGauges();
        setTimeout(initGaugeAnimations, 200);
      }, 100);
    });
  } else {
    setTimeout(function () {
      initBudgetGauges();
      setTimeout(initGaugeAnimations, 200);
    }, 100);
  }

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†
  let resizeTimer;
  window.addEventListener('resize', function () {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function () {
      const salesElement = document.getElementById('salesBudgetGauge');
      const profitElement = document.getElementById('profitBudgetGauge');
      if (salesElement && salesElement._apexChart) {
        salesElement._apexChart.updateOptions({}, false, false, false);
      }
      if (profitElement && profitElement._apexChart) {
        profitElement._apexChart.updateOptions({}, false, false, false);
      }
    }, 250);
  });
}) ();
</script>
{% endif %}