{% load static %}
{% load humanize %}
{% load custom_filters %}

<!-- KPIカードセクション（Pencil Design System準拠）-->
<!-- 4つのKPIカード: 売上高、営業利益、借入残高、加重平均金利 -->
<div class="row g-4 mb-4 dashboard-section pencil-metric-row">
  <!-- 売上高（今期） -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card kpi-card kpi-sales">
      <div class="card-body">
        <span class="kpi-label">売上高（今期）</span>
        <h2 class="kpi-value" data-target="{{ monthly_summaries_total.sum_sales|default:0 }}" data-suffix=" 千円">
          0 千円
        </h2>
        <div class="kpi-change {% if monthly_summaries_total_last_year.sum_sales|default:0 > 0 %}{% with current=monthly_summaries_total.sum_sales|default:0 previous=monthly_summaries_total_last_year.sum_sales|default:1 %}{% with change=current|divide:previous|multiply:100|subtract:100 %}{% if change > 0 %}positive{% elif change < 0 %}negative{% else %}neutral{% endif %}{% endwith %}{% endwith %}{% else %}neutral{% endif %}">
          {% if monthly_summaries_total_last_year.year and monthly_summaries_total_last_year.sum_sales|default:0 > 0 %}
          {% with current=monthly_summaries_total.sum_sales|default:0 previous=monthly_summaries_total_last_year.sum_sales|default:1 %}
          {% if previous > 0 %}
          {% with change=current|divide:previous|multiply:100|subtract:100 %}
          <i class="ti {% if change > 0 %}ti-trending-up{% elif change < 0 %}ti-trending-down{% else %}ti-minus{% endif %}"></i>
          <span>{% if change > 0 %}+{% endif %}{{ change|floatformat:1 }}% 前年比</span>
          {% endwith %}
          {% else %}
          <i class="ti ti-minus"></i>
          <span>前年データなし</span>
          {% endif %}
          {% endwith %}
          {% else %}
          <i class="ti ti-minus"></i>
          <span>前年データなし</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 営業利益（今期） -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card kpi-card kpi-profit">
      <div class="card-body">
        <span class="kpi-label">営業利益（今期）</span>
        <h2 class="kpi-value" data-target="{{ monthly_summaries_total.sum_operating_profit|default:0 }}" data-suffix=" 千円">
          0 千円
        </h2>
        <div class="kpi-change {% if monthly_summaries_total_last_year.sum_operating_profit|default:0 > 0 %}{% with current=monthly_summaries_total.sum_operating_profit|default:0 previous=monthly_summaries_total_last_year.sum_operating_profit|default:1 %}{% with change=current|divide:previous|multiply:100|subtract:100 %}{% if change > 0 %}positive{% elif change < 0 %}negative{% else %}neutral{% endif %}{% endwith %}{% endwith %}{% else %}neutral{% endif %}">
          {% if monthly_summaries_total_last_year.year and monthly_summaries_total_last_year.sum_operating_profit|default:0 > 0 %}
          {% with current=monthly_summaries_total.sum_operating_profit|default:0 previous=monthly_summaries_total_last_year.sum_operating_profit|default:1 %}
          {% if previous > 0 %}
          {% with change=current|divide:previous|multiply:100|subtract:100 %}
          <i class="ti {% if change > 0 %}ti-trending-up{% elif change < 0 %}ti-trending-down{% else %}ti-minus{% endif %}"></i>
          <span>{% if change > 0 %}+{% endif %}{{ change|floatformat:1 }}% 前年比</span>
          {% endwith %}
          {% else %}
          <i class="ti ti-minus"></i>
          <span>前年データなし</span>
          {% endif %}
          {% endwith %}
          {% else %}
          <i class="ti ti-minus"></i>
          <span>前年データなし</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 借入残高 -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card kpi-card kpi-debt">
      <div class="card-body">
        <span class="kpi-label">借入残高</span>
        <h2 class="kpi-value" data-target="{{ debt_list_totals.total_balances_monthly.0|to_thousands|default:0 }}" data-suffix=" 千円">
          0 千円
        </h2>
        <div class="kpi-change neutral">
          <i class="ti ti-trending-down"></i>
          {% if debt_list_totals.total_balances_monthly.0|default:0 > 0 %}
          <span>{{ debt_list|length|default:0 }}件 / {{ debt_list_byBank|length }}社</span>
          {% else %}
          <span>借入なし</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- 加重平均金利 -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card kpi-card kpi-interest">
      <div class="card-body">
        <span class="kpi-label">加重平均金利</span>
        <h2 class="kpi-value" data-target="{{ weighted_average_interest.0|default:0 }}" data-type="percentage" data-suffix="%">
          0.00%
        </h2>
        <div class="kpi-change neutral">
          <i class="ti ti-minus"></i>
          <span>全借入の平均</span>
        </div>
      </div>
    </div>
  </div>
</div>
