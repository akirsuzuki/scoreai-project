{% extends "scoreai/base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
{{ title }}
{% endblock %}

{% block head %}
 <!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'scoreai/js/chart_colors.js' %}"></script>
{% endblock %}

{% block breadcrumb %}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="fw-semibold mb-0">借入管理</h4>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'debts_all' %}" class="btn btn-outline-primary btn-sm">借入一覧</a>
        <a href="{% url 'debts_byBank' %}" class="btn btn-outline-primary btn-sm">金融機関別</a>
        <a href="{% url 'debts_bySecuredType' %}" class="btn btn-outline-primary btn-sm">保証別</a>
        <a href="{% url 'debts_archived' %}" class="btn btn-primary btn-sm">アーカイブ済み</a>
      </div>
    </div>
  </div>
  <div class="col-lg-12 d-flex align-items-stretch">
    <div class="card w-100">
      <div class="card-header">
          <h5 class="card-title fw-semibold">アーカイブ済み</h5>
        </div>
        <div class="card-body">
          <table id="archived_debt_list" class="display nowrap w-100">
            <thead>
              <tr>
                <th>金融機関</th>
                <th>元本(千円)</th>
                <th>保証</th>
                <th>利息</th>
                <th>実行日</th>
                <th>返済開始日</th>
                <th>月返済額</th>
                <th>代表者保証</th>
                <th>担保</th>
                <th>メモ</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debt_list_nodisplay %}
              <tr data-href="{% url 'debt_detail' debt.id %}">
                <td>{{ debt.financial_institution.short_name }}</td>
                <td>{{ debt.principal|to_thousands|intcomma}}</td>
                <td>{{ debt.secured_type }}</td>
                <td>{{ debt.interest_rate }}%</td>
                <td>{{ debt.issue_date|date:"y年n月" }}</td>
                <td>{{ debt.start_date|date:"y年n月" }}</td>
                <td>{{ debt.monthly_repayment|to_thousands|intcomma }}</td>
                <td>
                  {% if debt.is_securedby_management %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-light text-muted">なし</span>
                  {% endif %}
                </td>
                <td>
                  {% if debt.is_collateraled %}
                    <span class="badge bg-info">あり</span>
                  {% else %}
                    <span class="badge bg-light text-muted">なし</span>
                  {% endif %}
                </td>
                <td>{{ debt.memo_short }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="1" style="text-align:right">合計：</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>



  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = new DataTable('#archived_debt_list', {
        responsive: false,
        scrollX: true,
        scrollCollapse: true,
        autoWidth: false,
        pageLength: 25,
        pagingType: 'full_numbers',
        language: {
          url: 'https://cdn.datatables.net/plug-ins/2.0.8/i18n/ja.json'
        },
        footerCallback: function (row, data, start, end, display) {
          let api = this.api();
          let intVal = function (i) {
            return typeof i === 'string'
              ? i.replace(/[\$,]/g, '') * 1
              : typeof i === 'number'
                ? i
                : 0;
          };
          
          // 元本の合計
          let principalTotal = api
            .column(1)
            .data()
            .reduce((a, b) => intVal(a) + intVal(b), 0);
          
          // 月返済額の合計
          let monthlyRepaymentTotal = api
            .column(6)
            .data()
            .reduce((a, b) => intVal(a) + intVal(b), 0);
          
          // フッターに表示
          $(api.column(1).footer()).html(principalTotal.toLocaleString('ja-JP'));
          $(api.column(6).footer()).html(monthlyRepaymentTotal.toLocaleString('ja-JP'));
        }
      });

      // 行クリックで詳細ページに遷移
      table.on('draw', function () {
        const rows = document.querySelectorAll('#archived_debt_list tbody tr');
        rows.forEach(row => {
          row.addEventListener('click', function () {
            const href = this.getAttribute('data-href');
            if (href) {
              window.location.href = href;
            }
          });
        });
      });
    });
  </script>




{% endblock %}