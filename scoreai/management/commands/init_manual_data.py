"""
マニュアルの初期データを作成するコマンド
"""
from django.core.management.base import BaseCommand
from scoreai.models import Manual


class Command(BaseCommand):
    help = 'マニュアルの初期データを作成します'

    def handle(self, *args, **options):
        self.stdout.write('マニュアルの初期データを作成しています...')
        
        # 既存のデータをクリア（オプション）
        # Manual.objects.all().delete()
        
        manuals_data = [
            # 会社ユーザー（一般）用マニュアル
            {
                'user_type': 'company_user',
                'category': 'getting_started',
                'order': 1,
                'title': 'はじめに - SCore_Aiの基本',
                'content': '''SCore_Aiへようこそ！

このマニュアルでは、SCore_Aiの基本的な使い方を順番に説明します。

## SCore_Aiとは
SCore_Aiは、中小企業向けの財務管理・分析プラットフォームです。以下の機能を提供します：
- 月次・年次財務データの管理
- 予算vs実績の比較分析
- AIを活用した財務分析・アドバイス
- 借入管理
- 株主情報管理

## このマニュアルの使い方
このマニュアルは、カテゴリ別に整理されています。順番に読むことで、一通りの操作ができるようになります。

次のステップ：ダッシュボードの見方を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'dashboard',
                'order': 1,
                'title': 'ダッシュボードの見方',
                'content': '''ダッシュボードでは、主要な財務指標を一目で確認できます。

## 主要なセクション

### PL月次推移
- 過去3年間の月次売上高・粗利益・営業利益をグラフで表示
- 最新年度の予算データも表示されます
- チェックボックスで粗利益・営業利益の表示/非表示を切り替え可能

### 予算実績比較
- 最新年度の予算と実績を比較
- 売上高、営業利益、経常利益の差異を表示
- 「詳細比較を見る」で月次比較ページへ
- 「AI分析」で予算分析ページへ

### 借入情報
- 現在の借入残高と平均金利を表示
- 金融機関別、担保タイプ別の内訳を表示

次のステップ：財務データの登録方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'financial_management',
                'order': 1,
                'title': '月次PLデータの登録',
                'content': '''月次PLデータを登録する手順です。

## 登録方法

1. サイドバーの「財務管理」→「月次PL」をクリック
2. 「新規登録」ボタンをクリック
3. 以下の情報を入力：
   - **Fiscal Summary Year**: 年度を選択（予算/実績の区別が表示されます）
   - **月度**: 1〜12の月を選択
   - **売上高**: 千円単位で入力
   - **粗利益**: 千円単位で入力
   - **営業利益**: 千円単位で入力
   - **経常利益**: 千円単位で入力

4. 「保存」ボタンをクリック

## 注意事項
- 年度を選択すると、自動的に予算/実績の区分が設定されます
- 予算の年度を選択した場合、is_budget=TRUEとして保存されます
- 実績の年度を選択した場合、is_budget=FALSEとして保存されます

次のステップ：年次財務諸表の登録方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'financial_management',
                'order': 2,
                'title': '年次財務諸表の登録',
                'content': '''年次財務諸表（BS・PL）を登録する手順です。

## 登録方法

1. サイドバーの「財務管理」→「年次財務諸表」をクリック
2. 「新規登録」ボタンをクリック
3. タブごとに情報を入力：

### 貸借対照表情報（BS）
- 流動資産：現金預金、売掛金、棚卸資産など
- 固定資産：土地、建物、機械装置など
- 流動負債：買掛金、短期借入金など
- 固定負債：長期借入金など
- 純資産：資本金、資本剰余金、利益剰余金など

### 損益計算書情報（PL）
- 売上高、売上原価、売上総利益
- 販売費及び一般管理費
- 営業利益、経常利益、当期純利益

4. 「保存」ボタンをクリック

## 注意事項
- すべての金額は千円単位で入力します
- 電卓アイコン（📱）をクリックすると、合計値が自動計算されます
- 予算/実績のチェックボックスで区分を設定します

次のステップ：予算管理の方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'budget_management',
                'order': 1,
                'title': '予算の作成と管理',
                'content': '''予算データを作成・管理する方法です。

## 予算の作成方法

### 方法1: 年次予算から月次予算を作成
1. サイドバーの「財務管理」→「予算管理」→「月次予算作成」をクリック
2. 年度を選択
3. 作成方法を選択：
   - **年間予算を12等分**: 年次予算を12で割って各月に配分
   - **前年実績の比率で配分**: 前年の実績比率に基づいて配分
4. 「上書き」チェックボックスを必要に応じて選択
5. 「作成」ボタンをクリック

### 方法2: AI予算策定を使用
1. サイドバーの「財務管理」→「予算管理」→「AI予算策定」をクリック
2. 年度、投資額、借入額などを入力
3. マイスクリプトを選択（オプション）
4. 「予算を生成」ボタンをクリック

## 予算vs実績の比較
- 「予算vs実績比較（月次）」で月次比較を確認
- 「予算vs実績比較（年次）」で年次比較を確認
- 「予算分析」でAI分析を実行

次のステップ：借入管理の方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'debt_management',
                'order': 1,
                'title': '借入情報の登録と管理',
                'content': '''借入情報を登録・管理する方法です。

## 借入の登録

1. サイドバーの「借入管理」をクリック
2. 「新規登録」ボタンをクリック
3. 以下の情報を入力：
   - **金融機関**: 借入先の金融機関
   - **借入金額**: 千円単位
   - **金利**: 年利（%）
   - **返済条件**: 返済期間、返済方法など
   - **担保タイプ**: 有担保/無担保

4. 「保存」ボタンをクリック

## 借入の管理
- 一覧画面で借入残高、金利、返済状況を確認
- 編集・削除は各借入の詳細画面から実行
- ダッシュボードで借入の合計値や平均金利を確認

次のステップ：AI相談機能の使い方を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'ai_consultation',
                'order': 1,
                'title': 'AI相談機能の使い方',
                'content': '''AIを活用した財務分析・アドバイス機能です。

## AI相談の使い方

1. サイドバーの「AI相談」→「AI相談センター」をクリック
2. 相談タイプを選択：
   - 予算策定
   - 財務分析
   - その他
3. マイスクリプトを選択（カスタマイズ可能）
4. 質問や相談内容を入力
5. 「送信」ボタンをクリック

## AI分析の内容
AIは以下の情報を自動的に分析します：
- 売上高、利益率の推移
- 借入状況
- 財務健全性
- 改善提案

## マイスクリプト
- システム管理者が作成したスクリプト
- 会社ユーザーが作成・編集できるスクリプト
- 相談タイプごとにカスタマイズ可能

次のステップ：データ取り込みの方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'data_import',
                'order': 1,
                'title': 'CSVデータの取り込み',
                'content': '''CSVファイルからデータを一括取り込みする方法です。

## CSV取り込みの手順

1. サイドバーの「データ取り込み」→「CSV取り込み」をクリック
2. 取り込みタイプを選択：
   - 月次PLデータ
   - 年次財務諸表データ
3. CSVファイルを選択（ドラッグ&ドロップも可能）
4. 「既存データを上書きする」チェックボックスを必要に応じて選択
5. 「アップロード」ボタンをクリック

## マネーフォワード専用フォーマット
- 「マネーフォワードから取り込み」を選択すると、専用フォーマットで取り込み可能
- マネーフォワードのエクスポートデータをそのまま使用できます

## 注意事項
- CSVファイルの形式は、システムが要求する形式に準拠してください
- 上書きモードでは、同じ年度・月度のデータが置き換えられます
- エラーが発生した場合は、エラーメッセージを確認して修正してください

次のステップ：その他データの管理方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'other_data',
                'order': 1,
                'title': '株主情報の管理',
                'content': '''株主情報を登録・管理する方法です。

## 株主情報の登録

1. サイドバーの「その他データ」→「株主情報」をクリック
2. 「新規登録」ボタンをクリック
3. 以下の情報を入力：
   - **株主名**: 株主の名前
   - **所有株式数**: 株数
   - **その他の情報**: 必要に応じて

4. 「保存」ボタンをクリック

## 株式発行の管理
- 「株式発行詳細」で株式発行履歴を確認
- 各発行イベントの詳細を管理

次のステップ：設定の変更方法を確認しましょう。''',
            },
            {
                'user_type': 'company_user',
                'category': 'settings',
                'order': 1,
                'title': '会社設定の変更',
                'content': '''会社の基本情報や設定を変更する方法です。

## 設定の変更

1. サイドバーの「設定」をクリック（または会社名をクリック）
2. 以下の情報を変更可能：
   - **会社名**: 会社の名称
   - **決算月**: 会計年度の終了月（1〜12）
   - **業種**: 業界大分類・小分類
   - **企業規模**: 小規模・中規模・大規模

## 注意事項
- 決算月を変更すると、月次データの表示順序が変わります
- 業種・規模を変更すると、ベンチマーク分析の基準が変わります

これで一通りの操作が完了です！''',
            },
            
            # 会社ユーザー（管理者）用マニュアル
            {
                'user_type': 'company_admin',
                'category': 'settings',
                'order': 1,
                'title': '会社メンバーの管理',
                'content': '''会社のメンバーを追加・削除・権限変更する方法です。

## メンバーの追加

1. サイドバーの「設定」→「会社メンバー管理」をクリック
2. 「メンバーを追加」ボタンをクリック
3. メールアドレスを入力して招待
4. 招待メールが送信されます

## メンバーの権限変更
- 管理者権限の付与/解除
- メンバーの削除

## 注意事項
- 管理者は、会社のすべてのデータにアクセスできます
- 一般ユーザーは、閲覧・編集権限が制限される場合があります

次のステップ：API設定を確認しましょう。''',
            },
            {
                'user_type': 'company_admin',
                'category': 'settings',
                'order': 2,
                'title': 'API設定',
                'content': '''AI機能で使用するAPIキーを設定する方法です。

## API設定

1. サイドバーの「設定」→「API設定」をクリック
2. APIプロバイダーを選択：
   - Google Gemini
   - OpenAI
3. APIキーを入力
4. 「保存」ボタンをクリック

## 注意事項
- APIキーは、会社のAPI利用上限を超えた場合に使用されます
- デフォルトでは、SCOREのAPIキーが使用されます
- APIキーは安全に管理してください

これで管理者向けの設定が完了です！''',
            },
            
            # Firmユーザー（一般）用マニュアル
            {
                'user_type': 'firm_user',
                'category': 'getting_started',
                'order': 1,
                'title': 'はじめに - Firmユーザー向けガイド',
                'content': '''Firmユーザー向けのSCore_Aiガイドです。

## Firmユーザーとは
Firmユーザーは、複数のクライアント企業を管理するコンサルティング会社や会計事務所などのユーザーです。

## 主な機能
- 複数のクライアント企業のデータを一元管理
- クライアント企業ごとの財務分析
- 一括でのデータ確認・比較

## このマニュアルの使い方
このマニュアルは、Firmユーザー向けの操作手順を説明します。

次のステップ：クライアント企業の管理方法を確認しましょう。''',
            },
            {
                'user_type': 'firm_user',
                'category': 'settings',
                'order': 1,
                'title': 'クライアント企業の管理',
                'content': '''クライアント企業を追加・管理する方法です。

## クライアント企業の追加

1. サイドバーの「設定」→「クライアント企業管理」をクリック
2. 「企業を追加」ボタンをクリック
3. 企業情報を入力：
   - 企業名
   - 決算月
   - 業種・規模
4. 「保存」ボタンをクリック

## クライアント企業の切り替え
- サイドバー上部の企業選択ドロップダウンから切り替え
- 選択した企業のデータが表示されます

次のステップ：クライアント企業のデータ確認方法を確認しましょう。''',
            },
            
            # Firmユーザー（管理者）用マニュアル
            {
                'user_type': 'firm_admin',
                'category': 'settings',
                'order': 1,
                'title': 'Firmメンバーの管理',
                'content': '''Firmのメンバーを追加・削除・権限変更する方法です。

## メンバーの追加

1. サイドバーの「設定」→「Firmメンバー管理」をクリック
2. 「メンバーを追加」ボタンをクリック
3. メールアドレスを入力して招待
4. 招待メールが送信されます

## メンバーの権限変更
- 管理者権限の付与/解除
- メンバーの削除
- クライアント企業へのアクセス権限の設定

## 注意事項
- 管理者は、Firmのすべてのクライアント企業にアクセスできます
- 一般ユーザーは、割り当てられたクライアント企業のみアクセス可能

これで管理者向けの設定が完了です！''',
            },
        ]
        
        created_count = 0
        for data in manuals_data:
            manual, created = Manual.objects.get_or_create(
                user_type=data['user_type'],
                category=data['category'],
                order=data['order'],
                defaults={
                    'title': data['title'],
                    'content': data['content'],
                    'is_active': True,
                }
            )
            if created:
                created_count += 1
                self.stdout.write(
                    self.style.SUCCESS(f'✓ マニュアルを作成: {manual.title}')
                )
            else:
                self.stdout.write(
                    self.style.WARNING(f'- 既に存在: {manual.title}')
                )
        
        self.stdout.write(
            self.style.SUCCESS(f'\n完了: {created_count}件のマニュアルを作成しました。')
        )

