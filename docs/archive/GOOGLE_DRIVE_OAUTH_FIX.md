# Google OAuth認証エラー 403: access_denied の解決方法

## エラーの原因

「アクセスをブロック: SCORE AI は Google の審査プロセスを完了していません」というエラーは、OAuth同意画面が「テスト中」の状態で、使用しているGoogleアカウントが「テストユーザー」に追加されていないために発生します。

## 解決方法

### 方法1: テストユーザーに追加する（推奨：テスト環境）

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択
3. 左メニューから「**APIとサービス**」→「**OAuth同意画面**」を選択
4. 「**テストユーザー**」タブをクリック
5. 「**+ ユーザーを追加**」ボタンをクリック
6. 使用しているGoogleアカウントのメールアドレスを入力（例: `akirsuzuki@gmail.com`）
7. 「**追加**」をクリック
8. 再度認証を試みる

### 方法2: OAuth同意画面を公開する（本番環境のみ）

**注意**: 本番環境で一般公開する場合のみ使用してください。テスト環境では方法1を推奨します。

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択
3. 左メニューから「**APIとサービス**」→「**OAuth同意画面**」を選択
4. 「**公開**」ボタンをクリック
5. 確認ダイアログで「**公開**」をクリック
6. 再度認証を試みる

## 手順の詳細（方法1）

### ステップ1: OAuth同意画面にアクセス

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 上部のプロジェクト選択ドロップダウンから、SCORE AI用のプロジェクトを選択
3. 左メニューから「**APIとサービス**」をクリック
4. 「**OAuth同意画面**」をクリック

### ステップ2: テストユーザーを追加

1. OAuth同意画面の上部にあるタブから「**テストユーザー**」をクリック
2. 「**+ ユーザーを追加**」ボタンをクリック
3. メールアドレス入力欄に、使用しているGoogleアカウントのメールアドレスを入力
   - 例: `akirsuzuki@gmail.com`
4. 「**追加**」ボタンをクリック
5. 追加されたメールアドレスがリストに表示されることを確認

### ステップ3: 再度認証を試みる

1. SCORE AIの設定画面（`http://localhost:8000/storage/setting/`）に戻る
2. 「**Google Driveと連携**」ボタンを再度クリック
3. 今度は正常に認証画面が表示されるはずです

## 確認事項

### テストユーザーが正しく追加されているか確認

- OAuth同意画面の「テストユーザー」タブで、使用しているメールアドレスがリストに表示されているか確認
- メールアドレスのスペルミスがないか確認

### OAuth同意画面の状態を確認

- 「公開状態」が「テスト中」になっていることを確認（テスト環境の場合）
- もし「公開済み」になっている場合は、すべてのGoogleアカウントでアクセス可能です

## トラブルシューティング

### テストユーザーを追加してもエラーが続く場合

1. **ブラウザのキャッシュをクリア**
   - ブラウザの設定からキャッシュをクリア
   - または、シークレット/プライベートモードで試す

2. **Googleアカウントを確認**
   - 使用しているGoogleアカウントが正しいか確認
   - 別のGoogleアカウントで試す

3. **OAuth同意画面の設定を確認**
   - 「ユーザータイプ」が「外部」になっているか確認
   - 「公開状態」が「テスト中」になっているか確認

4. **時間をおいて再試行**
   - 設定変更が反映されるまで数分かかる場合があります
   - 5-10分待ってから再度試す

## 参考

- [OAuth同意画面の設定](https://support.google.com/cloud/answer/10311615)
- [テストユーザーの追加](https://support.google.com/cloud/answer/10311615#test-users)

