# テストガイド

## 実装された機能のテスト手順

### 1. 環境セットアップ

#### 1.1 必要なライブラリのインストール確認

```bash
docker compose exec django pip install -r requirements.txt
```

確認すべきライブラリ:
- `chardet` (CSVエンコーディング検出)
- `google-generativeai` (Gemini API)
- `google-cloud-vision` (Vision API)
- `pdf2image` (PDF処理)
- `Pillow` (画像処理)

#### 1.2 環境変数の設定

`score/local_settings.py`に以下を追加:

```python
# Google Gemini API
GEMINI_API_KEY = 'your-gemini-api-key'

# Google Cloud Vision API（サービスアカウントキーのパス）
GOOGLE_APPLICATION_CREDENTIALS = '/path/to/service-account-key.json'

# または、APIキーの場合（開発環境のみ）
GOOGLE_CLOUD_VISION_API_KEY = 'your-vision-api-key'
GOOGLE_CLOUD_PROJECT_ID = 'your-project-id'
```

### 2. CSV取り込み機能のテスト

#### 2.1 エンコーディング自動検出のテスト

**テストケース1: Shift-JISエンコーディング**
1. マネーフォワードからShift-JIS形式のCSVをエクスポート
2. 月次PL CSV取り込み画面にアクセス
3. CSVファイルをアップロード
4. エンコーディングが自動検出されることを確認
5. データが正常にインポートされることを確認

**テストケース2: UTF-8エンコーディング**
1. CSVファイルをUTF-8に変換
2. 同様の手順でアップロード
3. UTF-8が自動検出されることを確認

**テストケース3: エンコーディング検出失敗**
1. 不正なエンコーディングのファイルをアップロード
2. 適切なエラーメッセージが表示されることを確認

#### 2.2 プレビュー機能のテスト

**テストケース1: プレビューボタンの動作**
1. 月次PL CSV取り込み画面にアクセス
2. CSVファイルを選択
3. 「プレビュー」ボタンをクリック
4. 以下が表示されることを確認:
   - 検出されたエンコーディング
   - 総行数
   - 最初の10行のデータ
5. データが保存されていないことを確認

**テストケース2: アップロードボタンの動作**
1. プレビュー後、「アップロード」ボタンをクリック
2. データが正常に保存されることを確認

#### 2.3 エラーハンドリングのテスト

**テストケース1: 空のCSVファイル**
1. 空のCSVファイルをアップロード
2. 「CSVファイルが空です」というエラーメッセージが表示されることを確認

**テストケース2: 不正な構造のCSV**
1. 必須列が不足しているCSVをアップロード
2. 適切なエラーメッセージが表示されることを確認

**テストケース3: 数値パースエラー**
1. 数値以外の値が含まれるCSVをアップロード
2. 行番号と列番号を含むエラーメッセージが表示されることを確認

**テストケース4: 複数のエラー**
1. 複数のエラーを含むCSVをアップロード
2. 最大10件のエラーが表示され、それ以上は件数のみ表示されることを確認

### 3. Google Gemini API機能のテスト

#### 3.1 AIチャット機能のテスト

**テストケース1: 正常なリクエスト**
1. ダッシュボード（IndexView）にアクセス
2. チャットフォームに質問を入力
3. 「送信」ボタンをクリック
4. Gemini APIからの応答が表示されることを確認

**テストケース2: APIキー未設定**
1. `GEMINI_API_KEY`を未設定にする
2. チャット機能を使用
3. 適切なエラーメッセージが表示されることを確認

**テストケース3: ネットワークエラー**
1. ネットワーク接続を切断（またはAPIキーを無効化）
2. チャット機能を使用
3. 適切なエラーメッセージが表示されることを確認

### 4. OCR機能のテスト

#### 4.1 画像からのOCR

**テストケース1: PNG画像**
1. OCR読み込み画面にアクセス
2. 決算書のPNG画像をアップロード
3. OCR処理が実行されることを確認
4. 抽出されたテキストが表示されることを確認
5. パースされたデータが保存されることを確認

**テストケース2: JPEG画像**
1. 決算書のJPEG画像をアップロード
2. 同様の手順でテスト

#### 4.2 PDFからのOCR

**テストケース1: PDFファイル**
1. 決算書のPDFファイルをアップロード
2. PDFが画像に変換されることを確認
3. 各ページからOCRが実行されることを確認
4. 抽出されたテキストが結合されることを確認

#### 4.3 データパースのテスト

**テストケース1: 年度の自動検出**
1. 年度情報が含まれる決算書をアップロード
2. 年度が自動検出されることを確認

**テストケース2: 数値の抽出**
1. 売上高、利益などの数値が含まれる決算書をアップロード
2. 数値が正しく抽出されることを確認

**テストケース3: パース失敗**
1. OCRで抽出されたテキストから年度や数値が検出できない場合
2. 適切なエラーメッセージが表示されることを確認

### 5. 統合テスト

#### 5.1 エンドツーエンドテスト

**シナリオ1: 月次PL CSV取り込みの完全フロー**
1. ログイン
2. 会社を選択
3. 月次PL CSV取り込み画面にアクセス
4. CSVファイルを選択
5. プレビューで確認
6. アップロードを実行
7. データが正常に保存されることを確認
8. 月次PL一覧画面でデータが表示されることを確認

**シナリオ2: OCR読み込みの完全フロー**
1. ログイン
2. 会社を選択
3. OCR読み込み画面にアクセス
4. 決算書ファイルをアップロード
5. OCR処理が完了するまで待機
6. データが正常に保存されることを確認
7. 年度別財務サマリー一覧画面でデータが表示されることを確認

### 6. パフォーマンステスト

#### 6.1 大量データの処理

**テストケース1: 大きなCSVファイル**
1. 1000行以上のCSVファイルをアップロード
2. 処理時間を測定
3. タイムアウトが発生しないことを確認

**テストケース2: 複数ページのPDF**
1. 10ページ以上のPDFファイルをアップロード
2. 処理時間を測定
3. すべてのページが処理されることを確認

### 7. エラーログの確認

テスト中に発生したエラーは、以下のログで確認できます:

```bash
# Dockerコンテナ内のログを確認
docker compose logs django

# または、リアルタイムでログを確認
docker compose logs -f django
```

### 8. よくある問題と対処法

#### 8.1 CSVエンコーディング検出が失敗する

**原因**: `chardet`ライブラリがインストールされていない、またはファイルが破損している

**対処法**:
```bash
docker compose exec django pip install chardet
```

#### 8.2 Gemini APIエラー

**原因**: APIキーが設定されていない、または無効

**対処法**:
- `local_settings.py`に`GEMINI_API_KEY`が正しく設定されているか確認
- APIキーが有効か確認（[Google AI Studio](https://makersuite.google.com/app/apikey)で確認）

#### 8.3 Vision APIエラー

**原因**: サービスアカウントキーが設定されていない、または権限が不足

**対処法**:
- `GOOGLE_APPLICATION_CREDENTIALS`が正しく設定されているか確認
- サービスアカウントに「Cloud Vision API User」ロールが付与されているか確認
- Cloud Vision APIが有効化されているか確認

#### 8.4 PDF処理エラー

**原因**: `poppler-utils`がインストールされていない

**対処法**:
```bash
# Dockerfileにpoppler-utilsが含まれているか確認
# 含まれていない場合は、Dockerfileを再ビルド
docker compose build
```

### 9. テストチェックリスト

- [ ] CSVエンコーディング自動検出（Shift-JIS）
- [ ] CSVエンコーディング自動検出（UTF-8）
- [ ] CSVプレビュー機能
- [ ] CSVエラーハンドリング（空ファイル）
- [ ] CSVエラーハンドリング（不正な構造）
- [ ] CSVエラーハンドリング（数値パースエラー）
- [ ] Gemini APIチャット機能
- [ ] Gemini APIエラーハンドリング
- [ ] OCR画像読み込み（PNG）
- [ ] OCR画像読み込み（JPEG）
- [ ] OCR PDF読み込み
- [ ] OCRデータパース（年度検出）
- [ ] OCRデータパース（数値抽出）
- [ ] 統合テスト（月次PL CSV）
- [ ] 統合テスト（OCR読み込み）

### 10. テスト結果の記録

テスト結果は以下の形式で記録してください:

```
テスト日時: YYYY-MM-DD HH:MM:SS
テスト項目: [テストケース名]
結果: [成功/失敗]
エラー内容: [エラーが発生した場合の詳細]
```

