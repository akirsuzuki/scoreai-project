# メニュー再設計提案書

## 現状分析

### 現在のメニュー構成の問題点
1. AI機能が目立たない（チャット機能がダッシュボードに埋もれている）
2. 相談の種類が明確でない（財務相談のみ）
3. スクリプト（プロンプト）の管理機能がない
4. ユーザーごとのカスタマイズ機能がない

## 提案する新しいメニュー構成

### 1. メインメニュー構造

```
📊 ダッシュボード
   └─ 財務サマリー、借入情報、主要指標

🤖 AI相談センター（新設・目立つ位置）
   ├─ 💰 財務相談
   ├─ 💼 補助金相談
   ├─ 📋 税務相談
   ├─ ⚖️ 法律相談
   └─ ⚙️ 相談設定（スクリプト管理）

📈 財務データ管理
   ├─ 年度別財務サマリー
   ├─ 月次推移PL
   ├─ CSV取り込み
   │   ├─ 月次PL（Money Forward）
   │   ├─ 年次決算（Money Forward）
   │   └─ OCR読み込み
   └─ 借入情報管理

🏢 会社情報
   └─ 会社詳細・編集

👥 顧客管理（コンサルタント向け）
   └─ 顧客一覧・追加

📊 業界比較
   └─ 業界ベンチマーク

📝 議事録管理
   └─ 議事録一覧・作成

⚙️ 設定
   ├─ プロフィール
   ├─ マイスクリプト（ユーザー独自の相談スクリプト）
   └─ システム設定（管理者のみ）
       └─ AIスクリプト管理（システム全体のスクリプト）
```

## デザイン提案

### 1. AI相談センターのデザイン

#### レイアウト
```
┌─────────────────────────────────────────────────────────┐
│  🤖 AI相談センター                                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  💰 財務相談  │  │  💼 補助金相談 │  │  📋 税務相談  │ │
│  │              │  │              │  │              │ │
│  │  決算書データ │  │  業種・規模   │  │  税務情報    │ │
│  │  を基に分析  │  │  を基に提案  │  │  を基に提案  │ │
│  │              │  │              │  │              │ │
│  │  [相談開始]  │  │  [相談開始]  │  │  [相談開始]  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │  ⚖️ 法律相談  │  │  ⚙️ 相談設定  │                    │
│  │              │  │              │                    │
│  │  契約・法務  │  │  スクリプト  │                    │
│  │  を基に提案  │  │  管理        │                    │
│  │              │  │              │                    │
│  │  [相談開始]  │  │  [設定]      │                    │
│  └──────────────┘  └──────────────┘                    │
└─────────────────────────────────────────────────────────┘
```

#### 相談画面のデザイン
```
┌─────────────────────────────────────────────────────────┐
│  💰 財務相談                                             │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  【利用可能なデータ】                                    │
│  ✓ 決算書データ（2024年度）                              │
│  ✓ 借入情報（3件）                                       │
│  ✓ 月次推移データ                                        │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 相談内容を入力してください                        │  │
│  │                                                  │  │
│  │  例: 「今期の着地予測をしてください」            │  │
│  │                                                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  [送信]                                                  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  🤖 AI応答                                        │  │
│  │                                                  │  │
│  │  あなたの決算書データを分析した結果...           │  │
│  │                                                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  [新しい相談を開始]  [スクリプトをカスタマイズ]         │
└─────────────────────────────────────────────────────────┘
```

### 2. サイドバーメニューの改善

#### 改善前（現在）
- メニュー項目がフラット
- AI機能が目立たない
- アイコンが少ない

#### 改善後（提案）
```
┌─────────────────────┐
│  📊 ダッシュボード    │
│  🤖 AI相談センター   │ ← 目立つデザイン（バッジ付き）
│  📈 財務データ管理    │
│  🏢 会社情報          │
│  👥 顧客管理          │
│  📊 業界比較          │
│  📝 議事録管理        │
│  ⚙️ 設定              │
└─────────────────────┘
```

## 機能実装提案

### 1. AIスクリプト管理機能

#### データモデル
```python
class AIConsultationType(models.Model):
    """相談タイプ（財務、補助金、税務、法律など）"""
    name = models.CharField(max_length=50)  # "財務相談"
    icon = models.CharField(max_length=20)  # "💰"
    description = models.TextField()
    is_active = models.BooleanField(default=True)
    order = models.IntegerField(default=0)

class AIConsultationScript(models.Model):
    """AI相談スクリプト（システム全体用）"""
    consultation_type = models.ForeignKey(AIConsultationType)
    system_instruction = models.TextField()  # システムプロンプト
    default_prompt_template = models.TextField()  # デフォルトプロンプトテンプレート
    is_default = models.BooleanField(default=True)
    created_by = models.ForeignKey(User)  # 管理者
    updated_at = models.DateTimeField(auto_now=True)

class UserAIConsultationScript(models.Model):
    """ユーザー独自のAI相談スクリプト"""
    user = models.ForeignKey(User)
    consultation_type = models.ForeignKey(AIConsultationType)
    system_instruction = models.TextField()
    prompt_template = models.TextField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

### 2. 相談タイプ別のデータ連携

#### 財務相談
- 決算書データ（FiscalSummary_Year, FiscalSummary_Month）
- 借入情報（Debt）
- 業界比較データ（IndustryBenchmark）

#### 補助金相談
- 会社情報（Company: 業種、規模、所在地）
- 決算書データ（売上、従業員数など）
- 補助金マスタデータ（新規作成）

#### 税務相談
- 決算書データ
- 会社情報（法人種別、設立年月日など）
- 税務関連データ（新規作成）

#### 法律相談
- 会社情報
- 契約情報（新規作成）
- 法務関連データ（新規作成）

## 実装ステップ

### Phase 1: メニュー再構成
1. サイドバーメニューの再設計
2. AI相談センターの新設
3. アイコンの追加

### Phase 2: AIスクリプト管理機能
1. データモデルの作成
2. 管理者用スクリプト編集画面
3. ユーザー用スクリプト編集画面

### Phase 3: 相談タイプの追加
1. 財務相談の改善
2. 補助金相談の実装
3. 税務相談の実装
4. 法律相談の実装

### Phase 4: データ連携の強化
1. 各相談タイプに必要なデータの収集
2. データをプロンプトに自動組み込み
3. 相談履歴の保存

## UI/UX改善提案

### 1. AI相談センターの目立たせ方
- サイドバーの上部に配置
- 目立つ色（例: グラデーション背景）
- 「新着」バッジを表示
- アニメーション効果

### 2. 相談カードのデザイン
- 各相談タイプをカード形式で表示
- アイコンと色で視覚的に区別
- 利用可能なデータ数を表示
- ホバーエフェクト

### 3. 相談画面の改善
- チャット形式のUI
- 相談履歴の表示
- データ参照機能（決算書データを参照しながら相談）
- 提案の保存機能

## 技術的な実装

### 1. プロンプトテンプレートシステム
```python
def build_consultation_prompt(
    consultation_type: str,
    user_message: str,
    company_data: dict,
    user_script: Optional[UserAIConsultationScript] = None
) -> str:
    """相談タイプに応じたプロンプトを構築"""
    # システムスクリプトを取得
    if user_script:
        system_instruction = user_script.system_instruction
        template = user_script.prompt_template
    else:
        script = AIConsultationScript.objects.get(
            consultation_type__name=consultation_type,
            is_default=True
        )
        system_instruction = script.system_instruction
        template = script.default_prompt_template
    
    # データをテンプレートに埋め込む
    prompt = template.format(
        user_message=user_message,
        **company_data
    )
    
    return prompt, system_instruction
```

### 2. 相談タイプ別のデータ収集
```python
def get_consultation_data(consultation_type: str, company: Company) -> dict:
    """相談タイプに応じたデータを収集"""
    data = {}
    
    if consultation_type == "財務相談":
        data['fiscal_summary'] = get_fiscal_summary_data(company)
        data['debt_info'] = get_debt_data(company)
    elif consultation_type == "補助金相談":
        data['company_info'] = get_company_info(company)
        data['financial_data'] = get_financial_data(company)
    # ... 他の相談タイプ
    
    return data
```

## デザインイメージ（テキストベース）

### サイドバー
```
┌────────────────────────────┐
│  SCore AI                  │
├────────────────────────────┤
│  📊 ダッシュボード          │
│                            │
│  🤖 AI相談センター [NEW]    │ ← 目立つ
│    ├─ 💰 財務相談          │
│    ├─ 💼 補助金相談        │
│    ├─ 📋 税務相談          │
│    ├─ ⚖️ 法律相談          │
│    └─ ⚙️ 相談設定          │
│                            │
│  📈 財務データ管理          │
│  🏢 会社情報                │
│  👥 顧客管理                │
│  📊 業界比較                │
│  📝 議事録管理              │
│  ⚙️ 設定                    │
└────────────────────────────┘
```

### AI相談センター画面
```
┌────────────────────────────────────────────────────┐
│  🤖 AI相談センター                                   │
├────────────────────────────────────────────────────┤
│                                                     │
│  あなたの会社データを活用して、最適なアドバイスを   │
│  提供します。                                       │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ 💰 財務相談  │  │ 💼 補助金相談 │                │
│  │             │  │             │                │
│  │ 決算書データ │  │ 業種・規模   │                │
│  │ を基に分析  │  │ を基に提案  │                │
│  │             │  │             │                │
│  │ [相談開始]  │  │ [相談開始]  │                │
│  └─────────────┘  └─────────────┘                │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐                │
│  │ 📋 税務相談  │  │ ⚖️ 法律相談  │                │
│  │             │  │             │                │
│  │ 税務情報を  │  │ 契約・法務   │                │
│  │ 基に提案    │  │ を基に提案  │                │
│  │             │  │             │                │
│  │ [相談開始]  │  │ [相談開始]  │                │
│  └─────────────┘  └─────────────┘                │
└────────────────────────────────────────────────────┘
```

## 次のステップ

1. **メニュー再構成の実装**
2. **AIスクリプト管理機能の実装**
3. **相談タイプの追加**
4. **データ連携の強化**

どの部分から実装を始めますか？

